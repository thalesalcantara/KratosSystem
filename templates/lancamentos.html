<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Lançamentos - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Orbitron:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --line:#e4ebff;
      --ink:#0f172a;
      --muted:#5b6b8a;

      /* AZUL ROYAL */
      --royal:#1f4fe0;
      --royal2:#3a66ff;
      --royal3:#163ab0;

      --danger:#ef4444;
      --ok:#10b981;

      --thead:#f2f6ff;
      --shadow: 0 14px 34px rgba(31,79,224,.12);
      --shadow2: 0 18px 46px rgba(15,23,42,.08);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{overflow-x:hidden}

    body{
      margin:0;
      min-height: 100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 420px at 80% -40%, rgba(31,79,224,.14), transparent 70%),
        radial-gradient(900px 380px at 10% 0%, rgba(16,185,129,.08), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    /* ===== PREENCHE A PÁGINA TODA =====
       - Em telas largas, usa quase toda a largura (sem “página sobrando”)
       - Mantém margens leves
    */
    .container-x{
      width: min(1600px, calc(100vw - 28px));
      margin: 0 auto;
      padding: 18px 0 26px;
    }

    /* ===== Topbar ===== */
    .topbar{
      position: sticky;
      top: 12px;
      z-index: 50;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px;
      border-radius: var(--radius);
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal2) 55%, var(--royal3) 100%);
      color:#fff;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.22);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .brand-ico{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      flex: 0 0 auto;
    }
    .brand-title{
      min-width: 0;
      line-height: 1.1;
    }
    .brand-title .t{
      margin:0;
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 800;
      font-size: 15px;
      letter-spacing: .6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand-title .s{
      font-weight: 600;
      font-size: 12px;
      opacity: .92;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .top-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn-top{
      height: 42px;
      padding: 0 12px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.10);
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn-top:hover{ background: rgba(255,255,255,.16); color:#fff; }

    /* ===== Cards ===== */
    .cardx{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      margin-top: 12px;
    }

    /* ===== Métricas ===== */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    .stat{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: linear-gradient(180deg, #fff 0%, #fbfcff 100%);
      box-shadow: 0 10px 22px rgba(15,23,42,.04);
    }
    .stat .k{
      display:flex;
      align-items:center;
      gap: 8px;
      color:#1f2b4a;
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase; /* corrigido */
      letter-spacing: .06em;
    }
    .stat .k i{ color: var(--royal); }
    .stat .v{
      margin-top: 8px;
      font-size: 22px;
      font-weight: 900;
      color: var(--royal3);
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }
    .stat .s{
      margin-top: 4px;
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
    }

    /* ===== Filtros ===== */
    label{
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color:#0f172a;
    }
    .form-control, .form-select{
      height: 46px;
      border-radius: 14px;
      border: 1px solid #cfe0ff;
    }
    .form-control:focus, .form-select:focus{
      border-color: var(--royal);
      box-shadow: 0 0 0 .2rem rgba(31,79,224,.14);
    }

    .btn-main{
      height: 46px;
      border-radius: 14px;
      font-weight: 900;
      border: none;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      box-shadow: 0 12px 22px rgba(31,79,224,.14);
    }
    .btn-main:hover{ filter: brightness(1.03); }

    .btn-ghost{
      height: 46px;
      border-radius: 14px;
      font-weight: 900;
      background:#fff;
      border: 1px solid #cfe0ff;
      color: var(--royal3);
    }
    .btn-ghost:hover{ background:#f1f5ff; }

    .btn-success{
      height: 46px;
      border-radius: 14px;
      font-weight: 900;
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #f3f6ff;
      color:#1b2b5e;
      font-weight: 900;
      font-size: 12px;
      box-shadow: 0 8px 16px rgba(31,79,224,.06);
    }
    .chip i{ color: var(--royal3); }

    .hint{
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
      margin-top: 8px;
    }

    /* ===== TABELA SEM SCROLL LATERAL (e preenchendo o espaço) ===== */
    .table-wrap{
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;      /* SEM scroll horizontal */
      background:#fff;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;   /* força caber */
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--thead);
      border-bottom: 1px solid var(--line);
      padding: 10px 8px;
      font-size: 12px;
      font-family: Orbitron, Inter, sans-serif;
      letter-spacing: .7px;
      color: var(--royal3);
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }

    tbody td{
      border-top: 1px solid var(--line);
      padding: 10px 8px;
      font-size: 13px;
      text-align:center;
      vertical-align: middle;
      background:#fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    tbody tr:nth-child(even) td{ background:#fbfdff; }
    tbody tr:hover td{ background:#f3f7ff; }

    td.col-data{
      white-space: normal;
      line-height: 1.1;
    }
    td.col-data small{
      display:block;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      margin-top: 2px;
    }

    td.col-coop, td.col-estab{
      text-align: left;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.15;
      font-weight: 750;
    }
    td.col-estab{ font-weight: 650; color:#1b2b5e; }

    td.valor{
      font-weight: 900;
      color: var(--royal3);
      font-variant-numeric: tabular-nums;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      font-weight: 900;
      font-size: 13px;
      color:#1b2b5e;
      white-space: nowrap;
      box-shadow: 0 10px 16px rgba(15,23,42,.04);
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      background: var(--royal3);
      box-shadow: 0 0 0 3px rgba(31,79,224,.12);
    }
    .pill.ok .dot{ background: var(--ok); box-shadow: 0 0 0 3px rgba(16,185,129,.14); }
    .pill.danger .dot{ background: var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,.12); }

    .actions{
      display:flex;
      gap: 6px;
      justify-content:center;
      align-items:center;
      flex-wrap: nowrap;
    }
    .btn-ico{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border: 1px solid #cfe0ff;
      background:#fff;
      color: var(--royal3);
      font-weight: 900;
    }
    .btn-ico:hover{ background:#f1f5ff; }
    .btn-ico.primary{
      border:none;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      color:#fff;
      box-shadow: 0 12px 22px rgba(31,79,224,.14);
    }
    .btn-ico.danger{
      border:none;
      background: linear-gradient(90deg, #ef4444, #dc2626);
      color:#fff;
      box-shadow: 0 12px 22px rgba(239,68,68,.12);
    }

    tfoot td{
      background:#f3f6ff;
      border-top: 2px solid var(--line);
      font-weight: 900;
      color:#1b2b5e;
      padding: 12px 10px;
      white-space: nowrap;
    }

    /* Larguras: em telas grandes, mantém proporção e “estica” ocupando tudo */
    th.w-data{ width: 11%; }
    th.w-os{ width: 8%; }
    th.w-coop{ width: 22%; }
    th.w-estab{ width: 20%; }
    th.w-compra{ width: 10%; }
    th.w-parc{ width: 12%; }
    th.w-sit{ width: 11%; }
    th.w-acoes{ width: 6%; }

    /* Modal */
    .modal-content{
      border-radius: 18px;
      border: 1px solid var(--line);
      box-shadow: 0 20px 52px rgba(15,23,42,.16);
      overflow:hidden;
    }
    .modal-header{
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      color:#fff;
      border-bottom: 1px solid rgba(255,255,255,.22);
    }
    .modal-title{
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing: .6px;
    }
    .modal-body{
      background:
        radial-gradient(900px 320px at 85% -10%, rgba(31,79,224,.10), transparent 70%),
        #fff;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    .box{
      background:#fff;
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 12px 22px rgba(15,23,42,.06);
    }
    .box h6{
      font-family: Orbitron, Inter, sans-serif;
      color: var(--royal3);
      letter-spacing: .6px;
      margin: 0 0 10px 0;
      font-weight: 900;
      font-size: 13px;
    }
    .parcelas{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    .parcela{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      text-align:left;
    }
    .parcela .t{
      font-weight: 900;
      color:#1b2b5e;
      display:flex; justify-content:space-between; align-items:center;
      gap: 8px;
    }
    .parcela .v{
      font: 900 18px/1 Orbitron, Inter, sans-serif;
      color: var(--royal3);
      margin-top: 8px;
    }
    .parcela .s{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }
    .parcela.paga{
      background: #f2fff8;
      border-color: rgba(16,185,129,.25);
    }
    .parcela.paga .v{ color: var(--ok); }

    .timeline{
      display:flex; flex-direction:column; gap:10px;
      max-height: 320px;
      overflow:auto;
      padding-right: 6px;
    }
    .event{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
    }
    .event .row1{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .event .amt{
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      color: var(--royal3);
      white-space: nowrap;
    }

    /* Responsivo */
    @media (max-width: 980px){
      .stats{ grid-template-columns: 1fr; }
      .grid2{ grid-template-columns: 1fr; }
      .parcelas{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .topbar{ position: static; }
      .container-x{ width: calc(100vw - 22px); }
    }
  </style>
</head>

<body>
  <div class="container-x">

    <div class="topbar">
      <div class="brand">
        <div class="brand-ico"><i class="bi bi-journal-text fs-4"></i></div>
        <div class="brand-title">
          <div class="t">Lançamentos e Descontos</div>
          <div class="s">Parcelamento automático em 4x com desconto flexível</div>
        </div>
      </div>
      <div class="top-actions">
        <a href="{{ url_for('dashboard') }}" class="btn btn-top">
          <i class="bi bi-arrow-left-circle"></i> Dashboard
        </a>
        <button type="button" class="btn btn-top" id="btn-hoje">
          <i class="bi bi-sun"></i> Hoje
        </button>
      </div>
    </div>

    <!-- Métricas -->
    <div class="cardx">
      <div class="stats">
        <div class="stat">
          <div class="k"><i class="bi bi-list-ul"></i> Lançamentos</div>
          <div class="v" id="m-qtd">—</div>
          <div class="s">Linhas visíveis</div>
        </div>
        <div class="stat">
          <div class="k"><i class="bi bi-cash-coin"></i> Total visível</div>
          <div class="v" id="m-total">—</div>
          <div class="s">Somatório dos valores</div>
        </div>
        <div class="stat">
          <div class="k"><i class="bi bi-graph-up"></i> Ticket médio</div>
          <div class="v" id="m-media">—</div>
          <div class="s">Média por lançamento</div>
        </div>
        <div class="stat">
          <div class="k"><i class="bi bi-credit-card-2-front"></i> Parcelas</div>
          <div class="v" id="m-parc">—</div>
          <div class="s">4x automático</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="cardx">
      <form id="form-filtros" method="get" action="{{ url_for('listar_lancamentos') }}">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="cooperado_id">Cooperado</label>
            <select name="cooperado_id" id="cooperado_id" class="form-select">
              <option value="">Todos</option>
              {% for c in cooperados %}
                <option value="{{ c.id }}" {% if filtros.cooperado_id == c.id|string %}selected{% endif %}>{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label for="estabelecimento_id">Estabelecimento</label>
            <select name="estabelecimento_id" id="estabelecimento_id" class="form-select">
              <option value="">Todos</option>
              {% for e in estabelecimentos %}
                <option value="{{ e.id }}" {% if filtros.estabelecimento_id == e.id|string %}selected{% endif %}>{{ e.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label for="data_inicio">Data Início</label>
            <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ filtros.data_inicio or '' }}">
          </div>

          <div class="col-md-2">
            <label for="data_fim">Data Fim</label>
            <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ filtros.data_fim or '' }}">
          </div>

          <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-main text-white">
              <i class="bi bi-funnel"></i> Filtrar
            </button>
          </div>

          <div class="col-md-2 d-grid">
            <button type="button" class="btn btn-success" onclick="exportarExcel()">
              <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </button>
          </div>

          <div class="col-md-2 d-grid">
            <button type="button" class="btn btn-ghost" id="btn-limpar">
              <i class="bi bi-x-circle"></i> Limpar
            </button>
          </div>
        </div>

        <div class="chips" id="chips-filtros"></div>
        <div class="hint">
          Dica: clique no botão azul (cartão) para registrar descontos com data e editar quando quiser.
        </div>
      </form>
    </div>

    <!-- Tabela -->
    <div class="cardx">
      <div class="table-wrap">
        <table id="t-lanc">
          <thead>
            <tr>
              <th class="w-data"><i class="bi bi-calendar-event"></i> Data</th>
              <th class="w-os"><i class="bi bi-file-earmark-text"></i> Nº OS</th>
              <th class="w-coop"><i class="bi bi-person"></i> Cooperado</th>
              <th class="w-estab"><i class="bi bi-shop"></i> Estabelecimento</th>
              <th class="w-compra"><i class="bi bi-currency-dollar"></i> Compra</th>
              <th class="w-parc"><i class="bi bi-collection"></i> Parcela (4x)</th>
              <th class="w-sit"><i class="bi bi-clipboard-check"></i> Situação</th>
              <th class="w-acoes"><i class="bi bi-sliders2"></i> Ações</th>
            </tr>
          </thead>

          <tbody>
            {% if lancamentos %}
              {% for l in lancamentos %}
                <tr class="l-row"
                    data-id="{{ l.id }}"
                    data-data="{{ l.data.strftime('%Y-%m-%dT%H:%M:%S') }}"
                    data-valor="{{ '%.2f'|format(l.valor) }}"
                    data-os="{{ l.os_numero }}"
                    data-coop="{{ l.cooperado.nome }}"
                    data-estab="{{ l.estabelecimento.nome }}"
                    data-desc="{{ (l.descricao or '')|e }}"
                    data-historico='{{ (l.historico_descontos_json or "[]")|safe }}'>

                  <td class="col-data">
                    <div>{{ l.data.strftime('%d/%m/%Y') }}</div>
                    <small>{{ l.data.strftime('%H:%M') }}</small>
                  </td>

                  <td style="font-weight:900">{{ l.os_numero }}</td>

                  <td class="col-coop">{{ l.cooperado.nome }}</td>

                  <td class="col-estab">{{ l.estabelecimento.nome }}</td>

                  <td class="valor" data-col="compra">
                    {{ "{:,.2f}".format(l.valor).replace(",", "X").replace(".", ",").replace("X", ".") }}
                  </td>

                  <td>
                    <span class="pill"><span class="dot"></span><span class="vparc">—</span></span>
                  </td>

                  <td>
                    <span class="pill danger"><span class="dot"></span><span class="sit">—</span></span>
                  </td>

                  <td>
                    <div class="actions">
                      <button type="button" class="btn-ico primary" title="Descontar / Parcelas" onclick="abrirParcelas({{ l.id }})">
                        <i class="bi bi-credit-card-2-front"></i>
                      </button>

                      <form method="post"
                            action="{{ url_for('excluir_lancamento', id=l.id) }}"
                            onsubmit="return confirm('Excluir este lançamento? Essa ação não pode ser desfeita.');"
                            style="margin:0">
                        <input type="hidden" name="next" value="{{ request.full_path }}">
                        <button type="submit" class="btn-ico danger" title="Excluir">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="8" style="padding:14px;text-align:center;color:var(--muted);font-weight:700">Nenhum lançamento encontrado.</td></tr>
            {% endif %}
          </tbody>

          <tfoot>
            <tr>
              <td colspan="4" class="text-end">Totais (visíveis):</td>
              <td id="tf-total" class="valor">—</td>
              <td colspan="3" id="tf-qtd" class="text-start">— itens</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal Parcelas / Descontos -->
  <div class="modal fade" id="modalParcelas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="mp-title">Parcelas e Descontos</div>
            <div style="opacity:.92;font-weight:800" id="mp-sub">—</div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <div class="grid2">
            <div class="box">
              <h6><i class="bi bi-collection"></i> Parcelamento em 4x (com acúmulo automático)</h6>
              <div class="parcelas" id="mp-parcelas"></div>
              <div class="hint mt-3">
                Regra: se você descontar <strong>menos</strong> que a parcela, o restante <strong>vai para a próxima</strong>.
              </div>
            </div>

            <div class="box">
              <h6><i class="bi bi-calendar2-check"></i> Registrar desconto com data</h6>

              <div class="row g-2 align-items-end">
                <div class="col-md-6">
                  <label>Data do desconto</label>
                  <input type="date" class="form-control" id="mp-date">
                </div>
                <div class="col-md-6">
                  <label>Valor descontado (R$)</label>
                  <input type="text" class="form-control" id="mp-valor" placeholder="Ex.: 20,00">
                </div>
                <div class="col-12 d-grid mt-1">
                  <button type="button" class="btn btn-main text-white" id="mp-add">
                    <i class="bi bi-plus-circle"></i> Registrar desconto
                  </button>
                </div>
              </div>

              <div class="mt-3">
                <div class="d-flex align-items-center justify-content-between">
                  <h6 class="m-0"><i class="bi bi-clock-history"></i> Histórico (editável)</h6>
                </div>
                <div class="hint mt-1">Você pode editar a data e o valor de qualquer desconto.</div>
                <div class="timeline mt-2" id="mp-timeline"></div>
              </div>

              <div class="hint mt-3">
                Observação: os descontos ficam salvos no navegador (localStorage) até você integrar com o banco.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Utilitários
    // =========================
    const brl = v => v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    const to2 = n => (Math.round((n + Number.EPSILON)*100)/100);

    function onlyDigitsAndCommaDot(s){
      return String(s||'').replace(/[^\d,.-]/g,'').trim();
    }

    function parseBRL(input){
      const s = onlyDigitsAndCommaDot(input);
      if(!s) return NaN;
      const norm = s.includes(',') ? s.replace(/\./g,'').replace(',', '.') : s;
      const n = parseFloat(norm);
      return isNaN(n) ? NaN : to2(n);
    }

    function formatBRInput(n){
      if(isNaN(n)) return '';
      return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function localISODate(d=new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // =========================
    // Armazenamento local (provisório)
    // =========================
    function keyDescontos(id){ return `coopex_descontos_${id}`; }

    function getHistorico(row){
      const id = row.dataset.id;
      const ls = localStorage.getItem(keyDescontos(id));
      if (ls){
        try { return JSON.parse(ls) || []; } catch(e){}
      }
      try{
        const raw = row.dataset.historico || '[]';
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function setHistorico(id, hist){
      localStorage.setItem(keyDescontos(id), JSON.stringify(hist || []));
    }

    // =========================
    // Motor de parcelas (4x) com acúmulo
    // =========================
    function calcularParcelas(total, descontos){
      total = to2(total);
      const base = to2(total / 4);

      const ds = (descontos || [])
        .map((d, idx)=>({
          id: d.id ?? `tmp_${idx}`,
          data: String(d.data || '').slice(0,10),
          valor: to2(parseFloat(d.valor) || 0),
          idx
        }))
        .filter(d => d.valor > 0 && d.data);

      ds.sort((a,b)=>{
        if(a.data < b.data) return -1;
        if(a.data > b.data) return 1;
        return a.idx - b.idx;
      });

      let pagoTotal = 0;
      ds.forEach(d => pagoTotal = to2(pagoTotal + d.valor));
      if(pagoTotal > total) pagoTotal = total;

      const parcelas = [];
      let restante = total;
      let carry = 0;
      let pagoDistribuir = pagoTotal;

      for(let i=1;i<=4;i++){
        let sugerida = to2(base + carry);
        if (sugerida < 0) sugerida = 0;
        if (sugerida > restante) sugerida = restante;

        const pagoNesta = to2(Math.min(pagoDistribuir, sugerida));
        pagoDistribuir = to2(pagoDistribuir - pagoNesta);

        const faltou = to2(sugerida - pagoNesta);
        carry = to2(faltou);

        restante = to2(restante - sugerida);

        parcelas.push({
          n: i, base, sugerida, pago: pagoNesta, faltou,
          status: (faltou <= 0.0001) ? 'paga' : 'pendente'
        });
      }

      const saldo = to2(total - pagoTotal);
      return { total, base, pagoTotal, saldo, parcelas, descontosOrdenados: ds };
    }

    // =========================
    // UI: métricas e chips
    // =========================
    function atualizarMetricasTabela(){
      const rows = [...document.querySelectorAll('#t-lanc tbody tr.l-row')]
        .filter(tr => tr.style.display !== 'none');

      let soma = 0, qtd = 0;
      rows.forEach(tr=>{
        const v = parseFloat(tr.dataset.valor || '0') || 0;
        soma = to2(soma + v);
        qtd++;
      });

      const media = qtd ? to2(soma / qtd) : 0;

      document.getElementById('m-qtd').textContent = qtd.toLocaleString('pt-BR');
      document.getElementById('m-total').textContent = brl(soma);
      document.getElementById('m-media').textContent = brl(media);
      document.getElementById('m-parc').textContent = '4x automático';

      document.getElementById('tf-total').textContent = brl(soma);
      document.getElementById('tf-qtd').textContent = `${qtd.toLocaleString('pt-BR')} itens`;
    }

    function atualizarChips(){
      const chips = document.getElementById('chips-filtros');
      chips.innerHTML = '';

      const coopSel  = document.getElementById('cooperado_id');
      const estabSel = document.getElementById('estabelecimento_id');
      const di = document.getElementById('data_inicio').value;
      const df = document.getElementById('data_fim').value;

      const add = (icon, txt) => {
        const b = document.createElement('span');
        b.className = 'chip';
        b.innerHTML = `<i class="bi ${icon}"></i> ${txt}`;
        chips.appendChild(b);
      };

      if (coopSel.value)  add('bi-person', coopSel.options[coopSel.selectedIndex].text);
      if (estabSel.value) add('bi-shop', estabSel.options[estabSel.selectedIndex].text);
      if (di) add('bi-calendar-plus', `Início: ${new Date(di+'T00:00:00').toLocaleDateString('pt-BR')}`);
      if (df) add('bi-calendar-minus', `Fim: ${new Date(df+'T00:00:00').toLocaleDateString('pt-BR')}`);
    }

    // =========================
    // Preenche Parcela sugerida e Situação (usa "Total")
    // =========================
    function atualizarLinhaParcelas(tr){
      const total = parseFloat(tr.dataset.valor || '0') || 0;
      const hist = getHistorico(tr);
      const calc = calcularParcelas(total, hist);

      const primeiraPendente = calc.parcelas.find(p => p.status !== 'paga') || calc.parcelas[3];
      const sug = primeiraPendente ? primeiraPendente.sugerida : calc.parcelas[3].sugerida;

      tr.querySelector('.vparc').textContent = brl(sug);

      const sitEl = tr.querySelector('.sit');
      const pill = sitEl?.closest('.pill');
      const ok = calc.saldo <= 0.0001;

      if (ok){
        sitEl.textContent = 'Quitado';
        pill.classList.remove('danger');
        pill.classList.add('ok');
      }else{
        sitEl.textContent = `Total ${brl(calc.total)}`;
        pill.classList.remove('ok');
        pill.classList.add('danger');
      }
    }

    function atualizarTodasLinhas(){
      document.querySelectorAll('#t-lanc tbody tr.l-row').forEach(tr => atualizarLinhaParcelas(tr));
      atualizarMetricasTabela();
      atualizarChips();
    }

    // =========================
    // Modal: Parcelas / Descontos
    // =========================
    let modal;
    let currentId = null;

    function getRowById(id){
      return document.querySelector(`#t-lanc tbody tr.l-row[data-id="${id}"]`);
    }

    function renderParcelas(calc){
      const wrap = document.getElementById('mp-parcelas');
      wrap.innerHTML = '';
      calc.parcelas.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'parcela ' + (p.status === 'paga' ? 'paga' : '');
        div.innerHTML = `
          <div class="t">
            <span>Parcela ${p.n}</span>
            <span class="pill ${p.status==='paga'?'ok':'danger'}" style="padding:4px 8px;font-size:.82rem">
              <span class="dot"></span>${p.status==='paga'?'Paga':'Pendente'}
            </span>
          </div>
          <div class="v">${brl(p.sugerida)}</div>
          <div class="s">Base: ${brl(p.base)} • Pago: ${brl(p.pago)} • Falta: ${brl(p.faltou)}</div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderTimeline(hist){
      const tl = document.getElementById('mp-timeline');
      tl.innerHTML = '';
      if (!hist.length){
        const empty = document.createElement('div');
        empty.className = 'event';
        empty.innerHTML = `<div class="hint">Nenhum desconto registrado ainda.</div>`;
        tl.appendChild(empty);
        return;
      }

      hist.forEach((d, idx)=>{
        const ev = document.createElement('div');
        ev.className = 'event';
        ev.innerHTML = `
          <div class="row1">
            <span style="font-weight:900;color:#1b2b5e">
              <i class="bi bi-calendar2-check" style="color:var(--royal3)"></i>
              Desconto #${idx+1}
            </span>
            <span class="amt">${brl(parseFloat(d.valor)||0)}</span>
          </div>

          <div class="row g-2 mt-2 align-items-end">
            <div class="col-md-6">
              <label class="mb-1" style="font-size:.78rem">Data</label>
              <input type="date" class="form-control form-control-sm" value="${(d.data||'').slice(0,10)}" data-edit-date="${idx}">
            </div>
            <div class="col-md-6">
              <label class="mb-1" style="font-size:.78rem">Valor</label>
              <input type="text" class="form-control form-control-sm" value="${formatBRInput(parseFloat(d.valor)||0)}" data-edit-valor="${idx}">
            </div>

            <div class="col-12 d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-sm btn-primary" style="border-radius:12px;font-weight:900" data-save="${idx}">
                <i class="bi bi-check2-circle"></i> Salvar
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" style="border-radius:12px;font-weight:900" data-del="${idx}">
                <i class="bi bi-trash3"></i> Remover
              </button>
            </div>
          </div>
        `;
        tl.appendChild(ev);
      });

      tl.querySelectorAll('button[data-save]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.getAttribute('data-save'), 10);
          salvarEdicao(i);
        });
      });
      tl.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.getAttribute('data-del'), 10);
          removerDesconto(i);
        });
      });
    }

    function abrirParcelas(id){
      currentId = String(id);
      const tr = getRowById(currentId);
      if(!tr) return;

      const total = parseFloat(tr.dataset.valor || '0') || 0;
      const hist = getHistorico(tr);

      document.getElementById('mp-title').textContent = `Parcelas e Descontos • OS ${tr.dataset.os}`;
      document.getElementById('mp-sub').textContent = `${tr.dataset.coop} • ${tr.dataset.estab} • Compra ${brl(total)}`;

      document.getElementById('mp-date').value = localISODate(new Date());
      document.getElementById('mp-valor').value = '';

      const calc = calcularParcelas(total, hist);
      renderParcelas(calc);
      renderTimeline(hist);

      modal.show();
    }
    window.abrirParcelas = abrirParcelas;

    function refreshModal(){
      const tr = getRowById(currentId);
      if(!tr) return;
      const total = parseFloat(tr.dataset.valor || '0') || 0;
      const hist = getHistorico(tr);
      const calc = calcularParcelas(total, hist);
      renderParcelas(calc);
      renderTimeline(hist);
      atualizarLinhaParcelas(tr);
      atualizarMetricasTabela();
    }

    function adicionarDesconto(){
      const tr = getRowById(currentId);
      if(!tr) return;

      const date = (document.getElementById('mp-date').value || '').slice(0,10);
      const val = parseBRL(document.getElementById('mp-valor').value);

      if(!date){ alert('Informe a data do desconto.'); return; }
      if(isNaN(val) || val <= 0){ alert('Informe um valor válido para o desconto.'); return; }

      const hist = getHistorico(tr);
      hist.push({ data: date, valor: to2(val) });
      setHistorico(currentId, hist);

      refreshModal();
      document.getElementById('mp-valor').value = '';
    }

    function salvarEdicao(idx){
      const tr = getRowById(currentId);
      if(!tr) return;

      const hist = getHistorico(tr);

      const dateInput = document.querySelector(`[data-edit-date="${idx}"]`);
      const valInput  = document.querySelector(`[data-edit-valor="${idx}"]`);
      if(!dateInput || !valInput) return;

      const date = (dateInput.value || '').slice(0,10);
      const val  = parseBRL(valInput.value);

      if(!date){ alert('Informe a data do desconto.'); return; }
      if(isNaN(val) || val <= 0){ alert('Informe um valor válido.'); return; }

      hist[idx] = { ...hist[idx], data: date, valor: to2(val) };
      setHistorico(currentId, hist);

      refreshModal();
    }

    function removerDesconto(idx){
      const tr = getRowById(currentId);
      if(!tr) return;
      const hist = getHistorico(tr);
      hist.splice(idx, 1);
      setHistorico(currentId, hist);
      refreshModal();
    }

    // =========================
    // Botões gerais
    // =========================
    function exportarExcel(){
      const params = new URLSearchParams({
        cooperado_id: document.getElementById('cooperado_id').value || '',
        estabelecimento_id: document.getElementById('estabelecimento_id').value || '',
        data_inicio: document.getElementById('data_inicio').value || '',
        data_fim: document.getElementById('data_fim').value || ''
      });
      window.location.href = "{{ url_for('exportar_lancamentos') }}?" + params.toString();
    }
    window.exportarExcel = exportarExcel;

    document.getElementById('btn-limpar')?.addEventListener('click', ()=>{
      window.location.href = "{{ url_for('listar_lancamentos') }}";
    });

    document.getElementById('btn-hoje')?.addEventListener('click', ()=>{
      const d = localISODate(new Date());
      document.getElementById('data_inicio').value = d;
      document.getElementById('data_fim').value = d;
      document.getElementById('form-filtros').submit();
    });

    // =========================
    // Init
    // =========================
    document.addEventListener('DOMContentLoaded', ()=>{
      modal = new bootstrap.Modal(document.getElementById('modalParcelas'));
      document.getElementById('mp-add').addEventListener('click', adicionarDesconto);
      atualizarTodasLinhas();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
