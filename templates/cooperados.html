<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Cooperados - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts + Bootstrap + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <style>
    :root{
      --bg:#0c1016;
      --ink:#eaf2ff;
      --muted:#a9b7db;
      --gold:#ffd700;
      --accent:#4b82ff;
      --card1:#1a1f2b;
      --card2:#003399;
      --thead:#151d36;
      --rowOdd:#1a2345;
      --rowEven:#132039;
      --line:#27324c;
      --field:#0f172a;
      --fieldBorder:#3b4565;
      --fieldFocus:#4b82ff;
      --glass:rgba(255,255,255,.06);
    }

    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1200px 400px at 80% -40%, rgba(0,51,153,.25), transparent 70%),
        linear-gradient(180deg, #0c1016, #0c1016);
      color:var(--ink); font-family:Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky; top:0; z-index:60; height:68px;
      display:flex; align-items:center; gap:12px; padding:0 16px;
      background:linear-gradient(90deg, rgba(12,16,22,.9) 40%, rgba(12,16,22,.75) 100%);
      backdrop-filter: blur(8px);
      border-bottom:1px solid #101827;
      box-shadow:0 8px 28px rgba(0,0,0,.45);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand img{ height:36px; width:auto; filter: drop-shadow(0 0 8px #00339966); }
    .brand h1{
      margin:0; font:700 1.08rem/1 Orbitron, sans-serif; letter-spacing:1.2px; color:var(--gold);
      text-shadow:0 1px 1px rgba(0,0,0,.55);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .topbar .spacer{flex:1}
    .topbar .btn-new{
      background:linear-gradient(90deg, var(--gold) 60%, #ffe670 100%);
      color:#191c20; font-weight:800; border:none; border-radius:999px; padding:.6rem 1rem;
      box-shadow:0 6px 18px rgba(255,215,0,.2);
    }
    .topbar .btn-new:hover{ filter:brightness(1.06); }
    .topbar .btn-back{ color:#cfe0ff; border-color:#2b3a61; border-radius:999px; }
    .topbar .btn-back:hover{ background:#1b294d; color:#fff; }

    /* ===== Container ===== */
    .wrap{ max-width:1200px; margin:0 auto; padding:22px 14px 34px; }

    /* ===== Cards de métricas ===== */
    .stats{ display:grid; gap:14px; grid-template-columns: repeat(3, minmax(0,1fr)); margin:14px 0 18px; }
    .stat{
      background:linear-gradient(120deg, var(--card1), var(--card2));
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:14px 16px;
      box-shadow:0 8px 26px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .stat .label{ color:#cfe0ff; font-weight:700; letter-spacing:.4px; display:flex; align-items:center; gap:8px; }
    .stat .value{ font:800 1.6rem/1.2 Orbitron, sans-serif; color:var(--gold); margin-top:6px; text-shadow:0 1px 1px rgba(0,0,0,.6); }
    .stat .sub{ color:var(--muted); font-size:.92rem; margin-top:6px; }

    /* ===== Filtros (sticky) ===== */
    .filters{
      position:sticky; top:78px; z-index:50;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--glass); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:12px; backdrop-filter: blur(8px);
      box-shadow:0 8px 26px rgba(0,0,0,.35);
    }
    .filters .field{ flex:1 1 240px; position:relative; }
    .filters input[type="text"],
    .filters input[type="number"]{
      width:100%; height:46px; border-radius:12px; border:1.5px solid var(--fieldBorder);
      background:var(--field); color:var(--ink); padding:10px 14px; font-size:1rem;
    }
    .filters input::placeholder{ color:var(--muted); }
    .filters input:focus{ outline:none; border-color:var(--fieldFocus); box-shadow:0 0 0 .2rem rgba(75,130,255,.15); }

    .switch{
      display:inline-flex; align-items:center; gap:8px; color:var(--ink);
      padding:10px 12px; border-radius:12px; border:1px solid #2a3552; background:#0f162c;
    }
    .chip{ display:inline-flex; gap:6px; align-items:center; padding:8px 12px; border-radius:999px;
      border:1px solid #3254a8; background:#162a56; color:#cfe0ff; font-weight:600; }
    .chip .count{ background:#26407f; padding:1px 8px; border-radius:999px; color:#fff; font-weight:800; }

    .btn-clear{
      color:#cfe0ff; border-color:#2b3a61; border-radius:12px; height:46px;
    }
    .btn-clear:hover{ background:#1b294d; color:#fff; }

    /* ===== Tabela ===== */
    .card-table{
      margin-top:16px; background:linear-gradient(120deg, rgba(26,31,43,.9), rgba(0,51,153,.8));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px;
      box-shadow:0 8px 26px rgba(0,0,0,.45);
    }
    .table-title{
      display:flex; align-items:center; gap:10px; padding:6px 8px 10px 8px;
      font:700 1.02rem Orbitron, sans-serif; color:var(--gold);
      text-shadow:0 1px 1px rgba(0,0,0,.55);
    }
    .table-responsive{ border-radius:12px; overflow:auto; }
    table{ width:100%; margin:0; color:var(--ink); }
    thead th{
      position:sticky; top:0; z-index:10; background:var(--thead);
      color:var(--gold) !important; font-family:Orbitron, sans-serif;
      letter-spacing:1px; text-align:center; border-bottom:1px solid var(--line);
      padding:14px 10px; white-space:nowrap;
    }
    tbody td{
      border-top:1px solid var(--line); padding:12px 10px; vertical-align:middle; text-shadow:none;
    }
    .table-striped>tbody>tr:nth-of-type(odd)>*{ background-color:var(--rowOdd) !important; }
    .table-striped>tbody>tr:nth-of-type(even)>*{ background-color:var(--rowEven) !important; }
    .table-hover tbody tr:hover>*{ background-color:#2b375e !important; }

    th.sortable{ cursor:pointer; user-select:none; }
    th.sortable .sort{ margin-left:6px; opacity:.75; font-size:.95em; color:#cdd9ff; }
    th.sortable.active .sort{ opacity:1; color:#fff; }

    /* Foto e textos */
    .foto{
      width:52px; height:52px; object-fit:cover; border-radius:50%;
      border:2px solid var(--gold); background:#0c111b; box-shadow:0 0 6px #00339955;
    }
    .gold{ color:var(--gold)!important; font-weight:800; letter-spacing:.2px; }
    .username{ color:#d6e2ff; font-weight:600; }

    /* Ações */
    .btn-outline-primary{ color:#9ec0ff; border-color:#2d6cdf; }
    .btn-outline-primary:hover{ color:#eaf2ff; background:#2d6cdf22; border-color:#4b82ff; }
    .btn-outline-warning{ color:#ffdf7a; border-color:#e4b900; }
    .btn-outline-warning:hover{ color:#191c20; background:#ffd700; border-color:#ffd700; }
    .btn-outline-danger{ color:#ff9aa4; border-color:#e34b5a; }
    .btn-outline-danger:hover{ color:#ffe6e8; background:#e34b5a22; border-color:#ff7180; }

    /* Paginação */
    .pager{
      display:flex; justify-content:center; align-items:center; gap:8px; margin:12px 0 4px;
    }
    .pager .page-link{
      border-radius:10px; background:#122040; border:1px solid #2e4376; color:#dce6ff;
    }
    .pager .page-link.active{ background:#2747d9; color:#fff; border-color:#2747d9; }

    /* Offcanvas (painel lateral) */
    .offcanvas{
      background:linear-gradient(180deg, #0f1220, #0c1018);
      color:var(--ink);
      border-left:1px solid rgba(255,255,255,.08);
    }
    .oc-head{ font-family:Orbitron, sans-serif; color:var(--gold); letter-spacing:1px; }
    .oc-data .lbl{ color:#cfe0ff; font-weight:700; }
    .oc-data .val{ color:#fff; font-weight:600; }

    /* Alertas */
    .alert{
      background:var(--gold); color:#222; font-weight:800; border:none; border-radius:12px;
      text-align:center; box-shadow:0 8px 22px rgba(255,215,0,.15);
    }

    @media (max-width: 992px){
      .stats{ grid-template-columns:1fr; }
      thead th{ font-size:.9rem; }
      tbody td{ font-size:.95rem; }
      .foto{ width:44px; height:44px; }
    }
  </style>
</head>
<body>

  <!-- ===== TOPBAR ===== -->
  <div class="topbar">
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-back">
      <i class="bi bi-arrow-left-circle"></i>
    </a>
    <div class="brand">
      <img src="{{ url_for('static', filename='logo_coopex.png') }}" alt="Coopex" />
      <h1>Cooperados — Coopex</h1>
    </div>
    <div class="spacer"></div>

    <!-- Contadores rápidos -->
    <span class="chip" title="Total de cooperados">
      Total <span class="count" id="count-total">{{ cooperados|length }}</span>
    </span>

    <a href="{{ url_for('novo_cooperado') }}" class="btn btn-new ms-2">
      <i class="bi bi-person-plus"></i> Novo Cooperado
    </a>
  </div>

  <div class="wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center my-2">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- ===== MÉTRICAS ===== -->
    <div class="stats" id="stats-cards">
      <div class="stat">
        <div class="label"><i class="bi bi-people"></i> Cooperados</div>
        <div class="value" id="m-total">{{ cooperados|length }}</div>
        <div class="sub">Cadastrados no sistema</div>
      </div>
      <div class="stat">
        <div class="label"><i class="bi bi-cash-coin"></i> Crédito total</div>
        <div class="value" id="m-sum">—</div>
        <div class="sub">Soma dos créditos</div>
      </div>
      <div class="stat">
        <div class="label"><i class="bi bi-activity"></i> Média por cooperado</div>
        <div class="value" id="m-avg">—</div>
        <div class="sub">Crédito médio</div>
      </div>
    </div>

    <!-- ===== FILTROS ===== -->
    <div class="filters mb-3">
      <div class="field">
        <input id="f-busca" type="text" placeholder="Buscar por nome ou usuário…" />
      </div>
      <div class="field" style="max-width:220px">
        <input id="f-credito" type="number" step="0.01" min="0" placeholder="Crédito máximo (R$)" />
      </div>
      <label class="switch">
        <input id="f-diferente" class="form-check-input" type="checkbox" />
        <span>Somente crédito diferente</span>
      </label>
      <button class="btn btn-outline-light btn-clear ms-auto" id="btn-clear">
        <i class="bi bi-x-circle"></i> Limpar filtros
      </button>
      <span class="chip ms-2" title="Itens visíveis após filtros">
        Visíveis <span class="count" id="count-visiveis">{{ cooperados|length }}</span>
      </span>
    </div>

    <!-- ===== TABELA ===== -->
    <div class="card-table">
      <div class="table-title"><i class="bi bi-people-fill"></i> Lista de cooperados</div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle text-center" id="t-coops">
          <thead>
            <tr>
              <th>Foto</th>
              <th class="sortable" data-key="nome" data-type="text">
                Nome <i class="bi bi-arrow-down-up sort"></i>
              </th>
              <th class="sortable" data-key="username" data-type="text">
                Usuário <i class="bi bi-arrow-down-up sort"></i>
              </th>
              <th class="sortable" data-key="credito" data-type="number">
                Crédito (R$) <i class="bi bi-arrow-down-up sort"></i>
              </th>
              <th style="width:210px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for c in cooperados %}
            <tr data-id="{{ c.id }}">
              <td>
                {% if c.foto_data or c.foto %}
                  <img class="foto" src="{{ url_for('foto_cooperado', id=c.id) }}" alt="Foto de {{ c.nome }}" loading="lazy" />
                {% else %}
                  <span style="font-size:1.6em; color:var(--gold);"><i class="bi bi-person-circle"></i></span>
                {% endif %}
              </td>
              <td class="gold" data-nome="{{ c.nome }}">{{ c.nome }}</td>
              <td class="username" data-username="{{ c.username }}">{{ c.username }}</td>
              <td class="gold" data-credito="{{ '%.2f'|format(c.credito) }}">{{ "{:,.2f}".format(c.credito) }}</td>
              <td>
                <div class="d-flex flex-wrap gap-1 justify-content-center">
                  <button class="btn btn-outline-primary btn-sm" onclick="abrirPainel(this)" title="Ver detalhes">
                    <i class="bi bi-eye"></i>
                  </button>
                  <a href="{{ url_for('editar_cooperado', id=c.id) }}" class="btn btn-outline-primary btn-sm">Editar</a>
                  <a href="{{ url_for('ajustar_credito_individual', id=c.id) }}" class="btn btn-outline-warning btn-sm">Ajustar</a>
                  <a href="{{ url_for('excluir_cooperado', id=c.id) }}" class="btn btn-outline-danger btn-sm"
                     onclick="return confirm('Excluir este cooperado?')">Excluir</a>
                </div>
              </td>
            </tr>
            {% endfor %}
            {% if not cooperados %}
              <tr><td colspan="5" class="text-center">Nenhum cooperado cadastrado.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Paginação -->
      <nav class="pager" aria-label="Paginação">
        <button class="btn page-link" id="pg-prev"><i class="bi bi-chevron-left"></i></button>
        <div id="pg-pages" class="d-flex gap-1"></div>
        <button class="btn page-link" id="pg-next"><i class="bi bi-chevron-right"></i></button>
      </nav>
    </div>
  </div>

  <!-- ===== OFFCANVAS / Painel lateral ===== -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="oc-coop" aria-labelledby="ocLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title oc-head" id="ocLabel"><i class="bi bi-person-vcard"></i> Cooperado</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex align-items-center gap-3 mb-3">
        <img id="oc-foto" src="" alt="Foto" class="foto" style="width:66px;height:66px;">
        <div>
          <div class="h5 m-0 gold" id="oc-nome">—</div>
          <div class="username" id="oc-user">@—</div>
        </div>
      </div>

      <div class="oc-data mb-3">
        <div class="d-flex justify-content-between">
          <span class="lbl"><i class="bi bi-cash-coin"></i> Crédito</span>
          <span class="val" id="oc-credito">—</span>
        </div>
      </div>

      <div class="d-grid gap-2">
        <a id="oc-editar" href="#" class="btn btn-outline-primary"><i class="bi bi-pencil-square"></i> Editar</a>
        <a id="oc-ajustar" href="#" class="btn btn-outline-warning"><i class="bi bi-sliders"></i> Ajustar crédito</a>
        <a id="oc-excluir" href="#" class="btn btn-outline-danger"
           onclick="return confirm('Excluir este cooperado?')"><i class="bi bi-trash"></i> Excluir</a>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers
    const norm = s => (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
    const valNum = v => parseFloat((v||"").toString().replace(/\./g,"").replace(",","."));

    // ===== Métricas (sum/avg a partir da tabela)
    function atualizarMetricas(){
      const cels = document.querySelectorAll('#t-coops tbody td[data-credito]');
      let sum = 0, n = 0;
      cels.forEach(td=>{ const v = parseFloat(td.dataset.credito); if(!isNaN(v)){ sum += v; n++; } });
      const avg = n ? (sum/n) : 0;
      document.getElementById('m-sum').textContent = sum.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
      document.getElementById('m-avg').textContent = avg.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
      document.getElementById('m-total').textContent = document.querySelectorAll('#t-coops tbody tr').length;
    }

    // ===== Filtros
    const fBusca = document.getElementById('f-busca');
    const fCredito = document.getElementById('f-credito');
    const fDif = document.getElementById('f-diferente');
    const btnClear = document.getElementById('btn-clear');
    const elCountVisiveis = document.getElementById('count-visiveis');

    function aplicarFiltros(){
      const q = norm(fBusca.value);
      const cred = parseFloat((fCredito.value||"").replace(",","."));
      const dif = fDif.checked;
      const rows = [...document.querySelectorAll('#t-coops tbody tr')];
      let vis = 0;

      rows.forEach(tr=>{
        const nome = norm(tr.children[1]?.innerText);
        const user = norm(tr.children[2]?.innerText);
        const credito = parseFloat(tr.children[3]?.dataset.credito);
        let show = (!q || nome.includes(q) || user.includes(q));
        if (!isNaN(cred)){
          show = show && (dif ? (credito !== cred) : (credito <= cred));
        }
        tr.style.display = show ? '' : 'none';
        if(show) vis++;
      });

      // Nenhum resultado
      const tbody = document.querySelector('#t-coops tbody');
      let noRow = tbody.querySelector('.no-result');
      if (vis===0){
        if(!noRow){
          noRow = document.createElement('tr');
          noRow.className='no-result';
          noRow.innerHTML = `<td colspan="5" class="text-center">Nenhum cooperado encontrado.</td>`;
          tbody.appendChild(noRow);
        }
      } else if(noRow){ noRow.remove(); }

      // Atualiza contagem e paginação
      elCountVisiveis.textContent = vis;
      paginaAtual = 1; prepararPaginacao(); aplicarPaginacao();
    }

    btnClear.addEventListener('click', ()=>{
      fBusca.value=''; fCredito.value=''; fDif.checked=false; aplicarFiltros();
    });
    ['input','change'].forEach(evt=>{
      fBusca.addEventListener(evt, aplicarFiltros);
      fCredito.addEventListener(evt, aplicarFiltros);
      fDif.addEventListener(evt, aplicarFiltros);
    });

    // ===== Ordenação
    const ths = document.querySelectorAll('th.sortable');
    let sortState = {};
    ths.forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.key, type = th.dataset.type;
        sortState[key] = (sortState[key]==='asc'?'desc':'asc');
        ths.forEach(x=>x.classList.toggle('active', x===th));

        const rows = [...document.querySelectorAll('#t-coops tbody tr')].filter(r=>!r.classList.contains('no-result'));
        rows.sort((a,b)=>{
          const va = getVal(a, key, type);
          const vb = getVal(b, key, type);
          if (type==='number') return (sortState[key]==='asc') ? (va-vb) : (vb-va);
          return (sortState[key]==='asc') ? (va>vb?1:va<vb?-1:0) : (va<vb?1:va>vb?-1:0);
        });
        const tbody = document.querySelector('#t-coops tbody');
        rows.forEach(r=>tbody.appendChild(r));

        paginaAtual = 1; aplicarPaginacao();
      });
    });
    function getVal(row, key, type){
      if (key==='nome')     return norm(row.children[1]?.dataset.nome || row.children[1]?.innerText);
      if (key==='username') return norm(row.children[2]?.dataset.username || row.children[2]?.innerText);
      if (key==='credito')  return parseFloat(row.children[3]?.dataset.credito || '0') || 0;
      return type==='number' ? 0 : '';
    }

    // ===== Paginação
    const pgPrev = document.getElementById('pg-prev');
    const pgNext = document.getElementById('pg-next');
    const pgPages = document.getElementById('pg-pages');
    let paginaAtual = 1;
    const porPagina = 12;

    function prepararPaginacao(){
      const visiveis = [...document.querySelectorAll('#t-coops tbody tr')].filter(r=>r.style.display !== 'none' && !r.classList.contains('no-result'));
      const total = visiveis.length;
      const paginas = Math.max(1, Math.ceil(total/porPagina));
      pgPages.innerHTML = '';
      for(let i=1;i<=paginas;i++){
        const b = document.createElement('button');
        b.className = 'btn page-link' + (i===paginaAtual ? ' active':'');
        b.textContent = i;
        b.addEventListener('click', ()=>{ paginaAtual=i; aplicarPaginacao(); });
        pgPages.appendChild(b);
      }
      pgPrev.onclick = ()=>{ if(paginaAtual>1){ paginaAtual--; aplicarPaginacao(); } };
      pgNext.onclick = ()=>{ if(paginaAtual<paginas){ paginaAtual++; aplicarPaginacao(); } };
    }

    function aplicarPaginacao(){
      const rows = [...document.querySelectorAll('#t-coops tbody tr')].filter(r=>r.style.display !== 'none' && !r.classList.contains('no-result'));
      const total = rows.length;
      const inicio = (paginaAtual-1)*porPagina;
      const fim = inicio + porPagina;
      rows.forEach((r,idx)=>{ r.style.visibility = (idx>=inicio && idx<fim) ? 'visible' : 'hidden'; r.style.position = (idx>=inicio && idx<fim) ? '' : 'absolute'; });
      // atualizar botões
      [...pgPages.children].forEach((btn,i)=>btn.classList.toggle('active', (i+1)===paginaAtual));
    }

    // ===== Offcanvas / Painel lateral
    let oc;
    document.addEventListener('DOMContentLoaded', ()=>{
      const el = document.getElementById('oc-coop');
      oc = new bootstrap.Offcanvas(el);
    });

    function abrirPainel(btn){
      const tr = btn.closest('tr');
      const id = tr.getAttribute('data-id');
      const nome = tr.children[1]?.innerText || '—';
      const user = tr.children[2]?.innerText || '—';
      const credito = tr.children[3]?.innerText || '—';
      const img = tr.querySelector('img.foto')?.getAttribute('src');

      document.getElementById('oc-nome').textContent = nome;
      document.getElementById('oc-user').textContent = '@' + user;
      document.getElementById('oc-credito').textContent = credito;
      const f = document.getElementById('oc-foto');
      if(img){ f.src = img; f.style.visibility='visible'; } else { f.src=''; f.style.visibility='hidden'; }

      // Rotas
      document.getElementById('oc-editar').href  = "{{ url_for('editar_cooperado', id=0) }}".replace('/0','/'+id);
      document.getElementById('oc-ajustar').href = "{{ url_for('ajustar_credito_individual', id=0) }}".replace('/0','/'+id);
      document.getElementById('oc-excluir').href = "{{ url_for('excluir_cooperado', id=0) }}".replace('/0','/'+id);

      oc.show();
    }

    // ===== Init
    document.addEventListener('DOMContentLoaded', ()=>{
      atualizarMetricas();
      aplicarFiltros();
      prepararPaginacao();
      aplicarPaginacao();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
