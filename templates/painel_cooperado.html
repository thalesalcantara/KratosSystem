<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Painel do Cooperado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --royal:#4169E1;            /* Azul-royal */
      --royal-600:#2f52c9;
      --royal-50:#f5f7ff;
      --ink:#0b1220;
      --muted:#6b7280;
      --line:#e8edff;
      --ok:#0fb98b;
      --danger:#ef4444;
      --bg:#ffffff;               /* branco predominante */
      --card: #ffffffcc;          /* vidro */
      --blur: 14px;
      --radius: 18px;
      --shadow: 0 12px 38px rgba(65,105,225,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      background:
        radial-gradient(1200px 600px at 110% -10%, rgba(65,105,225,.10), transparent 60%),
        radial-gradient(1200px 600px at -10% 110%, rgba(65,105,225,.08), transparent 60%),
        #fff;
    }

    /* ===== APP BAR com onda ===== */
    .appbar{
      position:sticky; top:0; z-index:40; overflow:hidden;
      background:linear-gradient(120deg, var(--royal), var(--royal-600));
      color:#fff; padding:16px 16px 50px 16px;
      box-shadow:0 10px 30px rgba(65,105,225,.35);
    }
    .appbar .row{display:flex; align-items:center; gap:12px}
    .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #ffffff88;background:#ffffff22}
    .hello{margin:0;font-weight:900;font-size:18px;line-height:1.1}
    .sub{margin:2px 0 0 0;font-size:12px;opacity:.95}
    .logout{
      margin-left:auto; color:#fff; text-decoration:none; font-weight:800; font-size:13px;
      border:1px solid #ffffff66; padding:7px 12px; border-radius:12px; white-space:nowrap;
      backdrop-filter: blur(6px);
    }
    .wave{
      position:absolute; left:0; right:0; bottom:-1px; height:50px; pointer-events:none;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1440" height="90" viewBox="0 0 1440 90" fill="none"><path d="M0 36C240 70 480 70 720 36C960 2 1200 2 1440 36V90H0V36Z" fill="white"/></svg>') center/cover no-repeat;
    }

    .wrap{max-width:1080px;margin:-36px auto 88px auto;padding:0 14px} /* sobe por cima da onda */

    /* ===== Cards (glassmorphism) ===== */
    .glass{
      background: var(--card);
      border:1px solid #ffffff66;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
    }
    .metric-grid{
      display:grid; gap:12px; grid-template-columns: repeat(12, 1fr);
    }
    .metric-card{
      grid-column: span 12;
      padding:16px; position:relative; overflow:hidden;
    }
    @media(min-width:840px){
      .metric-card.span-4{grid-column: span 4}
      .metric-card.span-12{grid-column: span 12}
    }
    .metric-title{margin:0 0 6px 0; font-size:12px; color:#0b1220; font-weight:800; letter-spacing:.06em; text-transform:uppercase}
    .metric-value{font-size:30px; font-weight:900}
    .ok{color:var(--ok)}
    .hint{color:var(--muted); font-size:12px; margin-top:6px}

    /* badge superior decorativa */
    .spark{
      position:absolute; right:14px; top:14px; width:8px; height:8px; border-radius:50%;
      background: conic-gradient(from 0deg, #fff 0 40%, transparent 40% 100%);
      box-shadow:0 0 0 8px rgba(255,255,255,.55), 0 0 0 12px rgba(65,105,225,.15);
      opacity:.7;
    }

    /* ===== Se√ß√£o gen√©rica ===== */
    .section{
      padding:12px; margin-top:10px;
    }
    .section-head{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;
    }
    .section-title{
      margin:0; font-size:13px; font-weight:900; letter-spacing:.08em; color:#0b1220; text-transform:uppercase;
    }
    .badge{
      background:#eef2ff; color:var(--royal); font-weight:900; padding:4px 10px; border-radius:999px; font-size:12px
    }
    .empty{padding:18px; color:var(--muted); text-align:center; font-size:13px}

    /* ===== STORIES estilo Instagram ===== */
    .stories-card{
      padding:14px;
    }
    .stories-row{
      display:flex;
      flex-wrap:nowrap;
      overflow-x:auto;
      gap:10px;
      padding:4px 2px 4px 2px;
      scrollbar-width:thin;
    }
    .stories-row::-webkit-scrollbar{height:5px}
    .stories-row::-webkit-scrollbar-thumb{background:rgba(15,23,42,.25);border-radius:999px}

    .story-chip{
      border:0;
      background:transparent;
      color:inherit;
      padding:0;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width:68px;
    }
    .story-ring{
      width:60px;
      height:60px;
      border-radius:50%;
      padding:2px;
      background:conic-gradient(from 180deg,#f97316,#ec4899,#6366f1,#22c55e,#f97316);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .story-inner{
      width:100%;
      height:100%;
      border-radius:50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:22px;
      color:#1f2933;
    }
    .story-name{
      font-size:11px;
      font-weight:800;
      color:#111827;
      max-width:72px;
      text-overflow:ellipsis;
      overflow:hidden;
      white-space:nowrap;
      text-align:center;
    }
    .story-pill{
      font-size:10px;
      font-weight:800;
      color:#64748b;
    }

    /* ===== MODAL DE STORY ‚Äì TELA CHEIA ===== */
    .story-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.92);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .story-modal.open{display:flex;}
    .story-frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:100%;
      max-height:100%;
      background:#000;
      display:flex;
      flex-direction:column;
    }

    .story-progress-bar{
      position:absolute;
      left:0;right:0;top:0;
      display:flex;
      gap:4px;
      padding:6px 8px 0 8px;
      z-index:3;
    }
    .story-progress-seg{
      flex:1;
      height:3px;
      border-radius:999px;
      background:rgba(255,255,255,.25);
      overflow:hidden;
    }
    .story-progress-fill{
      width:0%;
      height:100%;
      background:#ffffff;
      transform-origin:left center;
    }

    .story-header{
      position:relative;
      z-index:2;
      padding:16px 12px 8px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      color:#e5e7eb;
      font-size:13px;
    }
    .story-dot{
      width:28px;height:28px;border-radius:999px;
      background:linear-gradient(120deg,var(--royal),var(--royal-600));
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:900;color:#fff;
    }
    .story-header h5{
      margin:0;font-size:13px;font-weight:800;
    }
    .story-header span{font-size:11px;color:#9ca3af}
    .story-close{
      margin-left:auto;
      border:0;
      background:transparent;
      color:#e5e7eb;
      font-size:22px;
      cursor:pointer;
      padding:2px 6px;
    }

    .story-body{
      position:relative;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .story-body img,
    .story-body video{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background:#000;
    }

    /* zonas de toque para avan√ßar/voltar */
    .story-touch-layer{
      position:absolute;
      inset:0;
      display:flex;
      z-index:4;
    }
    .story-touch-zone{
      flex:1;
    }

    .story-caption{
      padding:10px 12px 18px 12px;
      font-size:12px;
      color:#e5e7eb;
      border-top:1px solid #1f2937;
      min-height:32px;
      white-space:pre-line;
      background:rgba(0,0,0,.75);
    }

    /* ===== Timeline de Lan√ßamentos ===== */
    .timeline{position:relative; padding-left:14px; display:flex; flex-direction:column; gap:10px}
    .timeline:before{
      content:""; position:absolute; left:6px; top:0; bottom:0; width:2px; background:linear-gradient(var(--royal-50), var(--royal));
      border-radius:2px;
    }
    .tx{
      position:relative; padding:12px 12px 12px 14px; border:1px solid var(--line); border-radius:16px; background:#fff;
      display:grid; grid-template-columns: 1fr auto; gap:4px 10px; align-items:center;
      box-shadow:0 10px 24px rgba(17,24,39,.05);
    }
    .tx:before{
      content:""; position:absolute; left:-2px; top:16px; width:10px; height:10px; border-radius:50%;
      background:var(--royal); box-shadow:0 0 0 3px #eef2ff;
    }
    .tx-estab{
      font-weight:900; color:#0b1220; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tx-valor{
      font-weight:900; color:#0b1220; font-size:16px; padding:6px 10px; border-radius:10px;
      background:var(--royal-50); border:1px solid var(--line);
    }
    .tx-os{font-size:12px; color:#64748b; font-weight:800}
    .tx-quando{font-size:12px; color:#334155; font-weight:800; text-align:right}
    .tx-desc{grid-column:1 / -1; font-size:12px; color:#475569}

    /* ===== FAB (Filtros) ===== */
    .fab{
      position:fixed; right:16px; bottom:84px; z-index:35;
      background:linear-gradient(120deg, var(--royal), var(--royal-600));
      color:#fff; border:0; width:56px; height:56px; border-radius:50%;
      box-shadow:0 18px 40px rgba(65,105,225,.35); cursor:pointer; font-weight:900; font-size:20px;
    }

    /* ===== Bottom Sheet de Filtros ===== */
    .sheet{
      position:fixed; left:0; right:0; bottom:-100%; z-index:45; transition:bottom .25s ease;
      background:#fff; border-top-left-radius:20px; border-top-right-radius:20px;
      box-shadow:0 -18px 40px rgba(17,24,39,.25); border-top:1px solid var(--line);
    }
    .sheet.open{ bottom:0; }
    .sheet .drag{ width:46px; height:5px; background:#e5e7eb; border-radius:999px; margin:10px auto; }
    .sheet h4{ margin:4px 16px 8px 16px; font-size:14px; font-weight:900; letter-spacing:.06em; color:#0b1220; text-transform:uppercase }
    .sheet form{ padding:0 16px 16px 16px; display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .field{ display:flex; flex-direction:column; gap:6px }
    label{ font-size:12px; color:#334155; font-weight:800 }
    input[type="date"]{
      padding:12px 12px; height:44px; border:1px solid var(--line); border-radius:12px; background:#fff; min-width:0;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
    }
    .actions{ grid-column:1 / -1; display:flex; gap:10px }
    .btn{
      height:44px; border-radius:12px; border:1px solid var(--line); font-weight:900; cursor:pointer; flex:1;
    }
    .btn.primary{
      color:#fff; background:linear-gradient(120deg, var(--royal), var(--royal-600)); border:0;
      box-shadow:0 10px 24px rgba(65,105,225,.25);
    }
    .btn.ghost{
      color:var(--royal-600); background:#fff;
    }

    /* ===== Bottom Nav (app-like) ===== */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0; z-index:42;
      background:#fff; border-top:1px solid var(--line); display:flex; justify-content:space-around; padding:8px 10px;
    }
    .tab{ color:#6b7280; text-decoration:none; font-weight:800; font-size:12px; display:flex; gap:6px; align-items:center; padding:8px 10px; border-radius:12px }
    .tab span.icon{font-size:16px;}
    .tab.active{ color:var(--royal-600); background:#eef2ff; }

    /* ===== P√°ginas (In√≠cio / Cat√°logos) ===== */
    .page{display:block;}
    .page-hidden{display:none;}

    /* ===== Cat√°logos por estabelecimento ===== */
    .catalog-grid{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .catalog-card{
      padding:14px;
    }
    .catalog-head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:6px;
      border-bottom:1px solid var(--line);
      padding-bottom:6px;
      margin-bottom:6px;
    }
    .catalog-estab{
      font-weight:900;
      font-size:14px;
      color:#0b1220;
    }
    .catalog-pill{
      font-size:11px;
      font-weight:800;
      color:#4b5563;
      background:#f3f4ff;
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .catalog-items{
      display:grid;
      grid-template-columns:1fr;
      gap:6px;
    }
    @media(min-width:720px){
      .catalog-items{grid-template-columns:1fr 1fr;}
    }
    .catalog-item{
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:2px 8px;
      font-size:12px;
    }
    .catalog-name{
      font-weight:800;
      color:#0f172a;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    .catalog-price{
      font-weight:900;
      color:var(--royal-600);
      font-size:13px;
      text-align:right;
    }
    .catalog-meta{
      font-size:11px;
      color:#6b7280;
    }
    .catalog-note{
      grid-column:1 / -1;
      font-size:11px;
      color:#4b5563;
    }
    .catalog-empty-global{
      padding:18px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }

    /* ===== Desktop tweaks ===== */
    @media(min-width:900px){
      .appbar{border-bottom-left-radius:16px;border-bottom-right-radius:16px}
      .wrap{margin-top:-44px}
      .timeline{gap:12px}
    }
  </style>
</head>
<body>

  <!-- APP BAR -->
  <header class="appbar">
    <div class="row">
      <img class="avatar" src="{{ url_for('foto_cooperado', id=coop.id) }}" alt="foto do cooperado" onerror="this.style.visibility='hidden'">
      <div>
        <h1 class="hello">Ol√°, {{ coop.nome }}</h1>
        <div class="sub">Usu√°rio: <b>@{{ coop.username }}</b></div>
      </div>
      <a class="logout" href="{{ url_for('logout') }}">Sair</a>
    </div>
    <div class="wave" aria-hidden="true"></div>
  </header>

  <main class="wrap">
    <!-- ===== P√ÅGINA IN√çCIO ===== -->
    <section id="home-section" class="page">
      <!-- M√âTRICAS -->
      <section class="metric-grid">
        <article class="glass metric-card span-4">
          <span class="spark" aria-hidden="true"></span>
          <h3 class="metric-title">Cr√©dito dispon√≠vel</h3>
          <div class="metric-value ok">R$ {{ '%.2f'|format(coop.credito or 0) }}</div>
          {% if coop.credito_atualizado_em %}
            <div class="hint">√öltimo ajuste: {{ coop.credito_atualizado_em.strftime('%d/%m/%Y %H:%M') }}</div>
          {% else %}
            <div class="hint">Sem ajustes manuais registrados</div>
          {% endif %}
        </article>

        <article class="glass metric-card span-4">
          <h3 class="metric-title">Total de lan√ßamentos (per√≠odo)</h3>
          <div class="metric-value">{{ total_lanc }}</div>
          <div class="hint">Itens listados abaixo</div>
        </article>

        <article class="glass metric-card span-4">
          <h3 class="metric-title">Gasto no per√≠odo</h3>
          <div class="metric-value">R$ {{ '%.2f'|format(total_gasto or 0) }}</div>
          <div class="hint">Soma dos lan√ßamentos filtrados</div>
        </article>

        <!-- STORIES -->
        <article class="glass metric-card span-12 section stories-card" id="stories">
          <div class="section-head">
            <h3 class="section-title">Stories dos estabelecimentos</h3>
            <span class="badge">Promo√ß√µes & avisos</span>
          </div>

          {% if stories_ativos_coop and estab_por_id %}
            <div class="stories-row" aria-label="Stories de estabelecimentos">
              {% for est_id, est in estab_por_id.items() %}
                {% set est_stories = stories_ativos_coop | selectattr('estabelecimento_id','equalto', est_id) | list %}
                {% if est_stories %}
                  <button
                    type="button"
                    class="story-chip"
                    data-est-id="{{ est_id }}"
                    data-est-nome="{{ est.nome }}"
                  >
                    <div class="story-ring">
                      <div class="story-inner">
                        {{ est.nome[:2].upper() }}
                      </div>
                    </div>
                    <div class="story-name" title="{{ est.nome }}">{{ est.nome }}</div>
                    <div class="story-pill">
                      {{ est_stories|length }} story{{ 'ies' if est_stories|length>1 else '' }}
                    </div>
                  </button>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="empty">Ainda n√£o h√° stories ativos dos estabelecimentos que voc√™ utiliza.</div>
          {% endif %}
        </article>

        <!-- LAN√áAMENTOS -->
        <article id="lancamentos" class="glass metric-card span-12 section">
          <div class="section-head">
            <h3 class="section-title">Meus lan√ßamentos</h3>
            <span class="badge">Hor√°rio de Bras√≠lia</span>
          </div>

          <!-- TIMELINE (mobile-first) -->
          <div class="timeline" aria-label="Lan√ßamentos">
            {% if lancamentos %}
              {% for l in lancamentos %}
              <div class="tx">
                <div class="tx-estab">{{ l.estabelecimento.nome if l.estabelecimento else '‚Äî' }}</div>
                <div class="tx-valor">R$ {{ '%.2f'|format(l.valor or 0) }}</div>
                <div class="tx-os">OS: {{ l.os_numero or '‚Äî' }}</div>
                <div class="tx-quando">
                  {% if l.data_brasilia %}
                    {{ l.data_brasilia }}
                  {% else %}
                    {{ l.data.strftime('%d/%m/%Y %H:%M') }}
                  {% endif %}
                </div>
                {% if l.descricao %}<div class="tx-desc">{{ l.descricao }}</div>{% endif %}
              </div>
              {% endfor %}
            {% else %}
              <div class="empty">Nenhum lan√ßamento neste per√≠odo.</div>
            {% endif %}
          </div>

          <div class="hint" style="margin-top:8px">* Hor√°rios exibidos em Bras√≠lia (GMT-3).</div>
        </article>
      </section>
    </section>

    <!-- ===== P√ÅGINA CAT√ÅLOGOS ===== -->
    <section id="catalogos-section" class="page page-hidden">
      <section class="glass metric-card span-12 section">
        <div class="section-head">
          <h3 class="section-title">Cat√°logos dos estabelecimentos</h3>
          <span class="badge">Vis√£o por parceiro</span>
        </div>

        {% if catalogo_itens_coop and estab_por_id %}
          <div class="catalog-grid">
            {% for est_id, est in estab_por_id.items() %}
              {% set itens_est = catalogo_itens_coop | selectattr('estabelecimento_id','equalto', est_id) | list %}
              {% if itens_est %}
                <article class="glass catalog-card">
                  <div class="catalog-head">
                    <div class="catalog-estab">{{ est.nome }}</div>
                    <div class="catalog-pill">{{ itens_est|length }} item{{ 's' if itens_est|length>1 else '' }}</div>
                  </div>
                  <div class="catalog-items">
                    {% for item in itens_est %}
                      <div class="catalog-item">
                        <div class="catalog-name" title="{{ item.nome }}">{{ item.nome }}</div>
                        <div class="catalog-price">R$ {{ '%.2f'|format(item.valor or 0) }}</div>
                        <div class="catalog-meta">
                          {% if item.marca %}Marca: {{ item.marca }}{% endif %}
                          {% if item.categoria %}{{ ' ‚Ä¢ ' if item.marca }}Categoria: {{ item.categoria }}{% endif %}
                          {% if not item.marca and not item.categoria %}&nbsp;{% endif %}
                        </div>
                        {% if item.observacao %}
                          <div class="catalog-note">{{ item.observacao }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </article>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="catalog-empty-global">
            Nenhum cat√°logo dispon√≠vel ainda para os estabelecimentos que lan√ßam em seu nome.
          </div>
        {% endif %}
      </section>
    </section>
  </main>

  <!-- FAB filtros -->
  <button class="fab" id="openFilters" title="Filtrar lan√ßamentos">‚ü≤</button>

  <!-- BOTTOM SHEET de filtros -->
  <div class="sheet" id="sheet">
    <div class="drag" id="closeFilters" aria-hidden="true"></div>
    <h4>Filtros dos lan√ßamentos</h4>
    <form method="get" action="{{ url_for('painel_cooperado') }}">
      <div class="field">
        <label for="di">Data in√≠cio</label>
        <input id="di" type="date" name="data_inicio" value="{{ data_inicio }}">
      </div>
      <div class="field">
        <label for="df">Data fim</label>
        <input id="df" type="date" name="data_fim" value="{{ data_fim }}">
      </div>
      <div class="actions">
        <button type="submit" class="btn primary">Aplicar</button>
        {% if data_inicio or data_fim %}
        <a class="btn ghost" href="{{ url_for('painel_cooperado') }}">Limpar</a>
        {% else %}
        <button type="button" class="btn ghost" id="cancelSheet">Fechar</button>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- MODAL DE STORY TELA CHEIA -->
  <div class="story-modal" id="storyModal">
    <div class="story-frame">
      <div class="story-progress-bar" id="storyProgress"></div>
      <div class="story-header">
        <div class="story-dot" id="storyInitial">E</div>
        <div>
          <h5 id="storyTitle">Estabelecimento</h5>
          <span id="storySub">Story</span>
        </div>
        <button class="story-close" id="closeStory" aria-label="Fechar story">√ó</button>
      </div>
      <div class="story-body">
        <img id="storyImg" src="" alt="story" style="display:none;">
        <video id="storyVideo" playsinline muted style="display:none;"></video>
        <div class="story-touch-layer">
          <div class="story-touch-zone" data-dir="prev"></div>
          <div class="story-touch-zone" data-dir="next"></div>
        </div>
      </div>
      <div class="story-caption" id="storyCaption"></div>
    </div>
  </div>

  <!-- Bottom navigation (est√©tico) -->
  <nav class="bottom-nav" aria-label="Navega√ß√£o">
    <button class="tab active" type="button" data-target="home-section">
      <span class="icon">üè†</span><span>In√≠cio</span>
    </button>
    <button class="tab" type="button" data-target="catalogos-section">
      <span class="icon">üìö</span><span>Cat√°logos</span>
    </button>
    <a class="tab" href="{{ url_for('logout') }}">
      <span class="icon">üö™</span><span>Sair</span>
    </a>
  </nav>

  <!-- ===== MAPA DE STORIES (ids / src / textos) PARA O JS ===== -->
  <script>
    window.COOP_STORIES = [
      {% for s in stories_ativos_coop %}
        {
          id: {{ s.id }},
          estId: {{ s.estabelecimento_id }},
          tipo: "{{ s.tipo }}",
          titulo: {{ (s.titulo or '')|tojson }},
          legenda: {{ (s.legenda or '')|tojson }},
          src: "{{ url_for('story_midia', story_id=s.id) }}"
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
  </script>

  <script>
    // ===== Bottom-sheet filtros =====
    const sheet = document.getElementById('sheet');
    const openFilters = document.getElementById('openFilters');
    const closeFilters = document.getElementById('closeFilters');
    const cancelBtn = document.getElementById('cancelSheet');

    if(openFilters){
      openFilters.addEventListener('click', ()=> sheet.classList.add('open'));
    }
    if(closeFilters){
      closeFilters.addEventListener('click', ()=> sheet.classList.remove('open'));
    }
    if(cancelBtn){
      cancelBtn.addEventListener('click', ()=> sheet.classList.remove('open'));
    }
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') sheet.classList.remove('open'); });

    // ===== Navega√ß√£o entre In√≠cio e Cat√°logos =====
    const tabs = document.querySelectorAll('.bottom-nav .tab[data-target]');
    const pages = {
      home: document.getElementById('home-section'),
      catalogos: document.getElementById('catalogos-section')
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.getAttribute('data-target');
        if(!target) return;
        // ativa aba
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // mostra p√°gina
        if(pages.home) pages.home.classList.add('page-hidden');
        if(pages.catalogos) pages.catalogos.classList.add('page-hidden');
        if(target === 'home-section' && pages.home) pages.home.classList.remove('page-hidden');
        if(target === 'catalogos-section' && pages.catalogos) pages.catalogos.classList.remove('page-hidden');
      });
    });

    // ===== PLAYER DE STORIES (tipo Instagram) =====
    const storyModal   = document.getElementById('storyModal');
    const storyImg     = document.getElementById('storyImg');
    const storyVideo   = document.getElementById('storyVideo');
    const storyTitle   = document.getElementById('storyTitle');
    const storySub     = document.getElementById('storySub');
    const storyCaption = document.getElementById('storyCaption');
    const storyInitial = document.getElementById('storyInitial');
    const closeStory   = document.getElementById('closeStory');
    const progressWrap = document.getElementById('storyProgress');

    const STORY_DURATION = 5000; // 5 segundos
    let currentEstId = null;
    let currentEstName = '';
    let storyList = [];
    let currentIndex = 0;
    let timer = null;
    let isPaused = false;
    let progressFills = [];

    function buildProgressBar(count){
      progressWrap.innerHTML = '';
      progressFills = [];
      for(let i=0;i<count;i++){
        const seg = document.createElement('div');
        seg.className = 'story-progress-seg';
        const fill = document.createElement('div');
        fill.className = 'story-progress-fill';
        seg.appendChild(fill);
        progressWrap.appendChild(seg);
        progressFills.push(fill);
      }
    }

    function updateProgressBar(elapsedRatio=0){
      progressFills.forEach((fill, idx)=>{
        if(idx < currentIndex){
          fill.style.width = '100%';
        } else if(idx === currentIndex){
          fill.style.width = (elapsedRatio*100)+'%';
        } else {
          fill.style.width = '0%';
        }
      });
    }

    function showStory(story){
      if(!storyModal) return;
      storyTitle.textContent = currentEstName;
      storySub.textContent = story.titulo || 'Story';
      storyCaption.textContent = story.legenda || '';
      storyInitial.textContent = (currentEstName || 'E').slice(0,2).toUpperCase();

      storyImg.style.display = 'none';
      storyVideo.style.display = 'none';
      storyVideo.pause();
      storyVideo.removeAttribute('src');

      if(story.tipo === 'video'){
        storyVideo.style.display = 'block';
        storyVideo.src = story.src;
        storyVideo.load();
        storyVideo.play().catch(()=>{});
      }else{
        storyImg.style.display = 'block';
        storyImg.src = story.src;
      }

      updateProgressBar(0);
    }

    function startTimer(){
      clearInterval(timer);
      let elapsed = 0;
      const step = 50;
      timer = setInterval(()=>{
        if(isPaused) return;
        elapsed += step;
        const ratio = Math.min(1, elapsed / STORY_DURATION);
        updateProgressBar(ratio);
        if(elapsed >= STORY_DURATION){
          nextStory();
        }
      }, step);
    }

    function openStoryForEst(estId, estName){
      const all = window.COOP_STORIES || [];
      const list = all.filter(s => s.estId === estId);
      if(!list.length) return;

      currentEstId = estId;
      currentEstName = estName || '';
      storyList = list;
      currentIndex = 0;

      buildProgressBar(storyList.length);
      showStory(storyList[currentIndex]);
      startTimer();

      storyModal.classList.add('open');
    }

    function nextStory(){
      if(currentIndex < storyList.length - 1){
        currentIndex++;
        showStory(storyList[currentIndex]);
        startTimer();
      }else{
        closeStoryModal();
      }
    }

    function prevStory(){
      if(currentIndex > 0){
        currentIndex--;
        showStory(storyList[currentIndex]);
        startTimer();
      }else{
        // volta para o primeiro
        currentIndex = 0;
        showStory(storyList[currentIndex]);
        startTimer();
      }
    }

    function closeStoryModal(){
      if(!storyModal) return;
      storyModal.classList.remove('open');
      clearInterval(timer);
      timer = null;
      if(storyVideo){
        storyVideo.pause();
      }
    }

    // abrir story ao clicar no chip
    document.querySelectorAll('.story-chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        const estId = Number(chip.getAttribute('data-est-id'));
        const estName = chip.getAttribute('data-est-nome') || '';
        openStoryForEst(estId, estName);
      });
    });

    // fechar
    if(closeStory){
      closeStory.addEventListener('click', closeStoryModal);
    }
    if(storyModal){
      storyModal.addEventListener('click',(e)=>{
        if(e.target === storyModal){
          closeStoryModal();
        }
      });
    }
    document.addEventListener('keydown',(e)=>{
      if(e.key === 'Escape'){
        closeStoryModal();
      }
    });

    // zonas de toque (direita/esquerda) + segurar para pausar
    document.querySelectorAll('.story-touch-zone').forEach(zone=>{
      let holdTimeout = null;
      let held = false;

      function startHold(e){
        held = false;
        isPaused = false;
        holdTimeout = setTimeout(()=>{
          held = true;
          isPaused = true;
        }, 200); // depois de 200ms segurando, pausa
      }
      function endHold(e){
        clearTimeout(holdTimeout);
        if(held){
          // estava pausado, soltar = volta a rodar
          isPaused = false;
          return;
        }
        const dir = zone.getAttribute('data-dir');
        if(dir === 'next') nextStory();
        else prevStory();
      }

      zone.addEventListener('mousedown', startHold);
      zone.addEventListener('touchstart', startHold, {passive:true});

      zone.addEventListener('mouseup', endHold);
      zone.addEventListener('mouseleave', endHold);
      zone.addEventListener('touchend', endHold);
      zone.addEventListener('touchcancel', endHold);
    });
  </script>
</body>
</html>
