<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Roboto:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      /* Tema: Azul Royal (#4169e1) + Branco */
      --bg:#f7f9ff;
      --panel:#ffffff;
      --panel2:#ffffff;
      --line:#e5ebff;
      --ink:#0d1b3f;
      --muted:#5c6c92;
      --gold:#4169e1;     /* reaproveitado como cor destaque (royal) */
      --accent:#4169e1;

      --ok:#43d38b;
      --warn:#ffb84d;
      --danger:#ff6b7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;
      background:
        radial-gradient(1200px 500px at 85% -20%, rgba(65,105,225,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--ink);font-family:Roboto,Arial,sans-serif;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:230px;height:100vh;position:fixed;left:0;top:0;z-index:10;
      background:#ffffff;
      border-right:1px solid var(--line);
      box-shadow: 3px 0 18px rgba(65,105,225,.12);
      display:flex;flex-direction:column;align-items:center;padding:20px 10px;
      color:var(--ink);
    }
    .logo{width:168px;filter:drop-shadow(0 0 14px rgba(65,105,225,.35));margin:8px auto 6px}
    .sidebar-funcao{font-family:Orbitron,sans-serif;color:var(--gold);font-weight:700;margin:8px 0 18px}
    .nav-link{
      width:100%;color:var(--ink);border-radius:10px;padding:10px 14px;margin:3px 0;
      display:flex;align-items:center;gap:10px;text-decoration:none;
      transition:background .18s ease,color .18s ease;
    }
    .nav-link:hover,.nav-link.active{background:#eef3ff;color:var(--gold)}
    .nav-link i{font-size:1.2rem;color:var(--gold)}

    /* ===== Main ===== */
    .main{margin-left:230px;padding:22px 18px}
    .topbar{
      background:linear-gradient(90deg, #4169e1 0%, #5a7df0 100%);
      border:1px solid rgba(255,255,255,.28);
      border-radius:14px;padding:10px 14px;margin-bottom:16px;
      display:flex;align-items:center;gap:10px;justify-content:flex-end;
      box-shadow:0 12px 28px rgba(65,105,225,.22);
      color:#fff;
    }
    .topbar .who{margin-right:auto;color:#fff;font-weight:800}
    .topbar .btn-outline-warning{border-color:#fff;color:#fff}
    .topbar .btn-outline-warning:hover{background:#fff;color:#4169e1}

    h2{font-family:Orbitron,sans-serif;color:var(--gold);letter-spacing:1.4px;margin:8px 0 14px}

    /* ===== Cards/KPIs ===== */
    .kpis{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
    .kpi{
      background:linear-gradient(160deg, var(--panel), var(--panel2));
      border:1px solid var(--line);border-radius:14px;padding:12px 14px;
      box-shadow: 0 8px 22px rgba(65,105,225,.08);
    }
    .kpi .label{color:#1b2b5e;display:flex;align-items:center;gap:8px;font-weight:800}
    .kpi .value{font:900 1.35rem Orbitron,sans-serif;color:var(--gold);margin-top:6px}
    .kpi .sub{color:var(--muted);font-size:.9rem;margin-top:2px}

    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:#f1f5ff;color:#1b2b5e;font-weight:800;font-size:.85rem
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 2px}

    /* ===== Cards de navegação ===== */
    .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:16px 0}
    .card-quick{
      text-decoration:none;background:#ffffff;
      border:1px solid var(--line);border-radius:16px;padding:16px;text-align:center;
      color:var(--ink);transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow:0 8px 20px rgba(65,105,225,.10);
    }
    .card-quick:hover{transform:translateY(-3px);filter:brightness(1.02);box-shadow:0 12px 26px rgba(65,105,225,.16)}
    .card-quick i{font-size:2rem;color:var(--gold);display:block;margin-bottom:6px}
    .card-quick .big{font:900 1.2rem Orbitron,sans-serif;color:var(--gold)}

    /* ===== Painéis ===== */
    .panel{
      background:linear-gradient(160deg, var(--panel), var(--panel2));
      border:1px solid var(--line);border-radius:16px;padding:14px;
      margin-top:12px; box-shadow:0 8px 20px rgba(65,105,225,.08);
      color:var(--ink);
    }
    .panel h3{font:700 1.05rem Orbitron,sans-serif;color:var(--gold);margin:4px 0 10px}
    .panel small{color:var(--muted)}

    /* ===== Top cooperados list ===== */
    .toplist{display:grid;grid-template-columns:1fr;gap:8px}
    .topitem{display:flex;align-items:center;gap:10px;background:#ffffff;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .topitem .rank{width:28px;height:28px;border-radius:8px;background:#eef3ff;display:flex;align-items:center;justify-content:center;font-weight:800;color:#1b2b5e}
    .bar{height:8px;background:#eef3ff;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4169e1,#7da0ff);}

    /* ===== Chart area ===== */
    #graficoCooperados{max-height:360px}

    /* ===== Notify ===== */
    #notif-container{position:fixed;top:16px;right:16px;z-index:9999}
    .notif{
      background:#4169e1;color:#fff;font-weight:900;border-radius:12px;padding:10px 14px;margin-top:8px;
      box-shadow:0 10px 24px rgba(65,105,225,.28),0 2px 6px rgba(65,105,225,.25);
      opacity:0;transform:translateY(-10px);transition:opacity .18s,transform .18s
    }
    .notif.show{opacity:1;transform:translateY(0)}

    @media (max-width:1200px){.kpis{grid-template-columns:repeat(3,1fr)}.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:900px){.sidebar{display:none}.main{margin-left:0;padding:12px}.kpis{grid-template-columns:repeat(2,1fr)}.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <img src="{{ url_for('static', filename='logo_coopex.png') }}" alt="Coopex" class="logo" />
    <div class="sidebar-funcao">Gestor</div>
    <a class="nav-link active" href="{{ url_for('dashboard') }}"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a class="nav-link" href="{{ url_for('listar_cooperados') }}"><i class="bi bi-people"></i> Cooperados</a>
    <a class="nav-link" href="{{ url_for('listar_estabelecimentos') }}"><i class="bi bi-building"></i> Estabelecimentos</a>
    <a class="nav-link" href="{{ url_for('listar_lancamentos') }}"><i class="bi bi-journal-text"></i> Lançamentos</a>
    <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-left"></i> Sair</a>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="who">Bem-vindo, {{ admin.nome }}</div>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-warning btn-sm">Sair <i class="bi bi-power"></i></a>
    </div>

    <h2><i class="bi bi-speedometer2"></i> Painel de Controle</h2>

    <!-- Filtros -->
    <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 panel" id="form-filtros">
      <div class="col-md-3">
        <label class="form-label" for="cooperado_id">Cooperado</label>
        <select class="form-select" id="cooperado_id" name="cooperado_id">
          <option value="">Todos</option>
          {% for c in cooperados %}
            <option value="{{ c.id }}" {% if filtros.cooperado_id and filtros.cooperado_id|int == c.id %}selected{% endif %}>{{ c.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="estabelecimento_id">Estabelecimento</label>
        <select class="form-select" id="estabelecimento_id" name="estabelecimento_id">
          <option value="">Todos</option>
          {% for e in estabelecimentos %}
            <option value="{{ e.id }}" {% if filtros.estabelecimento_id and filtros.estabelecimento_id|int == e.id %}selected{% endif %}>{{ e.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="data_inicio">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ filtros.data_inicio or '' }}" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="data_fim">Data Fim</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ filtros.data_fim or '' }}" />
      </div>
      <div class="col-12 d-flex gap-2 justify-content-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-funnel"></i> Filtrar</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light" style="border-color:#c9d4ff;color:#4169e1"><i class="bi bi-x-circle"></i> Limpar</a>
      </div>

      <!-- chips dos filtros ativos -->
      <div class="chips" id="chips-filtros"></div>
    </form>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi">
        <div class="label"><i class="bi bi-journal-check"></i> Pedidos</div>
        <div class="value" id="kpi-pedidos">{{ total_pedidos or 0 }}</div>
        <div class="sub">Total no período</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-cash-stack"></i> Valor total</div>
        <div class="value" id="kpi-valor">R$ {{ ('{:,.2f}'.format(total_valor|default(0))) }}</div>
        <div class="sub">Soma dos lançamentos</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-people"></i> Cooperados</div>
        <div class="value">{{ total_cooperados or 0 }}</div>
        <div class="sub">Cadastrados</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-building"></i> Estabelecimentos</div>
        <div class="value">{{ total_estabelecimentos or 0 }}</div>
        <div class="sub">Ativos</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-graph-up"></i> Média por pedido</div>
        <div class="value" id="kpi-media">—</div>
        <div class="sub">Calculada no navegador</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-trophy"></i> Top cooperado</div>
        <div class="value" id="kpi-top">—</div>
        <div class="sub" id="kpi-top-sub">maior participação</div>
      </div>
    </section>

    <!-- atalhos -->
    <section class="cards">
      <a class="card-quick" href="{{ url_for('listar_lancamentos') }}">
        <i class="bi bi-journal-text"></i><span class="big">Lançamentos</span>
        <div><small>Histórico e exportação</small></div>
      </a>
      <a class="card-quick" href="{{ url_for('listar_cooperados') }}">
        <i class="bi bi-people"></i><span class="big">Cooperados</span>
        <div><small>Consulta e ajustes</small></div>
      </a>
      <a class="card-quick" href="{{ url_for('listar_estabelecimentos') }}">
        <i class="bi bi-building"></i><span class="big">Estabelecimentos</span>
        <div><small>Parceiros ativos</small></div>
      </a>
      <a class="card-quick" href="{{ url_for('listar_lancamentos') }}">
        <i class="bi bi-file-earmark-excel"></i><span class="big">Exportar</span>
        <div><small>Planilha Excel</small></div>
      </a>
    </section>

    <!-- gráfico + top lista -->
    <div class="row g-3">
      <div class="col-lg-7">
        <div class="panel">
          <h3><i class="bi bi-pie-chart"></i> Distribuição por cooperado</h3>
          <small>Baseada na lista atual ({{ (cooperado_nomes|length) if cooperado_nomes else 0 }} cooperados)</small>
          <canvas id="graficoCooperados" height="360"></canvas>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="panel">
          <h3><i class="bi bi-list-ol"></i> Top 8 cooperados</h3>
          <div class="toplist" id="toplist"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Som + balão -->
  <audio id="snd-servico" preload="auto" playsinline src="{{ url_for('statics_files', filename='servico.mp3') }}"></audio>
  <div id="notif-container" aria-live="polite"></div>

  <script>
    // ===== Helpers
    const labels = {{ cooperado_nomes|tojson or '[]' }};
    const valores = {{ lancamentos_contagem|tojson or '[]' }};
    const totalPedidos = Number({{ total_pedidos or 0 }});
    const totalValor = Number({{ total_valor or 0 }});
    const brl = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    // KPI média por pedido (sem mexer no backend)
    (function(){
      const media = totalPedidos > 0 ? (totalValor/totalPedidos) : 0;
      document.getElementById('kpi-media').textContent = brl(media);
    })();

    // Chips de filtro (sem back extra)
    (function(){
      const chipsBox = document.getElementById('chips-filtros');
      const add = (icon, txt) => {
        const s = document.createElement('span');
        s.className = 'chip';
        s.innerHTML = `<i class="bi ${icon}"></i> ${txt}`;
        chipsBox.appendChild(s);
      };
      const di = "{{ filtros.data_inicio or '' }}";
      const df = "{{ filtros.data_fim or '' }}";
      const co = "{{ filtros.cooperado_id or '' }}";
      const es = "{{ filtros.estabelecimento_id or '' }}";
      if (co){ const sel = document.getElementById('cooperado_id'); add('bi-person', sel.options[sel.selectedIndex].text); }
      if (es){ const sel = document.getElementById('estabelecimento_id'); add('bi-building', sel.options[sel.selectedIndex].text); }
      if (di){ add('bi-calendar-plus', new Date(di).toLocaleDateString('pt-BR')); }
      if (df){ add('bi-calendar-minus', new Date(df).toLocaleDateString('pt-BR')); }
    })();

    // Cores (até 300)
    function buildColors(n){
      const max=300, k=Math.min(n,max); const out=[];
      for (let i=0;i<k;i++){
        const hue=Math.round(i*360/k), ring=i%3, sat= ring===0?85: ring===1?72:62, light= ring===0?55:50;
        out.push(`hsl(${hue} ${sat}% ${light}%)`);
      }
      while(out.length<n) out.push(out[out.length%k]);
      return out;
    }

    // Plugin: label central + disco de freio
    const donutCenter = {
      id:'donutCenter',
      afterDraw(chart,args,plug){
        const {ctx} = chart; const meta=chart.getDatasetMeta(0);
        if(!meta || !meta.data || !meta.data.length) return;
        const a0=meta.data[0]; const {x:cx,y:cy,innerRadius:rIn,outerRadius:rOut}=a0;

        // Grooves
        ctx.save();
        ctx.strokeStyle = '#4169e11a'; ctx.lineWidth = Math.max(1,(rOut-rIn)*.02);
        for(let i=0;i<12;i++){ const ang=i*Math.PI*2/12; ctx.beginPath();
          ctx.moveTo(cx+Math.cos(ang)*rIn*0.98, cy+Math.sin(ang)*rIn*0.98);
          ctx.lineTo(cx+Math.cos(ang)*rOut*0.98, cy+Math.sin(ang)*rOut*0.98); ctx.stroke(); }
        // Hub
        ctx.fillStyle='#dbe4ff'; ctx.beginPath(); ctx.arc(cx,cy,rIn*0.9,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#c7d2ff'; ctx.beginPath(); ctx.arc(cx,cy,rIn*0.55,0,Math.PI*2); ctx.fill();
        // Holes
        ctx.fillStyle='#ffffff'; const holes=5, rr=rIn*0.08, dist=rIn*0.68;
        for(let i=0;i<holes;i++){ const ang=i*Math.PI*2/holes-Math.PI/2; const x=cx+Math.cos(ang)*dist, y=cy+Math.sin(ang)*dist;
          ctx.beginPath(); ctx.arc(x,y,rr,0,Math.PI*2); ctx.fill(); }
        // Center text (total)
        const total = valores.reduce((a,b)=>a+(+b||0),0);
        ctx.fillStyle='#4169e1'; ctx.font='900 18px Orbitron, sans-serif'; ctx.textAlign='center';
        ctx.fillText('Total', cx, cy-6);
        ctx.fillStyle='#0d1b3f'; ctx.font='700 14px Roboto, sans-serif';
        ctx.fillText(total.toLocaleString('pt-BR'), cx, cy+14);
        ctx.restore();
      }
    };

    // Gráfico
    (function(){
      const el=document.getElementById('graficoCooperados');
      if(!el) return;
      const dataValid = Array.isArray(labels) && labels.length && Array.isArray(valores) && valores.length;
      const colors = buildColors(labels.length || 1);

      const chart = new Chart(el.getContext('2d'), {
        type:'doughnut',
        data:{
          labels: dataValid? labels : ['Sem dados'],
          datasets:[{ data: dataValid? valores : [1], backgroundColor: colors, borderColor:'#e5ebff', borderWidth:1, hoverOffset:8 }]
        },
        options:{
          cutout:'55%',
          plugins:{
            legend:{ labels:{ color:'#0d1b3f' } },
            tooltip:{ callbacks:{ label:(c)=> (c.label? c.label+': ':'') + (c.parsed||0).toLocaleString('pt-BR') } }
          }
        },
        plugins:[donutCenter]
      });

      // KPIs derivados: top cooperado
      if (dataValid){
        const total = valores.reduce((a,b)=>a+(+b||0),0) || 1;
        let topI=0; for(let i=1;i<valores.length;i++){ if((+valores[i])>(+valores[topI])) topI=i; }
        const topNome = labels[topI] || '—';
        const topPct = ((+valores[topI]||0)/total)*100;
        document.getElementById('kpi-top').textContent = topNome;
        document.getElementById('kpi-top-sub').textContent = topPct.toFixed(1)+'% dos pedidos';
      } else {
        document.getElementById('kpi-top').textContent = '—';
      }
    })();

    // Toplist (Top 8) com barras
    (function(){
      const box = document.getElementById('toplist');
      if(!box) return;
      const arr = (labels||[]).map((n,i)=>({nome:n, qtd:+(valores[i]||0)}));
      arr.sort((a,b)=>b.qtd-a.qtd);
      const total = arr.reduce((s,x)=>s+x.qtd,0) || 1;
      (arr.slice(0,8)).forEach((it,idx)=>{
        const li = document.createElement('div');
        const pct = (it.qtd/total)*100;
        li.className='topitem';
        li.innerHTML = `
          <div class="rank">${idx+1}</div>
          <div class="flex-grow-1">
            <div style="display:flex;justify-content:space-between;gap:8px;">
              <strong>${it.nome}</strong>
              <span>${it.qtd.toLocaleString('pt-BR')} <small>(${pct.toFixed(1)}%)</small></span>
            </div>
            <div class="bar mt-1"><span style="width:${pct.toFixed(2)}%"></span></div>
          </div>`;
        box.appendChild(li);
      });
      if (arr.length===0){
        const li=document.createElement('div');
        li.className='topitem'; li.innerHTML='<div class="flex-grow-1 text-center">Sem dados para exibir.</div>';
        box.appendChild(li);
      }
    })();

    // Som + balões para novos lançamentos (mantido)
    (function () {
      let lastId = {{ ultimo_lancamento_id or 0 }};
      const audio = document.getElementById('snd-servico');
      const notifBox = document.getElementById('notif-container');

      function showBalloon(nome) {
        const div = document.createElement('div');
        div.className = 'notif';
        div.textContent = nome ? `Novo lançamento: ${nome}` : 'Novo lançamento';
        notifBox.appendChild(div);
        void div.offsetWidth;
        div.classList.add('show');
        setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 300); }, 3000);
      }

      async function ping() {
        try {
          const r = await fetch('{{ url_for("api_ultimo_lancamento") }}', { cache: 'no-store' });
          const j = await r.json();
          const novo = parseInt(j.last_id || 0);
          if (novo > lastId) {
            lastId = novo;
            audio && audio.play().catch(()=>{});
            try {
              const r2 = await fetch('{{ url_for("api_lancamento_info") }}?id=' + novo, { cache: 'no-store' });
              const j2 = await r2.json();
              const nome = (j2 && (j2.cooperado || j2.nome || j2.cooperado_nome)) || '';
              showBalloon(nome);
            } catch (_) { showBalloon(''); }
          }
        } catch (_) {}
      }
      setInterval(ping, 5000);
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
