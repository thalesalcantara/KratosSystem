<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard Admin - Coopex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background: #191c20;
        font-family: "Roboto", Arial, sans-serif;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #ffd700;
      }
      .sidebar {
        width: 210px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        background: linear-gradient(160deg, #101218 70%, #003399 100%);
        color: #fff;
        box-shadow: 3px 0 12px #00339944;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .sidebar .logo {
        width: 160px;
        margin: 38px auto 8px auto;
        display: block;
        filter: drop-shadow(0 0 18px #ffd700cc);
        transition: width .2s;
      }
      .sidebar-funcao {
        font-family: "Orbitron", sans-serif;
        color: #ffd700;
        font-size: 1.01rem;
        font-weight: 600;
        text-align: center;
        margin: 0 0 18px 0;
        padding: 0 4px;
        max-width: 110px;
        line-height: 1.12;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        background: none;
      }
      .sidebar .nav-link {
        color: #fff;
        font-size: 1.08rem;
        border-radius: 8px;
        margin: 3px 0;
        padding: 11px 20px;
        display: flex;
        align-items: center;
        text-decoration: none;
        transition: background 0.22s, color 0.22s;
        width: 100%;
        box-sizing: border-box;
      }
      .sidebar .nav-link.active,
      .sidebar .nav-link:hover {
        background: #ffd70033;
        color: #ffd700 !important;
      }
      .sidebar .nav-link i {
        font-size: 1.2rem;
        margin-right: 10px;
      }
      .main-content {
        margin-left: 230px;
        padding: 38px 32px 20px 32px;
      }
      .topbar {
        background: #101218;
        height: 62px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        border-bottom: 1.5px solid #23262b;
        box-shadow: 0 2px 16px #0004;
        position: sticky;
        top: 0;
        z-index: 20;
      }
      .topbar span {
        color: #ffd700;
        font-weight: 700;
        font-size: 1.07rem;
        margin-right: 24px;
      }
      .topbar .btn {
        font-weight: 700;
        border-radius: 20px;
      }
      h2 {
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        color: #ffd700;
        letter-spacing: 2px;
        margin-bottom: 30px;
        text-align: center;
      }
      .card-link {
        text-decoration: none !important;
      }
      .card-link .card {
        background: linear-gradient(120deg, #23262b 90%, #003399 100%);
        border-radius: 17px;
        box-shadow: 0 8px 32px #0008, 0 2px 8px #00339944;
        color: #ffd700;
        padding: 24px;
        margin-bottom: 30px;
        text-align: center;
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        font-size: 1.5rem;
        user-select: none;
        transition: background 0.3s, box-shadow 0.3s, transform 0.15s;
        cursor: pointer;
      }
      .card-link .card:hover {
        background: #0044cc;
        color: #ffd700 !important;
        box-shadow: 0 6px 22px #00339966, 0 2px 12px #00339933;
        transform: translateY(-4px) scale(1.04);
      }
      .card-link .card i {
        font-size: 2.8rem;
        margin-bottom: 12px;
        display: block;
        color: #ffe670;
        transition: color 0.2s;
      }
      .card-link .card:hover i {
        color: #fffbe7;
      }
      form .form-control,
      form .form-select {
        background: #222;
        border: 1px solid #555;
        color: #ffd700;
      }
      form label {
        font-weight: 600;
        color: #ffd700cc;
      }
      form .btn-primary {
        background: linear-gradient(90deg, #ffd700 60%, #ffe670 100%);
        color: #191c20;
        font-weight: bold;
        border: none;
        border-radius: 17px;
        padding: 8px 20px;
        margin-top: 10px;
      }
      form .btn-primary:hover {
        background: #ffe670;
        color: #003399;
      }
      #graficoCooperados {
        max-height: 360px;
      }
      /* Notificação (balão) */
      #notif-container {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 9999;
      }
      .notif {
        background: #ffd700;
        color: #003399;
        font-weight: 800;
        border-radius: 12px;
        padding: 10px 14px;
        margin-top: 8px;
        box-shadow: 0 10px 24px #0008, 0 2px 6px #00339955;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity .18s ease, transform .18s ease;
      }
      .notif.show {
        opacity: 1;
        transform: translateY(0);
      }
      @media (max-width: 900px) {
        .sidebar { display: none; }
        .main-content { margin-left: 0; padding: 12px; }
      }
    </style>
</head>
<body>
  <div class="sidebar">
    <img src="{{ url_for('static', filename='logo_coopex.png') }}" alt="Logo Coopex" class="logo" />
    <div class="sidebar-funcao">Gestor</div>
    <a class="nav-link active" href="{{ url_for('dashboard') }}"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a class="nav-link" href="{{ url_for('listar_cooperados') }}"><i class="bi bi-people"></i> Cooperados</a>
    <a class="nav-link" href="{{ url_for('listar_estabelecimentos') }}"><i class="bi bi-building"></i> Estabelecimentos</a>
    <a class="nav-link" href="{{ url_for('listar_lancamentos') }}"><i class="bi bi-journal-text"></i> Lançamentos</a>
    <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-left"></i> Sair</a>
  </div>

  <div class="main-content">
    <div class="topbar mb-4">
      <span>Bem-vindo, {{ admin.nome }}</span>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-warning btn-sm ms-2">Sair <i class="bi bi-power"></i></a>
    </div>

    <h2><i class="bi bi-speedometer2"></i> Painel de Controle</h2>

    <form method="get" action="{{ url_for('dashboard') }}" class="mb-4 row g-3">
      <div class="col-md-3">
        <label for="cooperado_id" class="form-label">Cooperado</label>
        <select class="form-select" id="cooperado_id" name="cooperado_id" aria-label="Selecione cooperado">
          <option value="">Todos</option>
          {% for c in cooperados %}
            <option value="{{ c.id }}" {% if filtros.cooperado_id and filtros.cooperado_id|int == c.id %} selected {% endif %}>{{ c.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="estabelecimento_id" class="form-label">Estabelecimento</label>
        <select class="form-select" id="estabelecimento_id" name="estabelecimento_id" aria-label="Selecione estabelecimento">
          <option value="">Todos</option>
          {% for e in estabelecimentos %}
            <option value="{{ e.id }}" {% if filtros.estabelecimento_id and filtros.estabelecimento_id|int == e.id %} selected {% endif %}>{{ e.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="data_inicio" class="form-label">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ filtros.data_inicio or '' }}" />
      </div>
      <div class="col-md-3">
        <label for="data_fim" class="form-label">Data Fim</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ filtros.data_fim or '' }}" />
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">Filtrar</button>
      </div>
    </form>

    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <a href="{{ url_for('listar_lancamentos') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-journal-check"></i>
            Total de Pedidos
            <div>{{ total_pedidos or 0 }}</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('listar_lancamentos') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-cash-stack"></i>
            Valor Total Lançado
            <div>R$ {{ ('{:,.2f}'.format(total_valor|default(0))) }}</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('listar_cooperados') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-people"></i>
            Cooperados Cadastrados
            <div>{{ total_cooperados or 0 }}</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('listar_estabelecimentos') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-building"></i>
            Estabelecimentos
            <div>{{ total_estabelecimentos or 0 }}</div>
          </div>
        </a>
      </div>
    </div>

    <!-- Gráfico tipo pizza (doughnut) com visual de disco de freio -->
    <canvas id="graficoCooperados" height="360"></canvas>
  </div>

  <!-- ÁUDIO: toca quando detectar novo lançamento (arquivo em /statics/servico.mp3) -->
  <audio id="snd-servico" preload="auto" playsinline
         src="{{ url_for('statics_files', filename='servico.mp3') }}"></audio>

  <!-- Container para balões de notificação -->
  <div id="notif-container" aria-live="polite"></div>

  <script>
    // ====== CHART: Pizza (Doughnut) com efeito "disco de freio" ======
    (function () {
      const ctx = document.getElementById("graficoCooperados").getContext("2d");

      const labels = {{ cooperado_nomes|tojson }};
      const valores = {{ lancamentos_contagem|tojson }};

      // Paleta dourada/azulada suave
      const colors = [];
      for (let i = 0; i < labels.length; i++) {
        const hue = 48 + (i * 7) % 20;   // em torno do dourado
        const sat = 90;
        const light = 55 - (i % 3) * 6;
        colors.push(`hsl(${hue} ${sat}% ${light}%)`);
      }

      // Plugin para desenhar centro/hub e furos (efeito disco)
      const brakeDiscPlugin = {
        id: 'brakeDisc',
        afterDraw(chart, args, opts) {
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data || !meta.data.length) return;

          const arc0 = meta.data[0];
          const {x: cx, y: cy, innerRadius: rIn, outerRadius: rOut} = arc0;

          const ctx = chart.ctx;
          ctx.save();

          // Linhas radiais (ranhuras)
          ctx.strokeStyle = '#ffffff22';
          ctx.lineWidth = Math.max(1, (rOut - rIn) * 0.02);
          const grooves = 12;
          for (let i = 0; i < grooves; i++) {
            const ang = (i / grooves) * Math.PI * 2;
            const r1 = rIn * 0.98;
            const r2 = rOut * 0.98;
            ctx.beginPath();
            ctx.moveTo(cx + Math.cos(ang) * r1, cy + Math.sin(ang) * r1);
            ctx.lineTo(cx + Math.cos(ang) * r2, cy + Math.sin(ang) * r2);
            ctx.stroke();
          }

          // Cubo central (hub)
          ctx.fillStyle = '#b9b9b9';
          ctx.beginPath();
          ctx.arc(cx, cy, rIn * 0.9, 0, Math.PI * 2);
          ctx.fill();

          // Hub interno mais escuro
          ctx.fillStyle = '#8a8a8a';
          ctx.beginPath();
          ctx.arc(cx, cy, rIn * 0.55, 0, Math.PI * 2);
          ctx.fill();

          // Furos dos parafusos (em contraste com o fundo da página)
          ctx.fillStyle = '#191c20';
          const holes = 5;
          const holeRad = rIn * 0.08;
          const holeDist = rIn * 0.68;
          for (let i = 0; i < holes; i++) {
            const ang = (i / holes) * Math.PI * 2 - Math.PI / 2;
            const hx = cx + Math.cos(ang) * holeDist;
            const hy = cy + Math.sin(ang) * holeDist;
            ctx.beginPath();
            ctx.arc(hx, hy, holeRad, 0, Math.PI * 2);
            ctx.fill();
          }

          ctx.restore();
        }
      };

      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{
            label: "Valor (R$)",
            data: valores,
            backgroundColor: colors,
            borderColor: "#222b",
            borderWidth: 1,
            hoverOffset: 8
          }]
        },
        options: {
          cutout: "55%",
          plugins: {
            legend: {
              labels: { color: "#ffd700" }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const v = context.parsed;
                  return "R$ " + (v || 0).toLocaleString("pt-BR", {minimumFractionDigits: 2});
                }
              }
            }
          }
        },
        plugins: [brakeDiscPlugin]
      });
    })();

    // ====== SOM + BALÃO: detectar novo lançamento ======
    (function () {
      let lastId = {{ ultimo_lancamento_id or 0 }};
      const audio = document.getElementById('snd-servico');
      const notifBox = document.getElementById('notif-container');

      function showBalloon(nome) {
        const div = document.createElement('div');
        div.className = 'notif';
        div.textContent = nome ? `Novo lançamento: ${nome}` : 'Novo lançamento';
        notifBox.appendChild(div);
        // força reflow para o CSS transition
        void div.offsetWidth;
        div.classList.add('show');
        setTimeout(() => {
          div.classList.remove('show');
          setTimeout(() => div.remove(), 300);
        }, 1500);
      }

      async function ping() {
        try {
          const r = await fetch('{{ url_for("api_ultimo_lancamento") }}', { cache: 'no-store' });
          const j = await r.json();
          const novo = parseInt(j.last_id || 0);
          if (novo > lastId) {
            lastId = novo;
            // toca som
            audio && audio.play().catch(()=>{});
            // tenta buscar o nome do cooperado (requer endpoint /api_lancamento_info?id=)
            try {
              const r2 = await fetch('{{ url_for("api_lancamento_info") }}?id=' + novo, { cache: 'no-store' });
              const j2 = await r2.json();
              const nome = (j2 && (j2.cooperado || j2.nome || j2.cooperado_nome)) || '';
              showBalloon(nome);
            } catch (e) {
              showBalloon('');
            }
          }
        } catch (e) {
          // silencioso
        }
      }

      // Checa a cada 5s
      setInterval(ping, 5000);
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
