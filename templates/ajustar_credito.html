<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>
    {% if cooperado %}Ajustar Crédito - {{ cooperado.nome }}{% else %}Ajustar Crédito{% endif %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <style>
    body{
      background:#191c20;
      font-family:'Roboto',Arial,sans-serif;
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      padding:18px
    }
    .ajustar-card{
      background:linear-gradient(120deg,#23262b 88%,#003399 100%);
      color:#ffd700;
      padding:36px 28px 24px;
      border-radius:16px;
      box-shadow:0 8px 32px #000a;
      width:100%;max-width:520px
    }
    .titulo{
      font-family:'Orbitron',sans-serif;
      letter-spacing:1.3px;color:#fff;text-align:center;margin-bottom:14px
    }
    .foto-cooperado{
      width:90px;height:90px;object-fit:cover;border-radius:50%;
      border:3px solid #ffd700;margin:10px auto;background:#fff;display:block;
      box-shadow:0 0 8px #00339955
    }
    .nome{color:#fff;text-align:center;margin-bottom:8px;font-weight:600}
    label{color:#fff;font-weight:700}
    .form-control{
      background:#23262b;border:1px solid #22263d;color:#ffd700;font-weight:600;border-radius:10px
    }
    .form-control:focus{
      border-color:#ffd700;box-shadow:0 0 0 1.5px #ffd70044;background:#191c20;color:#ffd700
    }
    .hint{color:#ffe670;font-size:.92rem;margin-top:6px}
    .preview{
      margin-top:10px;font-weight:800;font-size:1.05rem
    }
    .preview .novo{font-size:1.18rem}
    .novo.up{color:#3fe28f}     /* verde */
    .novo.down{color:#ff8f8f}   /* vermelho */
    .novo.neutral{color:#fff}
    .btn-primary{
      background:linear-gradient(90deg,#ffd700 60%,#ffe670 100%);
      color:#191c20;font-weight:bold;border:none;border-radius:13px;width:100%;margin-top:12px
    }
    .btn-primary:hover{background:#ffe670;color:#003399}
    .btn-outline-warning{border-radius:13px}
    .alert{background:#ffd700;color:#222;font-weight:700;border-radius:9px;margin-bottom:12px;text-align:center}
    .linha-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .inline-buttons{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .inline-buttons .btn{border-radius:10px;padding:.3rem .6rem}
  </style>
</head>
<body>
  <div class="ajustar-card">

    {% if session.get('user_tipo') == 'admin' %}
      <div class="mb-2">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-warning btn-sm">
          <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
        </a>
      </div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if cooperado %}
      <!-- ===== MODO INDIVIDUAL ===== -->
      <h4 class="titulo"><i class="bi bi-cash-coin"></i> Ajustar Crédito</h4>

      {% if cooperado.foto_data or cooperado.foto %}
        <img src="{{ url_for('foto_cooperado', id=cooperado.id) }}"
             alt="Foto de {{ cooperado.nome }}" class="foto-cooperado">
      {% else %}
        <div class="text-center" style="font-size:2rem;color:#ffd700;">
          <i class="bi bi-person-circle"></i>
        </div>
      {% endif %}

      <div class="nome">{{ cooperado.nome }}</div>
      <div class="text-center mb-2" style="color:#ffe670;">
        Crédito atual: <strong id="saldo-atual" data-saldo="{{ '%.2f'|format(cooperado.credito) }}">R$ {{ '%.2f'|format(cooperado.credito) }}</strong>
      </div>

      <form method="post" id="form-ajuste-individual">
        <!-- Campo que o usuário preenche é o AJUSTE, podendo usar + / - -->
        <label for="ajuste"><i class="bi bi-plus-slash-minus"></i> Ajuste (R$)</label>
        <input type="text" id="ajuste" class="form-control" placeholder="+200,00 ou -150.50" autocomplete="off" inputmode="decimal">
        <div class="hint">Digite o valor a <b>somar</b> ou <b>subtrair</b>. Ex.: <code>+200</code>, <code>-150,75</code>. O sistema calcula o novo crédito.</div>

        <!-- Prévia do cálculo -->
        <div class="preview">
          Novo crédito: <span class="novo neutral" id="novo-valor">R$ {{ '%.2f'|format(cooperado.credito) }}</span>
          <div id="erro" class="text-danger fw-bold mt-1" style="display:none;"></div>
        </div>

        <!-- Campo oculto enviado ao backend (sem mudar app.py) -->
        <input type="hidden" name="credito" id="credito-final" value="{{ '%.2f'|format(cooperado.credito) }}">

        <!-- Ações rápidas -->
        <div class="inline-buttons">
          <button class="btn btn-outline-light btn-sm" type="button" data-quick="+50">+50</button>
          <button class="btn btn-outline-light btn-sm" type="button" data-quick="+100">+100</button>
          <button class="btn btn-outline-light btn-sm" type="button" data-quick="+200">+200</button>
          <button class="btn btn-outline-light btn-sm" type="button" data-quick="-50">-50</button>
          <button class="btn btn-outline-light btn-sm" type="button" data-quick="-100">-100</button>
        </div>

        <div class="linha-btns">
          <button type="submit" class="btn btn-primary" id="btn-salvar">Salvar</button>
          <a href="{{ url_for('listar_cooperados') }}" class="btn btn-secondary flex-fill">
            <i class="bi bi-people"></i> Voltar à lista
          </a>
        </div>
      </form>

    {% else %}
      <!-- ===== MODO GLOBAL ===== -->
      <h4 class="titulo"><i class="bi bi-cash-coin"></i> Ajustar Crédito</h4>

      <form method="post" id="form-ajuste-global">
        <div class="mb-3">
          <label for="cooperado_id"><i class="bi bi-person-badge"></i> Cooperado</label>
          <select class="form-control" id="cooperado_id" name="cooperado_id" required>
            <option value="" disabled selected>Selecione…</option>
            {% for c in cooperados %}
              <option value="{{ c.id }}" data-saldo="{{ '%.2f'|format(c.credito) }}">
                {{ c.nome }} — ({{ c.username }}) — R$ {{ '%.2f'|format(c.credito) }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-1" id="saldo-wrap" style="display:none;color:#ffe670;">
          Crédito atual: <strong id="saldo-atual-global">R$ 0,00</strong>
        </div>

        <div class="mb-2">
          <label for="ajuste-global"><i class="bi bi-plus-slash-minus"></i> Ajuste (R$)</label>
          <input type="text" class="form-control" id="ajuste-global" placeholder="+200,00 ou -150.50" autocomplete="off" inputmode="decimal">
          <div class="hint">Use <code>+</code> para somar e <code>-</code> para subtrair.</div>
        </div>

        <div class="preview" id="preview-global" style="display:none;">
          Novo crédito: <span class="novo neutral" id="novo-valor-global">R$ 0,00</span>
          <div id="erro-global" class="text-danger fw-bold mt-1" style="display:none;"></div>
        </div>

        <!-- Campo oculto que o backend espera -->
        <input type="hidden" name="credito" id="credito-final-global" value="">

        <div class="linha-btns">
          <button type="submit" class="btn btn-primary" id="btn-salvar-global" disabled>Salvar</button>
          <a href="{{ url_for('listar_cooperados') }}" class="btn btn-secondary flex-fill">
            <i class="bi bi-people"></i> Voltar à lista
          </a>
        </div>
      </form>
    {% endif %}

  </div>

  <script>
    // --- Util: parse pt-BR / aceitar + e -
    function parseSignedBR(str){
      if(!str){ return null; }
      str = String(str).trim()
        .replace(/[R$\s]/gi,'')
        .replace(/\./g,'')       // remove separador de milhar
        .replace(',', '.');      // vírgula -> ponto
      if(!/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(str)) return null;
      const n = parseFloat(str);
      return isNaN(n) ? null : n;
    }
    function formatBR(n){
      return n.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    }

    // ====== MODO INDIVIDUAL ======
    (function(){
      const form = document.getElementById('form-ajuste-individual');
      if(!form) return;

      const saldoEl = document.getElementById('saldo-atual');
      const ajusteEl = document.getElementById('ajuste');
      const previewEl = document.getElementById('novo-valor');
      const erroEl = document.getElementById('erro');
      const hiddenFinal = document.getElementById('credito-final');
      const btnSalvar = document.getElementById('btn-salvar');

      const saldoAtual = parseFloat(saldoEl.dataset.saldo.replace(',','.')) || 0;

      function atualizarPreview(){
        const delta = parseSignedBR(ajusteEl.value);
        let novo = saldoAtual;
        erroEl.style.display = 'none';
        previewEl.className = 'novo neutral';

        if(delta !== null){
          novo = saldoAtual + delta;
          if(novo < 0){
            erroEl.textContent = 'O crédito não pode ficar negativo.';
            erroEl.style.display = 'block';
            btnSalvar.disabled = true;
          }else{
            btnSalvar.disabled = false;
          }
          previewEl.textContent = 'R$ ' + formatBR(novo);
          previewEl.classList.remove('neutral');
          previewEl.classList.add(delta >= 0 ? 'up' : 'down');
        }else{
          // sem delta válido, mostra saldo atual
          previewEl.textContent = 'R$ ' + formatBR(novo);
          btnSalvar.disabled = false; // permitir salvar sem ajuste (sem mudar)
        }
        hiddenFinal.value = novo.toFixed(2); // backend recebe o novo total
      }

      ajusteEl.addEventListener('input', atualizarPreview);

      // botões rápidos
      document.querySelectorAll('[data-quick]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const v = b.getAttribute('data-quick');
          ajusteEl.value = v;
          atualizarPreview();
        });
      });

      atualizarPreview();

      form.addEventListener('submit', (e)=>{
        // garante cálculo antes de enviar
        atualizarPreview();
      });
    })();

    // ====== MODO GLOBAL ======
    (function(){
      const form = document.getElementById('form-ajuste-global');
      if(!form) return;

      const select = document.getElementById('cooperado_id');
      const saldoWrap = document.getElementById('saldo-wrap');
      const saldoTxt = document.getElementById('saldo-atual-global');
      const ajuste = document.getElementById('ajuste-global');
      const prevWrap = document.getElementById('preview-global');
      const prevTxt = document.getElementById('novo-valor-global');
      const erro = document.getElementById('erro-global');
      const hiddenFinal = document.getElementById('credito-final-global');
      const btnSalvar = document.getElementById('btn-salvar-global');

      function saldoSelecionado(){
        const opt = select.options[select.selectedIndex];
        if(!opt) return 0;
        return parseFloat((opt.getAttribute('data-saldo')||'0').replace(',','.')) || 0;
      }

      function atualizar(){
        const s = saldoSelecionado();
        if(select.value){
          saldoWrap.style.display = '';
          saldoTxt.textContent = 'R$ ' + formatBR(s);
          prevWrap.style.display = '';
        }else{
          saldoWrap.style.display = 'none';
          prevWrap.style.display = 'none';
          btnSalvar.disabled = true;
          return;
        }

        const delta = parseSignedBR(ajuste.value);
        let novo = s;
        erro.style.display = 'none';
        prevTxt.className = 'novo neutral';

        if(delta !== null){
          novo = s + delta;
          if(novo < 0){
            erro.textContent = 'O crédito não pode ficar negativo.';
            erro.style.display = 'block';
            btnSalvar.disabled = true;
          }else{
            btnSalvar.disabled = false;
          }
          prevTxt.textContent = 'R$ ' + formatBR(novo);
          prevTxt.classList.remove('neutral');
          prevTxt.classList.add(delta >= 0 ? 'up' : 'down');
        }else{
          prevTxt.textContent = 'R$ ' + formatBR(novo);
          btnSalvar.disabled = true; // requer um ajuste válido
        }

        hiddenFinal.value = novo.toFixed(2);
      }

      select.addEventListener('change', atualizar);
      ajuste.addEventListener('input', atualizar);
      form.addEventListener('submit', ()=>{ atualizar(); });

      atualizar();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
