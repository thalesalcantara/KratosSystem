<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard Admin - Coopex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ===== TEMA AZUL-ROYAL + BRANCO (apenas cores) ===== */
      body {
        background: #f7f9ff; /* claro */
        font-family: "Roboto", Arial, sans-serif;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #0d1b3f; /* texto principal escuro */
      }

      /* Sidebar clara com azul-royal */
      .sidebar {
        width: 210px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        background: #ffffff;
        color: #0d1b3f;
        box-shadow: 3px 0 16px rgba(65,105,225,.12);
        border-right: 1px solid #e5ebff;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 30px;
      }
      .sidebar .logo {
        width: 210px !important; /* mantém seu 3x maior */
        height: auto !important;
        margin: 34px auto 4px auto;
        display: block;
        filter: drop-shadow(0 0 12px rgba(65,105,225,.35));
        transition: width .2s;
      }
      .sidebar-funcao {
        font-family: 'Orbitron', sans-serif;
        color: #4169e1; /* royal */
        font-size: 0.91rem;
        font-weight: 700;
        text-align: center;
        margin: 0 0 14px 0;
        padding: 0 3px;
        max-width: 96px;
        line-height: 1.08;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        background: none;
      }
      .sidebar .nav-link {
        color: #0d1b3f;
        font-size: 1.08rem;
        border-radius: 8px;
        margin: 3px 0;
        padding: 11px 20px;
        display: flex;
        align-items: center;
        text-decoration: none;
        transition: background 0.22s, color 0.22s;
        width: 100%;
        box-sizing: border-box;
        background: #ffffff;
      }
      .sidebar .nav-link.active,
      .sidebar .nav-link:hover {
        background: #eef3ff; /* hover claro */
        color: #4169e1 !important;
      }
      .sidebar .nav-link i {
        font-size: 1.2rem;
        margin-right: 10px;
        color: #4169e1;
      }

      /* Main / Topbar azul-royal em gradiente */
      .main-content {
        margin-left: 230px;
        padding: 38px 32px 20px 32px;
      }
      .topbar {
        background: linear-gradient(90deg, #4169e1 0%, #5a7df0 100%);
        height: 62px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1.5px solid rgba(255,255,255,.25);
        box-shadow: 0 8px 24px rgba(65,105,225,.25);
        position: sticky;
        top: 0;
        z-index: 20;
        border-radius: 14px;
        padding: 0 8px;
        color: #fff;
      }
      .topbar .btn-voltar {
        font-weight: 700;
        border-radius: 20px;
        background: #ffffff;
        color: #4169e1;
        border: 1px solid #ffffff;
        margin-right: 16px;
        transition: background 0.2s, color 0.2s;
      }
      .topbar .btn-voltar:hover {
        background: #2b50d9;
        color: #ffffff;
        border-color: #2b50d9;
      }
      .topbar span {
        color: #ffffff;
        font-weight: 700;
        font-size: 1.07rem;
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .topbar .btn-logout,
      #btn-ativar-som-servico {
        border-color: #ffffff !important;
        color: #ffffff !important;
      }
      .topbar .btn-logout:hover,
      #btn-ativar-som-servico:hover {
        background: #ffffff !important;
        color: #4169e1 !important;
      }

      /* Título */
      h2 {
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        color: #4169e1;
        letter-spacing: 2px;
        margin-bottom: 30px;
        text-align: center;
      }

      /* Cards claros */
      .card-link {
        text-decoration: none !important;
      }
      .card-link .card {
        background: #ffffff;
        border-radius: 17px;
        box-shadow: 0 8px 28px rgba(65,105,225,.14), 0 2px 8px rgba(65,105,225,.10);
        border: 1px solid #e5ebff;
        color: #0d1b3f;
        padding: 24px;
        margin-bottom: 30px;
        text-align: center;
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        font-size: 1.3rem;
        user-select: none;
        transition: background 0.3s, box-shadow 0.3s, transform 0.15s, color .2s;
        cursor: pointer;
      }
      .card-link .card:hover {
        background: #f5f8ff;
        color: #2b50d9 !important;
        box-shadow: 0 8px 28px rgba(65,105,225,.22), 0 2px 12px rgba(65,105,225,.18);
        transform: translateY(-4px) scale(1.02);
      }
      .card-link .card i {
        font-size: 2.3rem;
        margin-bottom: 10px;
        display: block;
        color: #4169e1;
        transition: color 0.2s;
      }
      .card-link .card:hover i {
        color: #2b50d9;
      }

      /* Formulários claros */
      form .form-control,
      form .form-select {
        background: #ffffff;
        border: 1.5px solid #c9d4ff;
        color: #0d1b3f;
      }
      form label {
        font-weight: 700;
        color: #2b3e73;
      }
      form .form-control:focus,
      form .form-select:focus {
        border-color: #4169e1;
        box-shadow: 0 0 0 .2rem rgba(65,105,225,.18);
      }
      form .btn-primary {
        background: linear-gradient(90deg, #4169e1 0%, #5a7df0 100%);
        color: #ffffff;
        font-weight: bold;
        border: none;
        border-radius: 17px;
        padding: 8px 20px;
        margin-top: 10px;
        box-shadow: 0 10px 18px rgba(65,105,225,.18);
      }
      form .btn-primary:hover {
        background: #2b50d9;
        color: #ffffff;
      }

      /* Gráfico – cores azuis */
      #graficoCooperados {
        max-height: 340px;
        background: #ffffff;
        border: 1px solid #e5ebff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(65,105,225,.10);
        padding: 8px;
      }

      /* Tabela (se usar .tabela-cooperados) */
      .tabela-cooperados,
      .tabela-cooperados th,
      .tabela-cooperados td {
        color: #0d1b3f !important;
        background-color: #ffffff !important;
        border-color: #e5ebff !important;
      }

      @media (max-width: 900px) {
        .sidebar {
          display: none;
        }
        .main-content {
          margin-left: 0;
          padding: 12px;
        }
        .sidebar-funcao {
          font-size: 0.86rem;
          max-width: 78px;
          padding: 0 2px;
        }
        .sidebar .logo {
          width: 84px !important;
        }
      }
    </style>
</head>
<body>
  <div class="sidebar">
    <img src="{{ url_for('static', filename='logo_coopex.png') }}" alt="Logo Coopex" class="logo" />
    <div class="sidebar-funcao">Gestor</div>
    <a class="nav-link active" href="{{ url_for('dashboard') }}"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a class="nav-link" href="{{ url_for('listar_cooperados') }}"><i class="bi bi-people"></i> Cooperados</a>
    <a class="nav-link" href="{{ url_for('listar_estabelecimentos') }}"><i class="bi bi-building"></i> Estabelecimentos</a>
    <a class="nav-link" href="{{ url_for('listar_lancamentos') }}"><i class="bi bi-journal-text"></i> Lançamentos</a>
    <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-left"></i> Sair</a>
  </div>

  <div class="main-content">
    <div class="topbar mb-4">
      <button class="btn btn-voltar" onclick="window.location.href='{{ url_for('dashboard') }}';">
        <i class="bi bi-arrow-left"></i> Voltar
      </button>
      <span>Bem-vindo, {{ admin.nome }}</span>
      <div class="d-flex align-items-center">
        <!-- Botão opcional para “desbloquear” áudio por gesto do usuário -->
        <button type="button" id="btn-ativar-som-servico" class="btn btn-outline-warning btn-sm me-2" title="Ativar/ testar som de novo lançamento">
          <i class="bi bi-volume-up"></i> Som
        </button>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-warning btn-sm btn-logout ms-2">Sair <i class="bi bi-power"></i></a>
      </div>
    </div>

    <h2><i class="bi bi-speedometer2"></i> Painel de Controle</h2>

    <form method="get" action="{{ url_for('dashboard') }}" class="mb-4 row g-3">
      <div class="col-md-3">
        <label for="cooperado_id" class="form-label">Cooperado</label>
        <select class="form-select" id="cooperado_id" name="cooperado_id" aria-label="Selecione cooperado" onchange="mostrarFotoCooperadoDashboard()">
          <option value="" data-foto="">Todos</option>
          {% for c in cooperados %}
            <option value="{{ c.id }}"
              data-foto="{{ url_for('static', filename='uploads/' ~ c.foto) if c.foto else '' }}"
              {% if filtros.cooperado_id and filtros.cooperado_id|int == c.id %} selected {% endif %}
            >{{ c.nome }}</option>
          {% endfor %}
        </select>
        <div id="foto-cooperado-dashboard" style="text-align:center; margin:8px 0 0 0;"></div>
      </div>
      <div class="col-md-3">
        <label for="estabelecimento_id" class="form-label">Estabelecimento</label>
        <select class="form-select" id="estabelecimento_id" name="estabelecimento_id" aria-label="Selecione estabelecimento">
          <option value="">Todos</option>
          {% for e in estabelecimentos %}
            <option value="{{ e.id }}" {% if filtros.estabelecimento_id and filtros.estabelecimento_id|int == e.id %} selected {% endif %}>{{ e.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="data_inicio" class="form-label">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ filtros.data_inicio or '' }}" />
      </div>
      <div class="col-md-3">
        <label for="data_fim" class="form-label">Data Fim</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ filtros.data_fim or '' }}" />
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">Filtrar</button>
      </div>
    </form>

    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <a href="{{ url_for('listar_lancamentos') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-journal-check"></i>
            Total de Pedidos
            <div>{{ total_pedidos or 0 }}</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('listar_lancamentos') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-cash-stack"></i>
            Valor Total Lançado
            <div>R$ {{ ('{:,.2f}'.format(total_valor|default(0))) }}</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('listar_cooperados') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-people"></i>
            Cooperados Cadastrados
            <div>{{ total_cooperados or 0 }}</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('listar_estabelecimentos') }}" class="card-link">
          <div class="card shadow-sm">
            <i class="bi bi-building"></i>
            Estabelecimentos
            <div>{{ total_estabelecimentos or 0 }}</div>
          </div>
        </a>
      </div>
    </div>

    <!-- Gráfico Cooperados horizontal mostrando VALOR REAL gasto por cooperado -->
    <canvas id="graficoCooperados" height="320"></canvas>

    <!-- Dados atuais (para o script comparar e decidir tocar o áudio) -->
    <div id="metrics-data"
         data-total-pedidos="{{ total_pedidos|default(0) }}"
         data-ultimo-id="{{ ultimo_lancamento_id|default(0) }}"
         style="display:none;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function mostrarFotoCooperadoDashboard() {
      var select = document.getElementById("cooperado_id");
      var fotoDiv = document.getElementById("foto-cooperado-dashboard");
      var option = select.options[select.selectedIndex];
      var foto = option ? option.getAttribute("data-foto") : null;
      if (foto && select.value) {
        /* só cores alteradas: borda azul-royal e sombra azul suave */
        fotoDiv.innerHTML = '<img src="' + foto + '" alt="Foto do Cooperado" style="max-width:90px;max-height:90px;border-radius:50%;border:3px solid #4169e1;box-shadow:0 0 8px rgba(65,105,225,.33);">';
      } else {
        fotoDiv.innerHTML = '';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      mostrarFotoCooperadoDashboard();
    });

    const ctx = document.getElementById("graficoCooperados").getContext("2d");

    const data = {
      labels: {{ cooperado_nomes|tojson }},
      datasets: [
        {
          label: "Valor Real Gasto (R$)",
          data: {{ cooperado_valores|tojson }},
          backgroundColor: "rgba(65, 105, 225, 0.85)", /* azul-royal */
          borderColor: "rgba(65, 105, 225, 1)",
          borderWidth: 2,
          barThickness: 16,
          maxBarThickness: 18
        }
      ]
    };

    const options = {
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            color: "#0d1b3f", /* texto escuro */
            font: { size: 13 },
            callback: function(value) { return "R$ " + value; }
          },
          grid: { color: "rgba(65,105,225,.25)" }
        },
        y: {
          ticks: { color: "#0d1b3f", font: { size: 15 } },
          grid: { color: "rgba(65,105,225,.18)" }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              let value = context.parsed.x !== undefined ? context.parsed.x : context.parsed.y;
              return "R$ " + value.toLocaleString("pt-BR", {minimumFractionDigits:2});
            }
          }
        }
      },
      animation: {
        onComplete: function() {
          const chart = this.chart;
          const ctx = chart.ctx;
          ctx.save();
          chart.data.datasets.forEach(function(dataset, i) {
            chart.getDatasetMeta(i).data.forEach(function(bar, index) {
              const value = dataset.data[index];
              ctx.font = "bold 13px Roboto";
              ctx.fillStyle = "#0d1b3f"; /* número ao lado da barra em azul-escuro */
              ctx.textAlign = "left";
              ctx.textBaseline = "middle";
              let x = bar.x + 8;
              let y = bar.y;
              ctx.fillText("R$ " + value.toLocaleString("pt-BR", {minimumFractionDigits:2}), x, y);
            });
          });
          ctx.restore();
        }
      }
    };

    new Chart(ctx, {
      type: "bar",
      data: data,
      options: options,
    });
  </script>

  <!-- ÁUDIO: tocar quando aparecer novo lançamento (serviço) -->
  <audio id="som-servico" preload="auto" style="display:none">
    <!-- os mp3 estão em /statics (não é /static) -->
    <source src="{{ url_for('statics_files', filename='servico.mp3') }}" type="audio/mpeg">
  </audio>

  <!-- Script: toca servico.mp3 quando detectar aumento de lançamentos -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const audio = document.getElementById('som-servico');
      const metrics = document.getElementById('metrics-data');

      // valores atuais vindos do servidor
      const totalAtual = parseInt(metrics?.getAttribute('data-total-pedidos') || '0', 10);
      const ultimoIdAtual = parseInt(metrics?.getAttribute('data-ultimo-id') || '0', 10);

      // chaves no localStorage (por navegador)
      const LS_TOTAL = 'coopex_total_pedidos';
      const LS_ULTID = 'coopex_ultimo_lanc_id';

      const totalPrev = parseInt(localStorage.getItem(LS_TOTAL) || '0', 10);
      const ultPrev   = parseInt(localStorage.getItem(LS_ULTID) || '0', 10);

      // decisão: tocar se aumentou o total ou se o último ID é maior
      let deveTocar = false;
      if (!isNaN(totalPrev) && totalAtual > totalPrev) {
        deveTocar = true;
      } else if (!isNaN(ultPrev) && ultimoIdAtual > ultPrev) {
        deveTocar = true;
      }

      // salva os valores atuais para a próxima visita/reload
      localStorage.setItem(LS_TOTAL, String(totalAtual));
      localStorage.setItem(LS_ULTID, String(ultimoIdAtual));

      function tocar(aud) {
        if (!aud) return;
        try {
          aud.currentTime = 0;
          const p = aud.play();
          if (p && typeof p.then === 'function') p.catch(() => { /* pode ser bloqueado pelo navegador sem gesto */ });
        } catch (e) { /* ignora */ }
      }

      if (deveTocar) {
        tocar(audio);
      }

      // Botão opcional para “ativar/testar” som (ajuda a liberar autoplay)
      const btn = document.getElementById('btn-ativar-som-servico');
      if (btn) {
        btn.addEventListener('click', function () {
          tocar(audio);
        });
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
