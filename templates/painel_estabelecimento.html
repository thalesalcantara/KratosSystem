<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Estabelecimento - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts, Bootstrap e Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      /* Paleta — Azul Royal + Branco (clean & leve) */
      --bg:#f7f9ff;            /* fundo geral super claro */
      --ink:#0d1b3f;           /* texto principal (azul bem escuro) */
      --muted:#5c6c92;         /* texto secundário */
      --gold:#2d4fe3;          /* AZUL ROYAL (usa var existente) */
      --line:#e5ebff;          /* bordas suaves */

      /* Superfícies / cartões */
      --surface:#ffffff;
      --surface-2:#fcfdff;

      /* Tabela */
      --thead:#2d4fe3;         /* cabeçalho azul royal */
      --rowOdd:#f2f5ff;        /* listras leves */
      --rowEven:#ffffff;

      /* KPIs / campos */
      --kpi:#ffffff;
      --kpiLine:#dbe4ff;
      --field:#ffffff;
      --fieldBorder:#c9d4ff;
      --fieldFocus:#2d4fe3;

      /* Modal edição */
      --modalGrad1:#ffffff;
      --modalGrad2:#ffffff;
      --modalEdge:#d5ddff;

      /* Efeitos */
      --glass:rgba(255,255,255,.78);
      --blur:10px;
      --glow:0 12px 28px rgba(45,79,227,.12);
      --glow-strong:0 22px 44px rgba(45,79,227,.16);
      --hover:#edf2ff;
    }

    html,body{height:100%}
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 520px at 100% -10%, rgba(45,79,227,.12), transparent 60%),
        radial-gradient(900px 420px at -10% 120%, rgba(45,79,227,.08), transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--ink);
      font-family:Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
      text-shadow:none;
    }

    /* Foco acessível */
    :focus-visible{ outline:3px solid var(--gold); outline-offset:2px; border-radius:10px; }

    /* ===== Sidebar (glass + gradiente sutil) ===== */
    .sidebar{
      width:210px; height:100vh; position:fixed; top:0; left:0;
      background:var(--glass);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-right:1px solid var(--line);
      box-shadow:var(--glow);
      color:#1a2b66; z-index:10;
      display:flex; flex-direction:column; align-items:center;
    }
    .sidebar::before{
      content:""; position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(45,79,227,.10), transparent 30%),
        linear-gradient(0deg, rgba(45,79,227,.06), transparent 45%);
      pointer-events:none;
    }
    .sidebar .logo{
      width:176px; max-width:95%; margin:28px auto 12px; display:block;
      filter: drop-shadow(0 6px 14px rgba(45,79,227,.25));
    }
    .sidebar h3{
      font-family:Orbitron, sans-serif; color:#0d1b3f; text-align:center;
      letter-spacing:1px; margin-bottom:22px; font-size:1.05rem; font-weight:900;
      background:#ffffff; border-radius:12px; padding:8px 0; width:88%;
      border:1px solid var(--line); box-shadow:var(--glow);
    }
    .sidebar .nav-link{
      color:#0d1b3f; font-size:1.08rem; border-radius:12px; margin:6px 10px;
      padding:12px 16px; display:flex; align-items:center; gap:10px; text-decoration:none;
      transition:transform .06s ease, background .18s ease, box-shadow .18s ease, color .18s ease;
      will-change:transform;
      background:#ffffff; border:1px solid var(--line); box-shadow:var(--glow);
      font-weight:800;
    }
    .sidebar .nav-link i{font-size:1.25rem; color:var(--gold);}
    .sidebar .nav-link.active, .sidebar .nav-link:hover{
      background:linear-gradient(0deg, #ffffff 0%, #f6f9ff 100%);
      color:#0d1b3f!important; transform:translateY(-1px);
      box-shadow:var(--glow-strong); border-color:#cfd8ff;
    }

    /* ===== Main / Topbar (faixa hero) ===== */
    .main-content{ margin-left:230px; padding:32px 28px 24px; }
    .topbar{
      min-height:72px; display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(90deg, #2d4fe3 0%, #4b6df0 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.25);
      border-radius:18px;
      padding:8px 16px;
      box-shadow:0 14px 34px rgba(45,79,227,.22);
      position:sticky; top:0; z-index:20;
    }
    .who{ color:#ffffff; font-weight:900; font-size:1.06rem; letter-spacing:.2px; }
    .clock{ color:#e9efff; font-weight:900; letter-spacing:.4px; font-size:1.02rem; }

    /* ===== Cards ===== */
    .dashboard-card{
      background:linear-gradient(120deg,var(--surface) 0%, var(--surface-2) 100%);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--glow);
      padding:24px 20px 20px;
      color:var(--ink);
    }
    .dashboard-card h4{
      margin:0 0 12px;
      font-family:Orbitron, sans-serif; font-weight:900; letter-spacing:1.1px; color:var(--gold);
      text-shadow:none;
    }

    /* ===== KPIs (auto-fit + novo KPI do mês) ===== */
    .kpis{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom:14px;
    }
    .kpi{
      background:#ffffff; border:1px solid var(--kpiLine); border-radius:16px; padding:14px 16px;
      display:flex; flex-direction:column; gap:6px; min-height:96px;
      box-shadow: 8px 8px 24px rgba(13,35,97,.06), -8px -8px 24px rgba(255,255,255,.7);
    }
    .kpi .label{ color:#1b2b5e; font-weight:900; display:flex; align-items:center; gap:8px; }
    .kpi .value{ font:900 1.35rem/1 Orbitron, sans-serif; color:var(--gold); letter-spacing:.5px; }
    .kpi .sub{ color:var(--muted); font-size:.94rem; }

    /* ===== Ranking / Resumos rápidos ===== */
    .ranking{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px; }
    .rank-card{
      background:#ffffff; border:1px solid var(--line); border-radius:16px; padding:14px 16px;
      box-shadow:var(--glow);
    }
    .rank-card h5{ margin:0 0 8px; font-family:Orbitron, sans-serif; color:var(--gold); }
    .rank-list{ margin:0; padding-left:18px; }
    .rank-list li{ margin:4px 0; font-weight:800; color:var(--ink); }
    .rank-list small{ color:var(--muted); }

    /* ===== Pílulas/resumos ===== */
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line);
      border-radius:999px; background:#f7f9ff; font-weight:800; color:#1d2a52;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }

    /* ===== Form ===== */
    label{font-weight:900;color:#16275a;letter-spacing:.25px;}
    .form-control,.form-select{
      background:var(--field); color:var(--ink); border:2px solid var(--fieldBorder);
      border-radius:12px; height:46px; font-size:1rem; padding:10px 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
      transition:border-color .15s ease, box-shadow .15s ease, transform .02s ease;
    }
    .form-control::placeholder{color:#90a2d8;}
    .form-control:focus,.form-select:focus{
      border-color:var(--fieldFocus); box-shadow:0 0 0 .2rem rgba(45,79,227,.18);
      transform:translateY(-1px);
    }

    /* ===== Botões ===== */
    .btn-primary{
      background:linear-gradient(90deg,#2d4fe3 0%, #4169e1 100%);
      color:#ffffff; font-weight:900; border:none; border-radius:14px; padding:10px 18px;
      transition:filter .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow:0 10px 18px rgba(45,79,227,.18);
    }
    .btn-primary:hover{ filter:brightness(1.05); transform:translateY(-1px); box-shadow:0 16px 26px rgba(45,79,227,.22); }
    .btn-primary:active{ transform:translateY(0); }
    .btn-outline-primary{ color:#2d4fe3; border-color:#2d4fe3; font-weight:800; }
    .btn-outline-primary:hover{ background:#2d4fe3; color:#ffffff; }
    .btn-outline-danger{ color:#b94a59; border-color:#ff7f8f; font-weight:800; }
    .btn-outline-danger:hover{ background:#ff7f8f; color:#0b142d; }

    /* ===== Tabela — clara, legível ===== */
    .table-wrap{ border-radius:14px; overflow:auto; background:#ffffff; border:1px solid var(--line); box-shadow:var(--glow); }
    table{ width:100%; margin:0; color:var(--ink); font-size:1.02rem; }
    thead th{
      position:sticky; top:0; z-index:5;
      background:var(--thead)!important; color:#ffffff!important;
      font-family:Orbitron, sans-serif; letter-spacing:.9px; text-align:center;
      padding:14px 10px; white-space:nowrap;
      border-bottom:2px solid var(--line)!important;
      box-shadow:0 2px 0 rgba(45,79,227,.18);
    }
    .table.table-striped tbody tr > *,
    .table-hover tbody tr > *,
    #tbody-lanc td, #tbody-lanc th{ color:var(--ink) !important; }
    td.valor{ color:#2d4fe3 !important; font-weight:900; }
    tbody td{
      border-top:1px solid var(--line);
      padding:12px 10px; vertical-align:middle;
    }
    .table-striped>tbody>tr:nth-of-type(odd)>*{background-color:var(--rowOdd)!important;}
    .table-striped>tbody>tr:nth-of-type(even)>*{background-color:var(--rowEven)!important;}
    .table-hover tbody tr:hover>*{ background-color:var(--hover)!important; }

    .aviso-expirado{ color:#6f80b1; font-weight:700; }

    /* ===== Modal Edição ===== */
    .modal-content{
      background:linear-gradient(135deg, var(--modalGrad1), var(--modalGrad2));
      border:1px solid var(--modalEdge);
      border-radius:18px;
      color:var(--ink);
      box-shadow:var(--glow-strong), inset 0 0 0 1px rgba(255,255,255,.6);
    }
    .modal-header{
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(45,79,227,.06), transparent);
      border-top-left-radius:18px; border-top-right-radius:18px;
    }
    .modal-title{
      font-family:Orbitron, sans-serif; color:var(--gold); letter-spacing:1px;
      display:flex; align-items:center; gap:8px;
    }
    .modal .form-control{ background:#f9fbff; border:2px solid #e3e9ff; color:var(--ink); }
    .modal .form-control:focus{ border-color:#a5b8ff; box-shadow:0 0 0 .2rem rgba(165,184,255,.25); }
    .input-group-text{
      background:#eef2ff; border-color:#e1e7ff; color:#1d2a52; font-weight:800;
    }
    .time-left{ color:#2d4fe3; font-weight:900; }

    /* ===== Alertas ===== */
    .alert{
      background:#eaf0ff; color:#152756; font-weight:900; border:1px solid var(--line); border-radius:12px;
      text-align:center; box-shadow:var(--glow);
    }

    /* ===== Responsivo ===== */
    @media (max-width:1200px){
      .ranking{ grid-template-columns:1fr; }
    }
    @media (max-width:900px){
      .sidebar{display:none;}
      .main-content{margin-left:0;padding:14px;}
      table{ font-size:1rem; }
      thead th{ font-size:.98rem; }
    }

    /* Ajustes finos */
    #erro-lancar{ color:#b4232a !important; font-weight:800; }
    #foto-cooperado-preview img{
      box-shadow:0 0 0 3px rgba(45,79,227,.15), 0 6px 14px rgba(45,79,227,.18);
      border-radius:50%;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <img src="{{ url_for('static', filename='logo_coopex.png') }}" alt="Logo Coopex" class="logo">
    <h3>Parceiro<br>Coopex</h3>
    <a class="nav-link active" href="#"><i class="bi bi-currency-dollar"></i>Lançar Crédito</a>
    <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-left"></i>Sair</a>
  </div>

  <!-- Main -->
  <div class="main-content">

    <!-- Topbar com relógio -->
    <div class="topbar mb-4">
      <div class="who">Bem-vindo, {{ est.nome }}</div>
      <div class="d-flex align-items-center gap-3">
        <div class="clock" id="clock-br">Brasília — --/--/---- --:--:--</div>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-warning btn-sm fw-bold" style="border-color:#ffd66e;color:#fff">Sair <i class="bi bi-power"></i></a>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- KPIs (calculados no front a partir da tabela) -->
    <div class="kpis">
      <div class="kpi">
        <div class="label"><i class="bi bi-list-check"></i> Lançamentos</div>
        <div class="value" id="k-count">0</div>
        <div class="sub">Total</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-cash-stack"></i> Valor Total</div>
        <div class="value" id="k-sum">R$ 0,00</div>
        <div class="sub">Soma geral</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-graph-up-arrow"></i> Maior Lançamento</div>
        <div class="value" id="k-max">R$ 0,00</div>
        <div class="sub">Valor único máximo</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-person-fill-check"></i> Top Cooperado</div>
        <div class="value" id="k-top">—</div>
        <div class="sub" id="k-top-sub">Maior soma</div>
      </div>
      <div class="kpi">
        <div class="label"><i class="bi bi-clock-history"></i> Último Lançamento</div>
        <div class="value" id="k-last">—</div>
        <div class="sub">Horário de Brasília</div>
      </div>
      <!-- NOVO KPI: Total do Mês -->
      <div class="kpi">
        <div class="label"><i class="bi bi-calendar-month"></i> Total do Mês</div>
        <div class="value" id="k-month-sum">R$ 0,00</div>
        <div class="sub"><span id="k-month-count">0</span> lançamentos</div>
      </div>
    </div>

    <!-- Ranking / Resumos -->
    <div class="ranking">
      <div class="rank-card">
        <h5><i class="bi bi-trophy"></i> Top 3 Cooperados por Valor</h5>
        <ol class="rank-list" id="rank-list">
          <li>—</li>
        </ol>
      </div>
      <div class="rank-card">
        <h5><i class="bi bi-calendar3"></i> Hoje</h5>
        <div><span class="pill"><i class="bi bi-list-check"></i> Lançamentos: <span id="h-count">0</span></span></div>
        <div class="mt-2"><span class="pill"><i class="bi bi-cash"></i> Valor: <span id="h-sum">R$ 0,00</span></span></div>
      </div>
    </div>

    <!-- Card de Lançamento -->
    <div class="dashboard-card mb-4">
      <h4><i class="bi bi-currency-dollar"></i> Lançar valor para cooperado</h4>
      <form method="post" action="{{ url_for('painel_estabelecimento') }}">
        <div class="row g-3 align-items-center mb-1">
          <div class="col-md-4">
            <label class="form-label" for="cooperado_id">
              <i class="bi bi-person-lines-fill"></i> Cooperado
            </label>
            <select class="form-select" id="cooperado_id" name="cooperado_id" required onchange="mostrarInfoCooperado()">
              <option value="">Selecione...</option>
              {% for c in cooperados %}
              <option
                value="{{ c.id }}"
                data-saldo="{{ '{:,.2f}'.format(c.credito) }}"
                data-saldo-raw="{{ c.credito }}"
                data-foto="{{ url_for('foto_cooperado', id=c.id) if (c.foto_data or c.foto) else '' }}"
              >{{ c.nome }}</option>
              {% endfor %}
            </select>

            <div id="foto-cooperado-preview" class="mt-2" style="text-align:center;"></div>
            <div id="saldo-cooperado" class="mt-2" style="color:var(--gold); font-weight:900; font-size:1.06rem;"></div>
            <div id="erro-lancar" class="mt-1" style="color:#ffdede; font-weight:800;"></div>
          </div>

          <div class="col-md-2">
            <label class="form-label" for="valor"><i class="bi bi-cash-stack"></i> Valor</label>
            <div class="input-group">
              <span class="input-group-text">R$</span>
              <input type="number" step="0.01" min="0.01" class="form-control" id="valor" name="valor" required oninput="checarCreditoSuficiente()">
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label" for="os_numero"><i class="bi bi-file-earmark-text"></i> Nº OS</label>
            <input type="text" class="form-control" id="os_numero" name="os_numero" required placeholder="Ex: 12345">
          </div>

          <div class="col-md-3">
            <label class="form-label" for="descricao"><i class="bi bi-justify-left"></i> Descrição</label>
            <input type="text" class="form-control" id="descricao" name="descricao" placeholder="(opcional)">
          </div>
        </div>

        <button type="submit" class="btn btn-primary mt-2" id="btn-lancar">
          <i class="bi bi-plus-circle"></i> Lançar Valor
        </button>
      </form>
    </div>

    <!-- Lista de Lançamentos -->
    <div class="dashboard-card">
      <h4><i class="bi bi-clock-history"></i> Lançamentos realizados</h4>
      <div class="table-wrap">
        <table class="table table-striped table-hover text-center align-middle">
          <thead>
            <tr>
              <th>Data & Hora</th>
              <th>Nº OS</th>
              <th>Cooperado</th>
              <th>Valor (R$)</th>
              <th>Descrição</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody-lanc">
            {% for l in lancamentos %}
            <tr data-created="{{ l.data.isoformat() }}Z" data-id="{{ l.id }}">
              <td class="dt">{{ l.data_brasilia }}</td>
              <td class="os">{{ l.os_numero }}</td>
              <td class="coop">{{ l.cooperado.nome }}</td>
              <td class="valor" data-valor="{{ '%.2f'|format(l.valor) }}">{{ "{:,.2f}".format(l.valor) }}</td>
              <td class="desc">{{ l.descricao or '' }}</td>
              <td class="acoes">
                <button type="button"
                        class="btn btn-outline-primary btn-sm btn-editar fw-bold"
                        data-id="{{ l.id }}"
                        data-os="{{ l.os_numero }}"
                        data-valor="{{ '%.2f'|format(l.valor) }}"
                        data-desc="{{ l.descricao or '' }}"
                        onclick="abrirModalEditar(this)">
                  <i class="bi bi-pencil-square"></i> Editar
                </button>

                <form method="post"
                      action="{{ url_for('estab_excluir_lancamento', id=l.id) }}"
                      style="display:inline-block;"
                      onsubmit="return confirmarExcluir(this);">
                  <button type="submit" class="btn btn-outline-danger btn-sm btn-excluir fw-bold">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                </form>

                <div class="aviso-expirado small mt-1" style="display:none;">Bloqueado (1h)</div>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="6">Nenhum lançamento realizado.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR -->
  <div class="modal fade" id="modalEditarLanc" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <form class="modal-content" method="post" id="form-editar-modal">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-sliders2-vertical"></i> Ajustar Lançamento</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <!-- Infos do lançamento -->
          <div class="row g-3 mb-2">
            <div class="col-md-6">
              <div class="pill"><i class="bi bi-clock"></i> Criado: <span id="m-criado">—</span></div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="pill"><i class="bi bi-hourglass-split"></i> Restante: <span id="m-restante" class="time-left">—</span></div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nº OS</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-receipt"></i></span>
                <input type="text" class="form-control" id="edit-os" name="os_numero" required>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Valor</label>
              <div class="input-group">
                <span class="input-group-text">R$</span>
                <input type="number" step="0.01" min="0.01" class="form-control" id="edit-valor" name="valor" required>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Descrição</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-chat-left-text"></i></span>
                <input type="text" class="form-control" id="edit-desc" name="descricao" placeholder="(opcional)">
              </div>
            </div>
          </div>

          <div class="form-text mt-2" style="color:#2d4fe3; font-weight:900;">
            <i class="bi bi-info-circle"></i> Edição permitida até 1 hora após a criação.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-light fw-bold" type="button" data-bs-dismiss="modal" style="color:#2d4fe3;border-color:#a6b6ff;">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button class="btn btn-primary fw-bold" type="submit" id="btn-save-modal">
            <i class="bi bi-check2-circle"></i> Salvar alterações
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ÁUDIO: VENDA -->
  <audio id="snd-venda" preload="auto" playsinline
         src="{{ url_for('statics_files', filename='venda.mp3') }}"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===== Relógio (Brasília) ===== */
    function tickClock(){
      const el = document.getElementById('clock-br');
      if(!el) return;
      const s = new Date().toLocaleString('pt-BR', { timeZone:'America/Sao_Paulo', hour12:false });
      el.textContent = 'Natal -' + s;
    }
    setInterval(tickClock, 1000); tickClock();

    /* ===== Info do cooperado ===== */
    function mostrarInfoCooperado(){
      const select = document.getElementById("cooperado_id");
      const saldoDiv = document.getElementById("saldo-cooperado");
      const fotoDiv  = document.getElementById("foto-cooperado-preview");
      const option   = select.options[select.selectedIndex];
      const saldo    = option ? option.getAttribute("data-saldo") : null;
      const foto     = option ? option.getAttribute("data-foto") : null;

      saldoDiv.textContent = (saldo && select.value) ? `Saldo atual: R$ ${saldo}` : '';
      if (foto && select.value){
        fotoDiv.innerHTML = `<img src="${foto}" alt="Foto do Cooperado"
          style="max-width:96px;max-height:96px;border-radius:50%;
                 border:3px solid var(--gold);box-shadow:0 0 8px #00339955;">`;
      } else {
        fotoDiv.innerHTML = '';
      }
      checarCreditoSuficiente();
    }

    function checarCreditoSuficiente(){
      const select = document.getElementById("cooperado_id");
      const valorInput = document.getElementById("valor");
      const erroDiv = document.getElementById("erro-lancar");
      const btn = document.getElementById("btn-lancar");

      const option = select.options[select.selectedIndex];
      const saldo = option ? parseFloat(option.getAttribute("data-saldo-raw")) : null;
      const valor = valorInput.value ? parseFloat(valorInput.value) : null;

      if (!select.value){ erroDiv.textContent=""; btn.disabled=true; return; }
      if (saldo == null || isNaN(saldo) || saldo <= 0){
        erroDiv.textContent="Este cooperado está sem crédito disponível!";
        btn.disabled=true; return;
      }
      if (valor && valor > saldo){
        erroDiv.textContent="O valor excede o saldo disponível!";
        btn.disabled=true;
      } else {
        erroDiv.textContent="";
        btn.disabled=false;
      }
    }

    /* ===== Helpers de data no fuso de Brasília ===== */
    function ymBR(d){
      return new Date(d).toLocaleString('en-CA',{timeZone:'America/Sao_Paulo'}).slice(0,7); // YYYY-MM
    }
    function isHojeBR(date){
      const br = new Date().toLocaleString('en-CA',{timeZone:'America/Sao_Paulo'}).slice(0,10);
      const d  = new Date(date).toLocaleString('en-CA',{timeZone:'America/Sao_Paulo'}).slice(0,10);
      return br===d;
    }

    /* ===== Indicadores e Ranking a partir da tabela ===== */
    function formatBR(n){ return n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function atualizarIndicadores(){
      const rows = [...document.querySelectorAll('#tbody-lanc tr')];
      let count=0, sum=0, max=0, lastTs=0;
      let hCount=0, hSum=0;
      let mCount=0, mSum=0; // NOVOS: mês
      const monthNow = ymBR(new Date());
      const porCoop = Object.create(null);

      rows.forEach(tr=>{
        const valTd = tr.querySelector('.valor');
        if(!valTd) return;
        const v = parseFloat(valTd.dataset.valor || '0');
        if(isNaN(v)) return;
        count++;
        sum += v;
        if (v>max) max=v;

        const createdStr = tr.getAttribute('data-created') || '';
        const created = Date.parse(createdStr) || 0;

        if (created>lastTs) lastTs = created;
        if (created && isHojeBR(created)){ hCount++; hSum += v; }

        // Totais do mês (Brasília)
        if (created && ymBR(created) === monthNow){ mCount++; mSum += v; }

        const nome = (tr.querySelector('.coop')?.textContent || '').trim();
        if (nome){ porCoop[nome] = (porCoop[nome]||0) + v; }
      });

      // KPIs básicos
      let topNome='—', topVal=0;
      const pares = Object.entries(porCoop).sort((a,b)=>b[1]-a[1]);
      if (pares.length){ topNome = pares[0][0]; topVal = pares[0][1]; }

      document.getElementById('k-count').textContent = count;
      document.getElementById('k-sum').textContent   = 'R$ ' + formatBR(sum);
      document.getElementById('k-max').textContent   = 'R$ ' + formatBR(max);
      document.getElementById('k-top').textContent   = topNome!=='—' ? topNome : '—';
      document.getElementById('k-top-sub').textContent = topNome!=='—' ? ('Soma: R$ ' + formatBR(topVal)) : 'Maior soma';
      document.getElementById('h-count').textContent = hCount;
      document.getElementById('h-sum').textContent   = 'R$ ' + formatBR(hSum);

      if (lastTs){
        const br = new Date(lastTs).toLocaleString('pt-BR', { timeZone:'America/Sao_Paulo', hour12:false });
        document.getElementById('k-last').textContent = br;
      } else {
        document.getElementById('k-last').textContent = '—';
      }

      // KPI do Mês
      const kMonthSum = document.getElementById('k-month-sum');
      const kMonthCount = document.getElementById('k-month-count');
      if (kMonthSum)  kMonthSum.textContent  = 'R$ ' + formatBR(mSum);
      if (kMonthCount)kMonthCount.textContent = mCount;

      // Ranking Top 3
      const ul = document.getElementById('rank-list');
      ul.innerHTML = '';
      if (!pares.length){ ul.innerHTML = '<li>—</li>'; return; }
      pares.slice(0,3).forEach(([nome,total],i)=>{
        const li = document.createElement('li');
        li.innerHTML = `<span class="me-1">#${i+1}</span> ${nome} <small>— R$ ${formatBR(total)}</small>`;
        ul.appendChild(li);
      });
    }

    /* ===== Modal Editar + restrição de 1h ===== */
    let editarModal, tRestanteTimer=null;
    document.addEventListener('DOMContentLoaded', function(){
      mostrarInfoCooperado();
      document.getElementById("cooperado_id")?.addEventListener("change", mostrarInfoCooperado);
      document.getElementById("valor")?.addEventListener("input", checarCreditoSuficiente);

      editarModal = new bootstrap.Modal(document.getElementById('modalEditarLanc'));

      aplicarRestricaoUmaHora();
      setInterval(aplicarRestricaoUmaHora, 60*1000);

      atualizarIndicadores();
      setInterval(atualizarIndicadores, 15000);

      if (document.querySelector('.alert.alert-success')){
        const a=document.getElementById('snd-venda');
        a && a.play().catch(()=>{});
      }
    });

    document.addEventListener('click', function(ev){
      const tgt = ev.target.closest('#btn-lancar');
      if (!tgt || tgt.disabled) return;
      const a=document.getElementById('snd-venda');
      a && a.play().catch(()=>{});
    });

    function abrirModalEditar(btn){
      const tr = btn.closest('tr');
      const createdIso = tr.getAttribute('data-created');
      const expirado = estaExpirado(createdIso);

      const id    = btn.getAttribute('data-id');
      const os    = btn.getAttribute('data-os') || '';
      const valor = btn.getAttribute('data-valor') || '';
      const desc  = btn.getAttribute('data-desc') || '';

      document.getElementById('edit-os').value = os;
      document.getElementById('edit-valor').value = valor.replace(',', '.');
      document.getElementById('edit-desc').value = desc;

      // Info no cabeçalho do modal
      const criadoBR = createdIso
        ? new Date(createdIso).toLocaleString('pt-BR',{timeZone:'America/Sao_Paulo', hour12:false})
        : '—';
      document.getElementById('m-criado').textContent = criadoBR;

      // Timer de restante
      const restanteEl = document.getElementById('m-restante');
      const btnSave = document.getElementById('btn-save-modal');
      function updateRestante(){
        const msLeft = 60*60*1000 - (new Date() - new Date(createdIso));
        if (msLeft <= 0){
          restanteEl.textContent = 'Expirado';
          btnSave.disabled = true;
          clearInterval(tRestanteTimer);
          tRestanteTimer = null;
        } else {
          const m = Math.floor(msLeft/60000);
          const s = Math.floor((msLeft%60000)/1000);
          restanteEl.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
          btnSave.disabled = false;
        }
      }
      if (tRestanteTimer){ clearInterval(tRestanteTimer); tRestanteTimer=null; }
      if (createdIso){ updateRestante(); tRestanteTimer=setInterval(updateRestante, 1000); }
      else{ restanteEl.textContent='—'; btnSave.disabled=false; }

      const form = document.getElementById('form-editar-modal');
      form.action = "{{ url_for('estab_editar_lancamento', id=0) }}".replace('/0', '/' + id);

      if (!expirado) editarModal.show();
    }

    function confirmarExcluir(formEl){
      const tr = formEl.closest('tr');
      if (estaExpirado(tr.getAttribute('data-created'))) return false;
      return confirm('Confirma excluir este lançamento? O crédito será devolvido ao cooperado.');
    }

    function aplicarRestricaoUmaHora(){
      document.querySelectorAll('table tbody tr[data-created]').forEach(tr=>{
        const createdIso = tr.getAttribute('data-created');
        const expirado = estaExpirado(createdIso);

        const btnEditar = tr.querySelector('.btn-editar');
        const btnExcluir = tr.querySelector('.btn-excluir');
        const aviso = tr.querySelector('.aviso-expirado');

        if (expirado){
          if (btnEditar){ btnEditar.disabled=true; btnEditar.classList.add('disabled'); }
          if (btnExcluir){ btnExcluir.disabled=true; btnExcluir.classList.add('disabled'); }
          if (aviso) aviso.style.display='block';
        } else {
          if (btnEditar){ btnEditar.disabled=false; btnEditar.classList.remove('disabled'); }
          if (btnExcluir){ btnExcluir.disabled=false; btnExcluir.classList.remove('disabled'); }
          if (aviso) aviso.style.display='none';
        }
      });
    }

    function estaExpirado(createdIso){
      if (!createdIso) return false;
      const criado = new Date(createdIso);  // UTC
      const agora  = new Date();
      const diffMs = agora - criado;
      return diffMs > (60*60*1000); // 1 hora
    }
  </script>
</body>
</html>
