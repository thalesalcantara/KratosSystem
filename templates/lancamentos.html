<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Lançamentos - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --line:#dbe4ff;
      --ink:#0b1537;
      --muted:#56648a;

      --royal:#1f4fe0;
      --royal2:#3a66ff;

      --thead:#f1f5ff;
      --rowOdd:#ffffff;
      --rowEven:#f8fbff;

      --danger:#e25566;
      --ok:#2e8b57;

      --shadow: 0 10px 22px rgba(16, 37, 122, .10);
      --shadow2: 0 18px 38px rgba(16, 37, 122, .14);

      --radius: 18px;
    }

    *{box-sizing:border-box}
    html, body{ overflow-x:hidden; }
    body{
      background:
        radial-gradient(1200px 420px at 10% -20%, rgba(31,79,224,.14), transparent 70%),
        radial-gradient(1200px 420px at 95% 0%, rgba(58,102,255,.10), transparent 70%),
        linear-gradient(180deg, var(--bg), var(--bg));
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      color: var(--ink);
    }

    /* Usa a tela toda (sem sobrar “página para o lado”) */
    .main-content{
      width: 100%;
      max-width: none;
      padding: 22px 22px 30px;
      margin: 0 auto;
    }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal2) 100%);
      padding: 14px 16px;
      border-radius: 18px;
      box-shadow: var(--shadow2);
      color:#fff;
      position: sticky;
      top: 14px;
      z-index: 10;
      border: 1px solid rgba(255,255,255,.30);
    }
    .topbar .title{
      display:flex; align-items:center; gap:12px;
      font-family: Orbitron, sans-serif;
      font-weight: 800;
      letter-spacing: .8px;
      min-width: 260px;
    }
    .brand-badge{
      width: 40px; height: 40px;
      border-radius: 14px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.30);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }
    .topbar .subtitle{
      font-family: Inter, sans-serif;
      font-weight: 700;
      opacity: .90;
      letter-spacing: 0;
      font-size: .9rem;
    }
    .topbar .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn-soft{
      background: rgba(255,255,255,.14);
      color: #fff;
      border: 1px solid rgba(255,255,255,.35);
      border-radius: 14px;
      font-weight: 900;
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }
    .btn-soft:hover{ filter: brightness(1.04); }

    .cardx{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(219,228,255,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 14px;
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    .stat{
      background: #fff;
      border: 1px solid rgba(219,228,255,.95);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 18px rgba(31,79,224,.08);
      position: relative;
      overflow: hidden;
    }
    .stat:before{
      content:"";
      position:absolute; inset: -30% -30% auto auto;
      width: 170px; height: 170px;
      background: radial-gradient(circle at 30% 30%, rgba(31,79,224,.16), transparent 60%);
      transform: rotate(18deg);
    }
    .stat .label{
      position:relative;
      color:#24345f; font-weight: 900;
      display:flex; gap:8px; align-items:center;
      font-size: .95rem;
    }
    .stat .value{
      position:relative;
      font: 900 1.35rem/1 Orbitron, sans-serif;
      color: var(--royal);
      margin-top: 10px;
      white-space: nowrap;
    }
    .stat .sub{ position:relative; color: var(--muted); font-size: .92rem; margin-top: 6px; font-weight: 700; }

    label{ font-weight:900; color: var(--ink); }

    .form-control, .form-select{
      border:2px solid #c7d2ff;
      border-radius: 14px;
      height: 46px;
      font-weight: 700;
      background: #fff;
    }
    .form-control:focus, .form-select:focus{
      border-color: var(--royal);
      box-shadow: 0 0 0 .2rem rgba(31,79,224,.18);
    }

    .btn-primary{
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal2) 100%);
      border:none;
      border-radius: 14px;
      height: 46px;
      font-weight: 900;
      box-shadow: 0 12px 22px rgba(31,79,224,.18);
    }
    .btn-primary:hover{ filter: brightness(1.03); }
    .btn-outline-light{
      border-radius: 14px;
      height: 46px;
      border: 2px solid #c7d2ff;
      color: var(--royal);
      background:#fff;
      font-weight: 900;
    }
    .btn-outline-light:hover{ background:#f1f5ff; color:#12224d; }
    .btn-success{ border-radius:14px; height:46px; font-weight:900; }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f1f5ff;
      border: 1px solid rgba(219,228,255,.95);
      color:#1b2b5e;
      font-weight: 900;
      font-size: .9rem;
      box-shadow: 0 8px 14px rgba(31,79,224,.06);
    }
    .chip i{ color: var(--royal); }

    .hint{
      color: var(--muted);
      font-weight: 700;
      font-size: .92rem;
    }

    /* Tabela sem scroll lateral */
    .table-wrap{
      width: 100%;
      overflow: hidden; /* impede scroll lateral */
      border-radius: 16px;
      border: 1px solid rgba(219,228,255,.95);
      background:#fff;
      box-shadow: 0 10px 22px rgba(31,79,224,.08);
    }

    table#t-lanc{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed; /* chave para caber sem overflow */
      margin: 0;
    }

    #t-lanc thead th{
      position: sticky; top: 0; z-index: 2;
      background: var(--thead);
      color: var(--royal)!important;
      font-family: Orbitron, sans-serif;
      letter-spacing: .8px;
      border-bottom: 1px solid rgba(219,228,255,.95);
      text-align:center;
      padding: 12px 8px;
      font-size: .92rem;
      white-space: nowrap;
    }

    #t-lanc tbody td{
      border-top: 1px solid rgba(219,228,255,.85);
      vertical-align: middle;
      padding: 12px 8px;
      text-align:center;
      font-size: .94rem;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #t-lanc tbody tr:nth-child(odd) td{ background: var(--rowOdd); }
    #t-lanc tbody tr:nth-child(even) td{ background: var(--rowEven); }
    #t-lanc tbody tr:hover td{ background:#eef4ff!important; }

    /* Permite nomes maiores em 2 linhas sem estourar */
    .td-wrap{
      white-space: normal !important;
      overflow: hidden;
      text-overflow: clip;
      line-height: 1.15;
      font-weight: 800;
      color:#0e1b3f;
    }
    .td-sub{
      display:block;
      margin-top: 2px;
      font-weight: 700;
      color:#42507a;
      font-size: .88rem;
    }

    .valor{
      font-weight: 900;
      color: var(--royal);
      white-space: nowrap;
      font-family: Orbitron, sans-serif;
      font-size: .98rem;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(219,228,255,.95);
      background:#fff;
      font-weight: 900;
      color:#1b2b5e;
      white-space: nowrap;
      max-width: 100%;
    }
    .pill .dot{
      width:10px; height:10px; border-radius:999px; background: var(--royal);
      box-shadow: 0 0 0 3px rgba(31,79,224,.12);
      flex: 0 0 auto;
    }
    .pill.ok .dot{ background: var(--ok); box-shadow: 0 0 0 3px rgba(46,139,87,.12); }
    .pill.danger .dot{ background: var(--danger); box-shadow: 0 0 0 3px rgba(226,85,102,.14); }

    .actions-cell{
      padding: 10px 6px !important;
    }
    .btn-ic{
      display:inline-flex; align-items:center; justify-content:center;
      width: 42px; height: 42px;
      border-radius: 14px;
      font-weight: 900;
      border: none;
      box-shadow: 0 10px 18px rgba(31,79,224,.10);
    }
    .btn-ic.blue{
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal2) 100%);
      color:#fff;
    }
    .btn-ic.red{
      background: #ffebee;
      border: 1px solid rgba(226,85,102,.25);
      color: var(--danger);
      box-shadow: 0 10px 18px rgba(226,85,102,.10);
    }
    .btn-ic.red:hover{ background:#ffe3e8; }
    .btn-ic.blue:hover{ filter: brightness(1.03); }

    tfoot td{
      background:#f1f5ff;
      border-top: 2px solid rgba(219,228,255,.95);
      font-weight: 900;
      color:#1b2b5e;
      padding: 12px 10px;
    }

    /* Modal */
    .modal-content{
      border-radius: 18px;
      border: 1px solid rgba(219,228,255,.95);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .modal-header{
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal2) 100%);
      color:#fff;
      border-bottom: 1px solid rgba(255,255,255,.25);
    }
    .modal-title{
      font-family: Orbitron, sans-serif;
      font-weight: 900;
      letter-spacing: .8px;
    }
    .modal-body{
      background:
        radial-gradient(900px 320px at 85% -10%, rgba(31,79,224,.10), transparent 70%),
        #fff;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }

    .box{
      background:#fff;
      border:1px solid rgba(219,228,255,.95);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 18px rgba(31,79,224,.08);
    }

    .box h6{
      font-family: Orbitron, sans-serif;
      color: var(--royal);
      letter-spacing: .6px;
      margin: 0 0 10px 0;
      font-weight: 900;
      font-size: .98rem;
    }

    .parcelas{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    .parcela{
      border:1px solid rgba(219,228,255,.95);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      box-shadow: 0 10px 16px rgba(31,79,224,.06);
      text-align:left;
      overflow:hidden;
    }
    .parcela .t{
      font-weight: 900;
      color:#1b2b5e;
      display:flex; justify-content:space-between; align-items:center;
      gap: 8px;
      font-size: .92rem;
    }
    .parcela .v{
      font: 900 1.20rem/1 Orbitron, sans-serif;
      color: var(--royal);
      margin-top: 10px;
      white-space: nowrap;
    }
    .parcela .s{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 800;
      font-size: .88rem;
      line-height: 1.25;
    }
    .parcela.paga{
      background: #f3fff7;
      border-color: rgba(46,139,87,.22);
    }
    .parcela.paga .v{ color: var(--ok); }

    .timeline{
      display:flex; flex-direction:column; gap:10px;
      max-height: 340px;
      overflow:auto;
      padding-right: 6px;
    }
    .event{
      border:1px solid rgba(219,228,255,.95);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      box-shadow: 0 10px 16px rgba(31,79,224,.06);
    }
    .event .row1{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .event .row1 .tag{
      display:inline-flex; gap:8px; align-items:center;
      font-weight: 900;
      color:#1b2b5e;
    }
    .event .row1 .tag i{ color: var(--royal); }
    .event .row2{
      display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;
      margin-top: 10px;
    }
    .event .amt{
      font-family: Orbitron, sans-serif;
      font-weight: 900;
      color: var(--royal);
      white-space: nowrap;
    }

    /* Colunas (controla largura sem scroll) */
    colgroup col.c1{ width: 120px; }  /* Data */
    colgroup col.c2{ width: 90px; }   /* OS */
    colgroup col.c3{ width: 260px; }  /* Cooperado */
    colgroup col.c4{ width: 260px; }  /* Estabelecimento */
    colgroup col.c5{ width: 120px; }  /* Compra */
    colgroup col.c6{ width: 150px; }  /* Parcela */
    colgroup col.c7{ width: 190px; }  /* Situação */
    colgroup col.c8{ width: 120px; }  /* Ações */

    @media (max-width: 1200px){
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      colgroup col.c3, colgroup col.c4{ width: 220px; }
    }
    @media (max-width: 980px){
      .stats{ grid-template-columns: 1fr; }
      .grid2{ grid-template-columns: 1fr; }
      .parcelas{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .topbar{ position: static; }
      /* Em telas pequenas é normal precisar scroll — mas você pediu sem scroll (desktop). */
    }
  </style>
</head>

<body>
  <div class="main-content">
    <div class="topbar">
      <div class="title">
        <div class="brand-badge"><i class="bi bi-journal-text"></i></div>
        <div>
          <div style="font-size:1.05rem;">Lançamentos e Descontos</div>
          <div class="subtitle">Parcelamento automático em 4x com desconto flexível</div>
        </div>
      </div>
      <div class="actions">
        <a href="{{ url_for('dashboard') }}" class="btn btn-soft">
          <i class="bi bi-arrow-left-circle"></i> Dashboard
        </a>
        <button type="button" class="btn btn-soft" id="btn-hoje">
          <i class="bi bi-sun"></i> Hoje
        </button>
      </div>
    </div>

    <!-- Métricas -->
    <div class="cardx">
      <div class="stats">
        <div class="stat">
          <div class="label"><i class="bi bi-list-ul"></i> Lançamentos</div>
          <div class="value" id="m-qtd">—</div>
          <div class="sub">Linhas visíveis</div>
        </div>
        <div class="stat">
          <div class="label"><i class="bi bi-cash-coin"></i> Total visível</div>
          <div class="value" id="m-total">—</div>
          <div class="sub">Somatório dos valores</div>
        </div>
        <div class="stat">
          <div class="label"><i class="bi bi-graph-up"></i> Ticket médio</div>
          <div class="value" id="m-media">—</div>
          <div class="sub">Média por lançamento</div>
        </div>
        <div class="stat">
          <div class="label"><i class="bi bi-credit-card-2-front"></i> Parcelas (4x)</div>
          <div class="value" id="m-parc">—</div>
          <div class="sub">Regras automáticas</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="cardx">
      <form id="form-filtros" method="get" action="{{ url_for('listar_lancamentos') }}">
        <div class="row g-3 align-items-end">
          <div class="col-xl-3 col-lg-4 col-md-6">
            <label for="cooperado_id">Cooperado</label>
            <select name="cooperado_id" id="cooperado_id" class="form-select">
              <option value="">Todos</option>
              {% for c in cooperados %}
                <option value="{{ c.id }}" {% if filtros.cooperado_id == c.id|string %}selected{% endif %}>{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-xl-3 col-lg-4 col-md-6">
            <label for="estabelecimento_id">Estabelecimento</label>
            <select name="estabelecimento_id" id="estabelecimento_id" class="form-select">
              <option value="">Todos</option>
              {% for e in estabelecimentos %}
                <option value="{{ e.id }}" {% if filtros.estabelecimento_id == e.id|string %}selected{% endif %}>{{ e.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-xl-2 col-lg-2 col-md-6">
            <label for="data_inicio">Data Início</label>
            <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ filtros.data_inicio or '' }}">
          </div>

          <div class="col-xl-2 col-lg-2 col-md-6">
            <label for="data_fim">Data Fim</label>
            <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ filtros.data_fim or '' }}">
          </div>

          <div class="col-xl-2 col-lg-12">
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> Filtrar
              </button>
            </div>
          </div>

          <div class="col-xl-2 col-lg-6 col-md-6">
            <div class="d-grid">
              <button type="button" class="btn btn-success" onclick="exportarExcel()">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
              </button>
            </div>
          </div>

          <div class="col-xl-2 col-lg-6 col-md-6">
            <div class="d-grid">
              <button type="button" class="btn btn-outline-light" id="btn-limpar">
                <i class="bi bi-x-circle"></i> Limpar
              </button>
            </div>
          </div>
        </div>

        <div class="chips" id="chips-filtros"></div>
        <div class="hint mt-2">
          Dica: clique no botão azul (cartão) para registrar descontos com data e editar quando quiser.
        </div>
      </form>
    </div>

    <!-- Tabela -->
    <div class="cardx">
      <div class="table-wrap">
        <table class="align-middle" id="t-lanc">
          <colgroup>
            <col class="c1"><col class="c2"><col class="c3"><col class="c4"><col class="c5"><col class="c6"><col class="c7"><col class="c8">
          </colgroup>
          <thead>
            <tr>
              <th><i class="bi bi-calendar-event"></i> Data</th>
              <th><i class="bi bi-file-earmark-text"></i> Nº OS</th>
              <th><i class="bi bi-person"></i> Cooperado</th>
              <th><i class="bi bi-shop"></i> Estabelecimento</th>
              <th><i class="bi bi-currency-dollar"></i> Compra</th>
              <th><i class="bi bi-collection"></i> Parcela (4x)</th>
              <th><i class="bi bi-clipboard-check"></i> Situação</th>
              <th><i class="bi bi-sliders2"></i> Ações</th>
            </tr>
          </thead>

          <tbody>
            {% if lancamentos %}
              {% for l in lancamentos %}
                <tr class="l-row"
                    data-id="{{ l.id }}"
                    data-data="{{ l.data.strftime('%Y-%m-%dT%H:%M:%S') }}"
                    data-valor="{{ '%.2f'|format(l.valor) }}"
                    data-os="{{ l.os_numero }}"
                    data-coop="{{ l.cooperado.nome }}"
                    data-estab="{{ l.estabelecimento.nome }}"
                    data-desc="{{ (l.descricao or '')|e }}"
                    data-historico='{{ (l.historico_descontos_json or "[]")|safe }}'>
                  <td>
                    <span style="font-weight:900">{{ l.data.strftime('%d/%m/%Y') }}</span>
                    <span class="td-sub">{{ l.data.strftime('%H:%M') }}</span>
                  </td>
                  <td class="fw-bold">{{ l.os_numero }}</td>
                  <td class="td-wrap">{{ l.cooperado.nome }}</td>
                  <td class="td-wrap">{{ l.estabelecimento.nome }}</td>
                  <td class="valor">{{ "{:,.2f}".format(l.valor) }}</td>
                  <td>
                    <span class="pill"><span class="dot"></span><span class="vparc">—</span></span>
                  </td>
                  <td>
                    <span class="pill danger"><span class="dot"></span><span class="sit">Pendente</span></span>
                  </td>
                  <td class="actions-cell">
                    <div class="d-flex gap-2 justify-content-center">
                      <button type="button" class="btn-ic blue" title="Descontar / Parcelas" onclick="abrirParcelas({{ l.id }})">
                        <i class="bi bi-credit-card-2-front"></i>
                      </button>

                      <form method="post"
                            action="{{ url_for('excluir_lancamento', id=l.id) }}"
                            onsubmit="return confirm('Excluir este lançamento? Essa ação não pode ser desfeita.');">
                        <input type="hidden" name="next" value="{{ request.full_path }}">
                        <button type="submit" class="btn-ic red" title="Excluir">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="8" style="padding:16px">Nenhum lançamento encontrado.</td></tr>
            {% endif %}
          </tbody>

          <tfoot>
            <tr>
              <td colspan="4" class="text-end">Totais (visíveis):</td>
              <td id="tf-total" class="valor">—</td>
              <td colspan="3" id="tf-qtd" class="text-start">— itens</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Parcelas / Descontos -->
  <div class="modal fade" id="modalParcelas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="mp-title">Parcelas e Descontos</div>
            <div style="opacity:.92;font-weight:800" id="mp-sub">—</div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <div class="grid2">
            <div class="box">
              <h6><i class="bi bi-collection"></i> Parcelamento em 4x (com acúmulo automático)</h6>
              <div class="parcelas" id="mp-parcelas"></div>
              <div class="hint mt-3">
                Regra: se você descontar <strong>menos</strong> que a parcela, o restante <strong>vai para a próxima</strong>.
              </div>
            </div>

            <div class="box">
              <h6><i class="bi bi-calendar2-check"></i> Registrar desconto com data</h6>

              <div class="row g-2 align-items-end">
                <div class="col-md-6">
                  <label>Data do desconto</label>
                  <input type="date" class="form-control" id="mp-date">
                </div>
                <div class="col-md-6">
                  <label>Valor descontado (R$)</label>
                  <input type="text" class="form-control" id="mp-valor" placeholder="Ex.: 20,00">
                </div>
                <div class="col-12 d-grid mt-1">
                  <button type="button" class="btn btn-primary" id="mp-add">
                    <i class="bi bi-plus-circle"></i> Registrar desconto
                  </button>
                </div>
              </div>

              <div class="mt-3">
                <div class="d-flex align-items-center justify-content-between">
                  <h6 class="m-0"><i class="bi bi-clock-history"></i> Histórico (editável)</h6>
                </div>
                <div class="hint mt-1">Você pode editar a data e o valor de qualquer desconto.</div>
                <div class="timeline mt-2" id="mp-timeline"></div>
              </div>

              <div class="hint mt-3">
                Observação: se você ainda não salvou no banco, os descontos ficam no navegador até você integrar a API.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Utilitários
    // =========================
    const brl = v => v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    const to2 = n => (Math.round((n + Number.EPSILON)*100)/100);

    function onlyDigitsAndCommaDot(s){
      return String(s||'').replace(/[^\d,.-]/g,'').trim();
    }

    function parseBRL(input){
      const s = onlyDigitsAndCommaDot(input);
      if(!s) return NaN;
      const norm = s.includes(',') ? s.replace(/\./g,'').replace(',', '.') : s;
      const n = parseFloat(norm);
      return isNaN(n) ? NaN : to2(n);
    }

    function formatBRInput(n){
      if(isNaN(n)) return '';
      return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function localISODate(d=new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // =========================
    // Armazenamento local (silencioso)
    // =========================
    function keyDescontos(id){ return `coopex_descontos_${id}`; }

    function getHistorico(row){
      const id = row.dataset.id;

      // 1) localStorage (se existir)
      const ls = localStorage.getItem(keyDescontos(id));
      if (ls){
        try { return JSON.parse(ls) || []; } catch(e){ /* ignore */ }
      }

      // 2) back-end (se vier no data-historico)
      try{
        const raw = row.dataset.historico || '[]';
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function setHistorico(id, hist){
      localStorage.setItem(keyDescontos(id), JSON.stringify(hist || []));
    }

    // =========================
    // Motor de parcelas (4x) com acúmulo
    // =========================
    function calcularParcelas(total, descontos){
      total = to2(total);
      const base = to2(total / 4);

      const ds = (descontos || [])
        .map((d, idx)=>({
          id: d.id ?? `tmp_${idx}`,
          data: String(d.data || '').slice(0,10),
          valor: to2(parseFloat(d.valor) || 0),
          idx
        }))
        .filter(d => d.valor > 0 && d.data);

      ds.sort((a,b)=>{
        if(a.data < b.data) return -1;
        if(a.data > b.data) return 1;
        return a.idx - b.idx;
      });

      let pagoTotal = 0;
      ds.forEach(d => pagoTotal = to2(pagoTotal + d.valor));
      if(pagoTotal > total) pagoTotal = total;

      const parcelas = [];
      let restante = total;
      let carry = 0;
      let pagoDistribuir = pagoTotal;

      for(let i=1;i<=4;i++){
        let sugerida = to2(base + carry);
        if (sugerida < 0) sugerida = 0;
        if (sugerida > restante) sugerida = restante;

        const pagoNesta = to2(Math.min(pagoDistribuir, sugerida));
        pagoDistribuir = to2(pagoDistribuir - pagoNesta);

        const faltou = to2(sugerida - pagoNesta);
        carry = to2(faltou);

        restante = to2(restante - sugerida);

        parcelas.push({
          n: i, base, sugerida,
          pago: pagoNesta,
          faltou,
          status: (faltou <= 0.0001) ? 'paga' : 'pendente'
        });
      }

      const saldo = to2(total - pagoTotal);
      return { total, base, pagoTotal, saldo, parcelas, descontosOrdenados: ds };
    }

    // =========================
    // UI: métricas e chips
    // =========================
    function atualizarMetricasTabela(){
      const rows = [...document.querySelectorAll('#t-lanc tbody tr.l-row')]
        .filter(tr => tr.style.display !== 'none');

      let soma = 0, qtd = 0;
      rows.forEach(tr=>{
        const v = parseFloat(tr.dataset.valor || '0') || 0;
        soma = to2(soma + v);
        qtd++;
      });

      const media = qtd ? to2(soma / qtd) : 0;

      document.getElementById('m-qtd').textContent = qtd.toLocaleString('pt-BR');
      document.getElementById('m-total').textContent = brl(soma);
      document.getElementById('m-media').textContent = brl(media);
      document.getElementById('m-parc').textContent = '4x automático';

      document.getElementById('tf-total').textContent = brl(soma);
      document.getElementById('tf-qtd').textContent = `${qtd.toLocaleString('pt-BR')} itens`;
    }

    function atualizarChips(){
      const chips = document.getElementById('chips-filtros');
      chips.innerHTML = '';

      const coopSel  = document.getElementById('cooperado_id');
      const estabSel = document.getElementById('estabelecimento_id');
      const di = document.getElementById('data_inicio').value;
      const df = document.getElementById('data_fim').value;

      const add = (icon, txt) => {
        const b = document.createElement('span');
        b.className = 'chip';
        b.innerHTML = `<i class="bi ${icon}"></i> ${txt}`;
        chips.appendChild(b);
      };

      if (coopSel.value)  add('bi-person', coopSel.options[coopSel.selectedIndex].text);
      if (estabSel.value) add('bi-shop', estabSel.options[estabSel.selectedIndex].text);
      if (di) add('bi-calendar-plus', `Início: ${new Date(di+'T00:00:00').toLocaleDateString('pt-BR')}`);
      if (df) add('bi-calendar-minus', `Fim: ${new Date(df+'T00:00:00').toLocaleDateString('pt-BR')}`);
    }

    // Default mês atual sem loop / sumir
    (function defaultMesAtualGuard(){
      const hasDI = "{{ filtros.data_inicio or '' }}";
      const hasDF = "{{ filtros.data_fim or '' }}";
      if (!hasDI && !hasDF){
        const guardKey = 'coopex_default_mes_atual_aplicado';
        if (sessionStorage.getItem(guardKey) === '1') return;
        sessionStorage.setItem(guardKey, '1');

        const now = new Date();
        const first = new Date(now.getFullYear(), now.getMonth(), 1);
        const url = new URL(window.location.href);
        url.searchParams.set('data_inicio', localISODate(first));
        url.searchParams.set('data_fim', localISODate(now));
        window.location.replace(url.toString());
      }else{
        sessionStorage.removeItem('coopex_default_mes_atual_aplicado');
      }
    })();

    // =========================
    // Preenche "Parcela" e "Situação"
    // =========================
    function atualizarLinhaParcelas(tr){
      const total = parseFloat(tr.dataset.valor || '0') || 0;
      const hist = getHistorico(tr);
      const calc = calcularParcelas(total, hist);

      const primeiraPendente = calc.parcelas.find(p => p.status !== 'paga') || calc.parcelas[3];
      const sug = primeiraPendente ? primeiraPendente.sugerida : calc.parcelas[3].sugerida;

      tr.querySelector('.vparc').textContent = brl(sug);

      const sitEl = tr.querySelector('.sit');
      const pill = sitEl?.closest('.pill');
      const ok = calc.saldo <= 0.0001;

      if (ok){
        sitEl.textContent = 'Quitado';
        pill.classList.remove('danger');
        pill.classList.add('ok');
      }else{
        sitEl.textContent = `Total ${brl(calc.saldo)}`;
        pill.classList.remove('ok');
        pill.classList.add('danger');
      }
    }

    function atualizarTodasLinhas(){
      document.querySelectorAll('#t-lanc tbody tr.l-row').forEach(tr => atualizarLinhaParcelas(tr));
      atualizarMetricasTabela();
      atualizarChips();
    }

    // =========================
    // Modal
    // =========================
    let modal;
    let currentId = null;

    function getRowById(id){
      return document.querySelector(`#t-lanc tbody tr.l-row[data-id="${id}"]`);
    }

    function renderParcelas(calc){
      const wrap = document.getElementById('mp-parcelas');
      wrap.innerHTML = '';
      calc.parcelas.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'parcela ' + (p.status === 'paga' ? 'paga' : '');
        div.innerHTML = `
          <div class="t">
            <span>Parcela ${p.n}</span>
            <span class="pill ${p.status==='paga'?'ok':'danger'}" style="padding:4px 8px;font-size:.82rem">
              <span class="dot"></span>${p.status==='paga'?'Paga':'Pendente'}
            </span>
          </div>
          <div class="v">${brl(p.sugerida)}</div>
          <div class="s">Base: ${brl(p.base)} • Pago: ${brl(p.pago)} • Falta: ${brl(p.faltou)}</div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderTimeline(hist){
      const tl = document.getElementById('mp-timeline');
      tl.innerHTML = '';
      if (!hist.length){
        const empty = document.createElement('div');
        empty.className = 'event';
        empty.innerHTML = `<div class="hint">Nenhum desconto registrado ainda.</div>`;
        tl.appendChild(empty);
        return;
      }

      hist.forEach((d, idx)=>{
        const ev = document.createElement('div');
        ev.className = 'event';
        ev.innerHTML = `
          <div class="row1">
            <span class="tag"><i class="bi bi-calendar2-check"></i> Desconto #${idx+1}</span>
            <span class="amt">${brl(parseFloat(d.valor)||0)}</span>
          </div>
          <div class="row2">
            <div style="min-width:220px">
              <label class="mb-1" style="font-size:.88rem">Data</label>
              <input type="date" class="form-control form-control-sm" value="${(d.data||'').slice(0,10)}" data-edit-date="${idx}">
            </div>
            <div style="min-width:220px">
              <label class="mb-1" style="font-size:.88rem">Valor</label>
              <input type="text" class="form-control form-control-sm" value="${formatBRInput(parseFloat(d.valor)||0)}" data-edit-valor="${idx}">
            </div>
            <div class="d-flex align-items-end gap-2">
              <button type="button" class="btn btn-primary btn-sm" data-save="${idx}">
                <i class="bi bi-check2-circle"></i> Salvar
              </button>
              <button type="button" class="btn btn-outline-light btn-sm" data-del="${idx}">
                <i class="bi bi-trash3"></i> Remover
              </button>
            </div>
          </div>
        `;
        tl.appendChild(ev);
      });

      tl.querySelectorAll('button[data-save]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.getAttribute('data-save'), 10);
          salvarEdicao(i);
        });
      });
      tl.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.getAttribute('data-del'), 10);
          removerDesconto(i);
        });
      });
    }

    function abrirParcelas(id){
      currentId = String(id);
      const tr = getRowById(currentId);
      if(!tr) return;

      const total = parseFloat(tr.dataset.valor || '0') || 0;
      const hist = getHistorico(tr);

      document.getElementById('mp-title').textContent = `Parcelas e Descontos • OS ${tr.dataset.os}`;
      document.getElementById('mp-sub').textContent = `${tr.dataset.coop} • ${tr.dataset.estab} • Compra ${brl(total)}`;

      document.getElementById('mp-date').value = localISODate(new Date());
      document.getElementById('mp-valor').value = '';

      const calc = calcularParcelas(total, hist);
      renderParcelas(calc);
      renderTimeline(hist);

      modal.show();
    }
    window.abrirParcelas = abrirParcelas;

    function refreshModal(){
      const tr = getRowById(currentId);
      if(!tr) return;
      const total = parseFloat(tr.dataset.valor || '0') || 0;
      const hist = getHistorico(tr);
      const calc = calcularParcelas(total, hist);
      renderParcelas(calc);
      renderTimeline(hist);
      atualizarLinhaParcelas(tr);
      atualizarMetricasTabela();
    }

    function adicionarDesconto(){
      const tr = getRowById(currentId);
      if(!tr) return;

      const date = (document.getElementById('mp-date').value || '').slice(0,10);
      const val = parseBRL(document.getElementById('mp-valor').value);

      if(!date){
        alert('Informe a data do desconto.');
        return;
      }
      if(isNaN(val) || val <= 0){
        alert('Informe um valor válido para o desconto.');
        return;
      }

      const hist = getHistorico(tr);
      hist.push({ data: date, valor: to2(val) });
      setHistorico(currentId, hist);

      // Ideal: salvar no banco via endpoint (quando você tiver a API)
      // fetch(`/api/lancamentos/${currentId}/descontos`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({data:date, valor:val}) })

      refreshModal();
      document.getElementById('mp-valor').value = '';
    }

    function salvarEdicao(idx){
      const tr = getRowById(currentId);
      if(!tr) return;

      const hist = getHistorico(tr);
      const dateInput = document.querySelector(`[data-edit-date="${idx}"]`);
      const valInput  = document.querySelector(`[data-edit-valor="${idx}"]`);
      if(!dateInput || !valInput) return;

      const date = (dateInput.value || '').slice(0,10);
      const val  = parseBRL(valInput.value);

      if(!date){
        alert('Informe a data do desconto.');
        return;
      }
      if(isNaN(val) || val <= 0){
        alert('Informe um valor válido.');
        return;
      }

      hist[idx] = { ...hist[idx], data: date, valor: to2(val) };
      setHistorico(currentId, hist);

      // Ideal: atualizar no banco
      // fetch(`/api/descontos/${hist[idx].id}`, { method:'PUT', ... })

      refreshModal();
    }

    function removerDesconto(idx){
      const tr = getRowById(currentId);
      if(!tr) return;

      const hist = getHistorico(tr);
      hist.splice(idx, 1);
      setHistorico(currentId, hist);

      // Ideal: remover do banco
      // fetch(`/api/descontos/${id}`, { method:'DELETE' })

      refreshModal();
    }

    // =========================
    // Botões gerais
    // =========================
    function exportarExcel(){
      const params = new URLSearchParams({
        cooperado_id: document.getElementById('cooperado_id').value || '',
        estabelecimento_id: document.getElementById('estabelecimento_id').value || '',
        data_inicio: document.getElementById('data_inicio').value || '',
        data_fim: document.getElementById('data_fim').value || ''
      });
      window.location.href = "{{ url_for('exportar_lancamentos') }}?" + params.toString();
    }
    window.exportarExcel = exportarExcel;

    document.getElementById('btn-limpar')?.addEventListener('click', ()=>{
      window.location.href = "{{ url_for('listar_lancamentos') }}";
    });

    document.getElementById('btn-hoje')?.addEventListener('click', ()=>{
      const d = localISODate(new Date());
      document.getElementById('data_inicio').value = d;
      document.getElementById('data_fim').value = d;
      document.getElementById('form-filtros').submit();
    });

    // =========================
    // Init
    // =========================
    document.addEventListener('DOMContentLoaded', ()=>{
      modal = new bootstrap.Modal(document.getElementById('modalParcelas'));
      document.getElementById('mp-add').addEventListener('click', adicionarDesconto);
      atualizarTodasLinhas();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
