<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Painel do Cooperado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --royal:#4169E1;
      --royal-700:#2348C8;
      --royal-50:#F3F6FF;

      --ink:#0B1220;
      --muted:#667085;
      --line:#E6ECFF;

      --ok:#10B981;
      --danger:#EF4444;

      --bg:#FFFFFF;
      --bg-soft:#F4F7FF;

      --r-xl:22px;
      --r-lg:18px;
      --r-md:14px;

      --shadow: 0 14px 38px rgba(15,23,42,.10);
      --shadow2: 0 18px 46px rgba(65,105,225,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(65,105,225,.14), transparent 62%),
        radial-gradient(900px 520px at 90% 18%, rgba(59,130,246,.10), transparent 62%),
        radial-gradient(900px 520px at 20% 112%, rgba(99,102,241,.10), transparent 62%),
        #EEF2FF;
      -webkit-font-smoothing: antialiased;
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      min-height: 100svh;
      min-height: 100dvh;
    }

    /* TOP */
    .top{
      position: sticky;
      top: 0;
      z-index: 60;
      padding: 14px 14px 12px 14px;
      background: linear-gradient(135deg,#0B1220 0%, #152C7A 48%, #0B1220 100%);
      border-bottom-left-radius: 22px;
      border-bottom-right-radius: 22px;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .top::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(480px 240px at 12% 0%, rgba(65,105,225,.55), transparent 60%),
        radial-gradient(480px 240px at 90% 0%, rgba(14,165,233,.35), transparent 60%);
      pointer-events:none;
    }

    .top-row{
      position:relative;
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .avatar{
      width: 48px;
      height: 48px;
      border-radius: 999px;
      padding: 2px;
      background: conic-gradient(from 180deg, #60A5FA, #A78BFA, #34D399, #60A5FA);
      box-shadow: 0 0 0 2px rgba(255,255,255,.20);
      flex:0 0 auto;
    }
    .avatar img{
      width:100%;
      height:100%;
      border-radius:999px;
      object-fit:cover;
      display:block;
      border: 2px solid rgba(11,18,32,.85);
      background:#0B1220;
    }

    .who{
      min-width:0;
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .who .name{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .who .user{
      margin:0;
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .role{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      color:#fff;
      font-size: 11px;
      font-weight: 900;
      width: fit-content;
      margin-top: 2px;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .logout{
      height: 42px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.14);
      color:#fff;
      text-decoration:none;
      font-size: 12px;
      font-weight: 900;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
    }

    /* SWITCHER */
    .switcher{
      position:relative;
      margin-top: 10px;
      display:flex;
      gap:10px;
      padding: 0 14px 2px 14px;
    }
    .sw{
      flex:1;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
    }
    .sw.active{
      background: #fff;
      color: var(--royal-700);
      border-color: rgba(255,255,255,.40);
      box-shadow: 0 10px 24px rgba(0,0,0,.14);
    }
    .sw .i{
      width: 28px; height: 28px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      font-size: 14px;
    }
    .sw.active .i{
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      border: 0;
      color:#fff;
    }

    /* CONTENT */
    .content{
      padding: 12px 12px 18px 12px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }

    .page{display:block;}
    .hidden{display:none;}
    .fade{animation:fade .16s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @media (prefers-reduced-motion: reduce){ .fade{animation:none} }

    /* Card base */
    .card{
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(255,255,255,.70);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .section{ padding: 14px; }
    .head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap:wrap;
    }
    .title{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: var(--ink);
    }
    .sub{
      margin:4px 0 0 0;
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      font-size: 11px;
      font-weight: 900;
      white-space:nowrap;
    }

    /* STORIES */
    .stories-wrap{
      padding: 12px 12px 12px 12px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.60);
      border-radius: var(--r-xl);
      box-shadow: 0 12px 30px rgba(15,23,42,.06);
      backdrop-filter: blur(14px);
    }
    .stories-row{
      display:flex;
      gap: 10px;
      overflow-x:auto;
      padding: 2px 2px 4px 2px;
      scrollbar-width: thin;
    }
    .stories-row::-webkit-scrollbar{height:5px}
    .stories-row::-webkit-scrollbar-thumb{background: rgba(11,18,32,.25);border-radius:999px}

    .story{
      border:0;
      background:transparent;
      padding:0;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      min-width: 78px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .ring{
      width: 66px;
      height: 66px;
      border-radius: 999px;
      padding: 2px;
      background: conic-gradient(from 140deg, #60A5FA, #A78BFA, #34D399, #60A5FA);
      box-shadow: 0 12px 28px rgba(15,23,42,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .inner{
      width:100%;
      height:100%;
      border-radius:999px;
      background:#0B1220;
      overflow:hidden;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:900;
      font-size: 22px;
    }
    .inner img{width:100%;height:100%;object-fit:cover;display:block}
    .sname{
      font-size: 11px;
      font-weight: 900;
      color: var(--ink);
      max-width: 96px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }
    .smeta{
      font-size: 10px;
      font-weight: 900;
      color: #64748B;
    }

    /* STATS */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .stat{
      padding: 14px;
      border-radius: var(--r-xl);
      border: 1px solid rgba(255,255,255,.70);
      background: rgba(255,255,255,.94);
      box-shadow: 0 12px 30px rgba(15,23,42,.06);
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .stat .k{
      margin:0 0 8px 0;
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#334155;
      opacity:.86;
    }
    .stat .v{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:.01em;
      color: var(--ink);
    }
    .stat .v.ok{ color: var(--ok); }
    .stat .h{
      margin:6px 0 0 0;
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
    }
    .stat .chip{
      position:absolute;
      right: 12px;
      top: 12px;
      width: 30px;
      height: 30px;
      border-radius: 12px;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
    }

    /* FILTRO */
    .filter-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .filter-pill{
      flex:1;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-weight: 900;
      font-size: 12px;
      color: var(--ink);
      min-width:0;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .filter-pill span{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .filter-pill .mini{
      font-size: 11px;
      font-weight: 900;
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      flex:0 0 auto;
    }

    /* LAN√áAMENTOS AGRUPADOS (accordion) */
    .groups{ display:flex; flex-direction:column; gap: 10px; }

    details.group{
      border: 1px solid var(--line);
      background:#fff;
      border-radius: var(--r-xl);
      overflow:hidden;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
    }
    details.group summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    details.group summary::-webkit-details-marker{display:none}

    .g-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
      flex: 1 1 auto;
    }
    .g-badge{
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      box-shadow: 0 12px 26px rgba(65,105,225,.18);
      flex:0 0 auto;
    }
    .g-name{
      min-width:0;
      flex: 1 1 auto;
    }
    .g-name b{
      display:block;
      font-size: 12.5px; /* menor pra n√£o ‚Äúencostar‚Äù na figurinha */
      font-weight: 900;
      color: var(--ink);
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }
    .g-name small{
      display:block;
      margin-top:3px;
      font-size: 10.5px;
      font-weight: 900;
      color: #64748B;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }
    .g-right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex:0 0 auto;
    }
    .g-total{
      font-size: 11px;
      font-weight: 900;
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
      padding: 7px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .g-arrow{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: #F3F4F6;
      border: 1px solid #E5E7EB;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: #111827;
      transition: transform .15s ease;
    }
    details.group[open] .g-arrow{ transform: rotate(180deg); }

    .g-body{
      border-top: 1px solid var(--line);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .post{
      border: 1px solid var(--line);
      background: #fff;
      border-radius: var(--r-lg);
      padding: 10px 10px;
      box-shadow: 0 8px 18px rgba(15,23,42,.05);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
    }
    .p-left{min-width:0;flex:1}
    .p-top{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width:0;
      flex-wrap:wrap;
    }
    .p-os{
      font-size: 11px;
      font-weight: 900;
      color:#64748B;
      background:#F1F5FF;
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .p-when{
      font-size: 11px;
      font-weight: 900;
      color:#0B1220;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .p-desc{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 700;
      color:#334155;
      line-height: 1.35;
      word-break: break-word;
    }

    /* Valor com ‚Äúpiloto‚Äù + cores */
    .amount{
      position:relative;
      font-size: 12px;
      font-weight: 900;
      padding: 8px 12px 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--royal-50);
      color: var(--royal-700);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .amount::before{
      content:"";
      position:absolute;
      left: 6px;
      top: 7px;
      bottom: 7px;
      width: 5px;
      border-radius: 999px;
      background: currentColor;
      opacity:.75;
    }
    .amount.mid{
      background: #F3F4F6;
      border-color: #E5E7EB;
      color: #334155;
    }
    .amount.old{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.25);
      color: var(--danger);
    }
    .amount.current{
      background: rgba(65,105,225,.12);
      border-color: rgba(65,105,225,.25);
      color: var(--royal-700);
    }

    .empty{
      padding: 14px;
      text-align:center;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      border: 1px dashed var(--line);
      border-radius: var(--r-xl);
      background: rgba(255,255,255,.70);
    }

    /* CAT√ÅLOGOS */
    .searchbox{
      display:flex;
      align-items:center;
      gap: 10px;
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
    }
    .searchbox .sicon{font-size:16px}
    .searchbox input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      font-size: 14px;
      font-weight: 900;
      color: var(--ink);
      min-width:0;
    }
    .searchmeta{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
    }
    .clear{
      border:0;
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      font-weight: 900;
      display:none;
      white-space:nowrap;
    }

    .catalog-list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .shop{
      border-radius: var(--r-xl);
      border: 1px solid rgba(255,255,255,.70);
      background: rgba(255,255,255,.94);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .shop-head{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid var(--line);
      min-width:0;
    }
    .shop-logo{
      width: 44px;height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight: 900;
      position:relative;
      overflow:hidden;
      flex:0 0 auto;
      box-shadow: 0 12px 26px rgba(65,105,225,.18);
    }
    .shop-logo img{width:100%;height:100%;object-fit:cover;display:block}
    .shop-info{min-width:0;flex:1}
    .shop-name{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      color: var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .shop-count{
      margin-top:4px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      font-size: 11px;
      font-weight: 900;
      white-space:nowrap;
      width: fit-content;
    }

    .items{
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .item{
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(15,23,42,.05);
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 6px 10px;
      min-width:0;
    }
    .iname{
      font-size: 12px;
      font-weight: 900;
      color: var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .iprice{
      font-size: 12px;
      font-weight: 900;
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
      padding: 7px 10px;
      border-radius: 999px;
      white-space:nowrap;
      text-align:right;
      position:relative;
    }
    .iprice::before{
      content:"";
      position:absolute;
      left: 6px;
      top: 7px;
      bottom: 7px;
      width: 5px;
      border-radius: 999px;
      background: var(--royal-700);
      opacity:.65;
    }
    .imeta{
      grid-column: 1 / -1;
      font-size: 11px;
      font-weight: 800;
      color: #64748B;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .inote{
      grid-column: 1 / -1;
      font-size: 11px;
      font-weight: 700;
      color: #334155;
      line-height: 1.35;
      word-break: break-word;
    }

    /* SHEET FILTROS */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      z-index: 90;
    }
    .overlay.show{display:block;}
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-110%;
      z-index: 100;
      transition: bottom .22s ease;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .sheet.open{ bottom: 0; }
    .sheet-inner{
      max-width: 520px;
      margin: 0 auto;
      background:#fff;
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border: 1px solid var(--line);
      box-shadow: 0 -18px 46px rgba(15,23,42,.22);
      overflow:hidden;
    }
    .drag{
      width: 48px;height:5px;border-radius:999px;background:#E5E7EB;
      margin: 10px auto 6px auto;
    }
    .sheet-head{
      padding: 6px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sheet-head h4{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: var(--ink);
    }
    .xbtn{
      border:0;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheet-body{
      padding: 0 14px 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size: 11px;font-weight: 900;color:#334155}
    input[type="date"]{
      height:44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background:#fff;
      padding: 10px 12px;
      font-weight: 800;
      color: var(--ink);
      min-width:0;
    }
    .actions{
      grid-column: 1 / -1;
      display:flex;
      gap: 10px;
    }
    .btn{
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background:#fff;
      font-weight: 900;
      cursor:pointer;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color: var(--ink);
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      border:0;
      color:#fff;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      box-shadow: 0 12px 26px rgba(65,105,225,.22);
    }
    .btn.ghost{
      color: var(--royal-700);
      background: var(--royal-50);
    }

    /* STORY MODAL */
    .story-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.96);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
    }
    .story-modal.open{display:flex;}
    .story-frame{
      width:100%;
      height:100svh;
      height:100dvh;
      max-width: 520px;
      background:#000;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .story-progress{
      position:absolute;
      left:0; right:0; top:0;
      display:flex;
      gap:4px;
      padding: 10px 10px 0 10px;
      z-index: 3;
    }
    .seg{flex:1;height:3px;border-radius:999px;background:rgba(255,255,255,.22);overflow:hidden}
    .fill{width:0%;height:100%;background:#fff}

    .story-head{
      z-index:2;
      padding: 18px 12px 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      color:#fff;
      min-width:0;
    }
    .sdot{
      width: 34px;height:34px;border-radius: 14px;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      display:flex;align-items:center;justify-content:center;
      font-weight: 900;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .stitle{min-width:0;flex:1}
    .stitle h5{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stitle span{font-size: 11px;font-weight: 800;color: rgba(255,255,255,.70)}
    .sclose{
      border:0;
      cursor:pointer;
      width: 40px;height:40px;border-radius:999px;
      background: rgba(255,255,255,.10);
      color:#fff;
      font-size: 22px;
      font-weight: 900;
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }

    .story-body{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .story-body img,
    .story-body video{
      width:100%;
      height:100%;
      object-fit:contain;
      background:#000;
      display:block;
    }
    .touch{
      position:absolute; inset:0;
      display:flex;
      z-index:4;
    }
    .zone{flex:1;}

    .story-caption{
      padding: 10px 12px 16px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to top, rgba(0,0,0,.78), rgba(0,0,0,.45));
      display:flex;
      gap: 10px;
      align-items:flex-start;
      color:#fff;
    }
    .cap{
      flex:1;
      font-size: 12px;
      font-weight: 700;
      white-space: pre-line;
      min-height: 24px;
    }
    .like{
      min-width: 110px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 6px;
    }
    .likebtn{
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.70);
      background:transparent;
      color:#fff;
      font-size: 11px;
      font-weight: 900;
      padding: 7px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .likebtn.liked{
      background:#fff;
      color:#0B1220;
    }
    .likestats{
      font-size: 10px;
      font-weight: 800;
      color: rgba(255,255,255,.70);
      text-align:right;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOP -->
    <header class="top">
      <div class="top-row">
        <div class="avatar">
          <img class="avatar-img" src="{{ url_for('foto_cooperado', id=coop.id) }}"
               alt="foto do cooperado" onerror="this.style.visibility='hidden'">
        </div>

        <div class="who">
          <p class="name">Ol√°, {{ coop.nome }}</p>
          <p class="user">@{{ coop.username }}</p>
          <div class="role">üõµ Cooperado Coopex</div>
        </div>

        <div class="top-actions">
          <a class="logout" href="{{ url_for('logout') }}">üö™ <span>Sair</span></a>
        </div>
      </div>

      <!-- Switcher -->
      <div class="switcher" role="tablist" aria-label="Navega√ß√£o">
        <button class="sw active" type="button" data-target="home-section" role="tab" aria-selected="true">
          <span class="i">üè†</span> In√≠cio
        </button>
        <button class="sw" type="button" data-target="catalogos-section" role="tab" aria-selected="false">
          <span class="i">üìö</span> Cat√°logos
        </button>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="content">

      <!-- IN√çCIO -->
      <section id="home-section" class="page">

        <!-- Stories -->
        <div class="stories-wrap" style="margin-bottom:12px;">
          <div class="head" style="margin-bottom:10px;">
            <div>
              <h3 class="title" style="margin-bottom:0;">Stories</h3>
              <p class="sub" style="margin-top:4px;">Promo√ß√µes e recados r√°pidos dos parceiros.</p>
            </div>
            <span class="badge">‚ö° Ao vivo</span>
          </div>

          {% if stories_ativos_coop and estab_por_id %}
            <div class="stories-row" aria-label="Stories de estabelecimentos">
              {% for est_id, est in estab_por_id.items() %}
                {% set est_stories = stories_ativos_coop | selectattr('estabelecimento_id','equalto', est_id) | list %}
                {% if est_stories %}
                  <button
                    type="button"
                    class="story"
                    data-est-id="{{ est_id }}"
                    data-est-nome="{{ est.nome }}"
                  >
                    <div class="ring">
                      <div class="inner">
                        {% if est.id %}
                          <img src="{{ url_for('logo_estabelecimento', id=est.id) }}" alt="{{ est.nome }}" onerror="this.style.display='none'">
                        {% endif %}
                        <span style="position:absolute;">{{ est.nome[:2].upper() }}</span>
                      </div>
                    </div>
                    <div class="sname" title="{{ est.nome }}">{{ est.nome }}</div>
                    <div class="smeta">{{ est_stories|length }} story{{ 'ies' if est_stories|length>1 else '' }}</div>
                  </button>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="empty">Ainda n√£o h√° stories ativos dos estabelecimentos que lan√ßam em seu nome.</div>
          {% endif %}
        </div>

        <!-- Stats (m√™s atual + m√™s anterior ficam no feed; total do m√™s √© s√≥ do m√™s atual) -->
        <div class="stats" style="margin-bottom:12px;">
          <div class="stat">
            <div class="chip">üí≥</div>
            <p class="k">Cr√©dito dispon√≠vel</p>
            <p class="v ok">R$ {{ '%.2f'|format(coop.credito or 0) }}</p>
            {% if coop.credito_atualizado_em %}
              <p class="h">√öltimo ajuste: {{ coop.credito_atualizado_em.strftime('%d/%m/%Y %H:%M') }}</p>
            {% else %}
              <p class="h">Sem ajustes manuais.</p>
            {% endif %}
          </div>

          <div class="stat">
            <div class="chip">üìÜ</div>
            <p class="k">Total do m√™s (atual)</p>
            <p class="v" id="monthTotal">R$ 0,00</p>
            <p class="h"><span id="monthCount">0</span> lan√ßamento(s) no m√™s atual</p>
          </div>
        </div>

        <!-- √öNICO local de filtro -->
        <div class="filter-bar" style="margin-bottom:12px;">
          <button class="filter-pill" id="openFiltersMid" type="button">
            <span>Filtrar lan√ßamentos por data</span>
            <span class="mini">Abrir</span>
          </button>
        </div>

        <!-- Lan√ßamentos agrupados -->
        <section class="card section">
          <div class="head">
            <div>
              <h3 class="title">Lan√ßamentos por estabelecimento</h3>
              <p class="sub">Mostrando apenas m√™s atual + m√™s anterior (2 meses).</p>
            </div>
            <span class="badge">üßæ 2 meses</span>
          </div>

          <div id="groups" class="groups"></div>
          <div id="launchEmpty" class="empty" style="display:none;">
            Nenhum lan√ßamento encontrado para o m√™s atual e o m√™s anterior.
          </div>

          <!-- Render bruto (JS filtra p/ 2 meses, agrupa e colore) -->
          <div id="rawLaunches" style="display:none;">
            {% for l in lancamentos %}
              <div class="raw-launch"
                   data-estab="{{ l.estabelecimento.nome if l.estabelecimento else '‚Äî' }}"
                   data-valor="{{ '%.2f'|format(l.valor or 0) }}"
                   data-os="{{ l.os_numero or '' }}"
                   data-iso="{% if l.data %}{{ l.data.isoformat() }}{% endif %}"
                   data-display="{% if l.data_brasilia %}{{ l.data_brasilia }}{% else %}{{ l.data.strftime('%d/%m/%Y %H:%M') }}{% endif %}"
                   data-desc="{{ (l.descricao or '')|tojson|safe }}">
              </div>
            {% endfor %}
          </div>
        </section>
      </section>

      <!-- CAT√ÅLOGOS -->
      <section id="catalogos-section" class="page hidden">
        <section class="card section">
          <div class="head">
            <div>
              <h3 class="title">Cat√°logos</h3>
              <p class="sub">Pesquise itens pelo nome enquanto digita (sem cortar).</p>
            </div>
            <span class="badge">üìö Parceiros</span>
          </div>

          {% if catalogo_itens_coop and estab_por_id %}
            <div class="searchbox">
              <span class="sicon">üîé</span>
              <input id="catalogSearch" type="search" inputmode="search" autocomplete="off"
                     placeholder="Digite o nome do item, marca, categoria ou parceiro..." />
            </div>

            <div class="searchmeta">
              <div><span id="catalogCount">0</span> item(ns) exibido(s)</div>
              <button type="button" class="clear" id="catalogClear">Limpar</button>
            </div>

            <div class="catalog-list" id="catalogGrid">
              {% for est_id, est in estab_por_id.items() %}
                {% set itens_est = catalogo_itens_coop | selectattr('estabelecimento_id','equalto', est_id) | list %}
                {% if itens_est %}
                  <article class="shop catalog-card-js" data-estab="{{ est.nome }}">
                    <div class="shop-head">
                      <div class="shop-logo">
                        {% if est.id %}
                          <img src="{{ url_for('logo_estabelecimento', id=est.id) }}" alt="{{ est.nome }}" onerror="this.style.display='none'">
                        {% endif %}
                        <span style="position:absolute;font-size:12px;">{{ est.nome[:2].upper() }}</span>
                      </div>
                      <div class="shop-info">
                        <p class="shop-name" title="{{ est.nome }}">{{ est.nome }}</p>
                        <div class="shop-count"><span class="catalog-pill-count">{{ itens_est|length }}</span> item(s)</div>
                      </div>
                    </div>

                    <div class="items">
                      {% for item in itens_est %}
                        <div class="item catalog-item-js"
                             data-item="{{ item.nome }}"
                             data-estab="{{ est.nome }}"
                             data-marca="{{ item.marca or '' }}"
                             data-categoria="{{ item.categoria or '' }}"
                             data-obs="{{ item.observacao or '' }}">
                          <div class="iname" title="{{ item.nome }}">{{ item.nome }}</div>
                          <div class="iprice">R$ {{ '%.2f'|format(item.valor or 0) }}</div>

                          <div class="imeta">
                            {% if item.marca %}Marca: {{ item.marca }}{% endif %}
                            {% if item.categoria %}{{ ' ‚Ä¢ ' if item.marca }}Categoria: {{ item.categoria }}{% endif %}
                            {% if not item.marca and not item.categoria %}&nbsp;{% endif %}
                          </div>

                          {% if item.observacao %}
                            <div class="inote">{{ item.observacao }}</div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  </article>
                {% endif %}
              {% endfor %}
            </div>

            <div class="empty" id="catalogEmptySearch" style="display:none;">
              Nenhum item encontrado com esse termo.
            </div>

          {% else %}
            <div class="empty">
              Nenhum cat√°logo dispon√≠vel ainda para os estabelecimentos que lan√ßam em seu nome.
            </div>
          {% endif %}
        </section>
      </section>

    </main>

    <!-- Overlay + Sheet filtros -->
    <div class="overlay" id="overlay"></div>

    <div class="sheet" id="sheet" aria-hidden="true">
      <div class="sheet-inner">
        <div class="drag" id="closeFilters"></div>

        <div class="sheet-head">
          <h4>Filtros dos lan√ßamentos</h4>
          <button class="xbtn" id="cancelSheet" type="button">Fechar</button>
        </div>

        <form method="get" action="{{ url_for('painel_cooperado') }}">
          <div class="sheet-body">
            <div class="field">
              <label for="di">Data in√≠cio</label>
              <input id="di" type="date" name="data_inicio" value="{{ data_inicio }}">
            </div>
            <div class="field">
              <label for="df">Data fim</label>
              <input id="df" type="date" name="data_fim" value="{{ data_fim }}">
            </div>

            <div class="actions">
              <button type="submit" class="btn primary">Aplicar</button>
              {% if data_inicio or data_fim %}
                <a class="btn ghost" href="{{ url_for('painel_cooperado') }}">Limpar</a>
              {% else %}
                <button type="button" class="btn ghost" id="cancelSheet2">Fechar</button>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- STORY MODAL -->
    <div class="story-modal" id="storyModal">
      <div class="story-frame">
        <div class="story-progress" id="storyProgress"></div>

        <div class="story-head">
          <div class="sdot" id="storyInitial">E</div>
          <div class="stitle">
            <h5 id="storyTitle">Estabelecimento</h5>
            <span id="storySub">Story</span>
          </div>
          <button class="sclose" id="closeStory" aria-label="Fechar story">√ó</button>
        </div>

        <div class="story-body">
          <img id="storyImg" src="" alt="story" style="display:none;">
          <video id="storyVideo" playsinline muted style="display:none;"></video>

          <div class="touch">
            <div class="zone" data-dir="prev"></div>
            <div class="zone" data-dir="next"></div>
          </div>
        </div>

        <div class="story-caption">
          <div class="cap" id="storyCaption"></div>
          <div class="like">
            <button id="storyLikeBtn" type="button" class="likebtn">üëç <span>TOP</span></button>
            <div id="storyLikeStats" class="likestats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- STORIES MAP -->
    <script>
      window.COOP_STORIES = [
        {% for s in stories_ativos_coop %}
          {
            id: {{ s.id }},
            estId: {{ s.estabelecimento_id }},
            tipo: "{{ s.tipo }}",
            titulo: {{ (s.titulo or '')|tojson }},
            legenda: {{ (s.legenda or '')|tojson }},
            src: "{{ url_for('story_midia', story_id=s.id) }}"
          }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
    </script>

    <script>
      /* Tabs (Topo) */
      const LAST_TAB_KEY = 'coopex_coop_tab_v3';
      const sws = document.querySelectorAll('.sw[data-target]');
      const pages = {
        'home-section': document.getElementById('home-section'),
        'catalogos-section': document.getElementById('catalogos-section')
      };

      function activate(target){
        sws.forEach(b=>{
          const on = b.getAttribute('data-target') === target;
          b.classList.toggle('active', on);
          b.setAttribute('aria-selected', on ? 'true' : 'false');
        });
        Object.keys(pages).forEach(id=>{
          if(!pages[id]) return;
          if(id === target){
            pages[id].classList.remove('hidden');
            pages[id].classList.add('fade');
            setTimeout(()=>pages[id].classList.remove('fade'), 220);
          }else{
            pages[id].classList.add('hidden');
          }
        });
        localStorage.setItem(LAST_TAB_KEY, target);

        if(target === 'catalogos-section'){
          const inp = document.getElementById('catalogSearch');
          if(inp) setTimeout(()=>inp.focus(), 120);
        }
      }

      sws.forEach(b=>{
        b.addEventListener('click', ()=> activate(b.getAttribute('data-target')));
      });

      document.addEventListener('DOMContentLoaded', ()=>{
        const saved = localStorage.getItem(LAST_TAB_KEY);
        if(saved && pages[saved]) activate(saved);
        else activate('home-section');
      });

      /* Sheet filtros */
      const sheet = document.getElementById('sheet');
      const overlay = document.getElementById('overlay');
      const openFiltersMid = document.getElementById('openFiltersMid');
      const closeFilters = document.getElementById('closeFilters');
      const cancelSheet = document.getElementById('cancelSheet');
      const cancelSheet2 = document.getElementById('cancelSheet2');

      function openSheet(){
        sheet.classList.add('open');
        sheet.setAttribute('aria-hidden','false');
        overlay.classList.add('show');
      }
      function closeSheet(){
        sheet.classList.remove('open');
        sheet.setAttribute('aria-hidden','true');
        overlay.classList.remove('show');
      }

      if(openFiltersMid) openFiltersMid.addEventListener('click', openSheet);
      if(closeFilters) closeFilters.addEventListener('click', closeSheet);
      if(cancelSheet) cancelSheet.addEventListener('click', closeSheet);
      if(cancelSheet2) cancelSheet2.addEventListener('click', closeSheet);
      if(overlay) overlay.addEventListener('click', closeSheet);

      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeSheet();
      });

      /* Lan√ßamentos: mostrar SOMENTE m√™s atual + m√™s anterior (2 meses) */
      (function buildLaunchUI(){
        const raw = document.getElementById('rawLaunches');
        const out = document.getElementById('groups');
        const empty = document.getElementById('launchEmpty');
        const monthTotalEl = document.getElementById('monthTotal');
        const monthCountEl = document.getElementById('monthCount');
        if(!raw || !out) return;

        const nodes = Array.from(raw.querySelectorAll('.raw-launch'));
        const fmtBRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
        const now = new Date();
        const nowYM = now.getFullYear()*12 + now.getMonth();

        function monthsDiff(date){
          const ym = date.getFullYear()*12 + date.getMonth();
          return (nowYM - ym);
        }

        // 0 = m√™s atual, 1 = m√™s anterior, 2+ = ignorar
        function classify(date){
          const d = monthsDiff(date);
          if(d <= 0) return 'current';
          if(d === 1) return 'mid';
          return 'old';
        }

        const groups = new Map();
        let monthTotal = 0;
        let monthCount = 0;

        // filtra para 2 meses
        nodes.forEach(n=>{
          const estab = (n.dataset.estab || '‚Äî').trim() || '‚Äî';
          const val = parseFloat((n.dataset.valor || '0').replace(',','.')) || 0;
          const iso = n.dataset.iso || '';
          const disp = n.dataset.display || '';
          const os = n.dataset.os || '';
          const descJson = n.dataset.desc || '""';

          let date = null;
          if(iso) date = new Date(iso);
          if(!date || isNaN(date.getTime())) date = new Date();

          const diff = monthsDiff(date);
          if(diff > 1) return; // >>> s√≥ 2 meses (atual + anterior)

          const tag = classify(date);

          if(tag === 'current'){
            monthTotal += val;
            monthCount += 1;
          }

          if(!groups.has(estab)) groups.set(estab, []);
          groups.get(estab).push({estab, val, iso, disp, os, descJson, tag, date});
        });

        if(monthTotalEl) monthTotalEl.textContent = fmtBRL.format(monthTotal);
        if(monthCountEl) monthCountEl.textContent = String(monthCount);

        // se ficou vazio depois do filtro
        if(groups.size === 0){
          out.innerHTML = '';
          if(empty) empty.style.display = 'block';
          return;
        }else{
          if(empty) empty.style.display = 'none';
        }

        // prepara + ordena por total (2 meses)
        const groupArr = Array.from(groups.entries()).map(([name, list])=>{
          const sum2m = list.reduce((a,b)=>a + b.val, 0);
          const sumCurrent = list.filter(x=>x.tag==='current').reduce((a,b)=>a+b.val,0);
          return {name, list, sum2m, sumCurrent};
        }).sort((a,b)=> b.sum2m - a.sum2m);

        out.innerHTML = '';
        groupArr.forEach((g, idx)=>{
          const details = document.createElement('details');
          details.className = 'group';
          if(idx === 0) details.open = true;

          const summary = document.createElement('summary');

          const left = document.createElement('div');
          left.className = 'g-left';

          const badge = document.createElement('div');
          badge.className = 'g-badge';
          badge.textContent = 'üè™';

          const nameBox = document.createElement('div');
          nameBox.className = 'g-name';

          const b = document.createElement('b');
          b.textContent = g.name;

          const sm = document.createElement('small');
          sm.textContent = g.list.length + ' lan√ßamento(s) ‚Ä¢ 2 meses';

          nameBox.appendChild(b);
          nameBox.appendChild(sm);

          left.appendChild(badge);
          left.appendChild(nameBox);

          const right = document.createElement('div');
          right.className = 'g-right';

          // >>> total do estabelecimento (2 meses) no cabe√ßalho
          const tot = document.createElement('div');
          tot.className = 'g-total';
          tot.textContent = 'Total: ' + fmtBRL.format(g.sum2m);

          const arrow = document.createElement('div');
          arrow.className = 'g-arrow';
          arrow.textContent = '‚åÑ';

          right.appendChild(tot);
          right.appendChild(arrow);

          summary.appendChild(left);
          summary.appendChild(right);

          const body = document.createElement('div');
          body.className = 'g-body';

          g.list.sort((a,b)=> b.date - a.date);

          g.list.forEach(item=>{
            const post = document.createElement('div');
            post.className = 'post';

            const left = document.createElement('div');
            left.className = 'p-left';

            const top = document.createElement('div');
            top.className = 'p-top';

            const os = document.createElement('div');
            os.className = 'p-os';
            os.textContent = 'OS: ' + (item.os || '‚Äî');

            const when = document.createElement('div');
            when.className = 'p-when';
            when.textContent = item.disp || '';

            top.appendChild(os);
            top.appendChild(when);
            left.appendChild(top);

            try{
              const desc = JSON.parse(item.descJson || '""');
              if(desc){
                const p = document.createElement('div');
                p.className = 'p-desc';
                p.textContent = desc;
                left.appendChild(p);
              }
            }catch(e){}

            const amount = document.createElement('div');
            amount.className = 'amount ' + item.tag; // current (azul) / mid (neutro)
            amount.textContent = fmtBRL.format(item.val);

            post.appendChild(left);
            post.appendChild(amount);
            body.appendChild(post);
          });

          details.appendChild(summary);
          details.appendChild(body);
          out.appendChild(details);
        });
      })();

      /* Pesquisa do cat√°logo */
      (function setupCatalogSearch(){
        const input = document.getElementById('catalogSearch');
        const clearBtn = document.getElementById('catalogClear');
        const countEl = document.getElementById('catalogCount');
        const emptyEl = document.getElementById('catalogEmptySearch');
        const grid = document.getElementById('catalogGrid');
        if(!grid || !input) return;

        const cards = Array.from(grid.querySelectorAll('.catalog-card-js'));
        const items = Array.from(grid.querySelectorAll('.catalog-item-js'));

        function norm(str){
          try{
            return (str||'')
              .toString()
              .toLowerCase()
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g,'');
          }catch(e){
            return (str||'').toString().toLowerCase();
          }
        }

        items.forEach(el=>{
          const key = [
            el.dataset.item || '',
            el.dataset.estab || '',
            el.dataset.marca || '',
            el.dataset.categoria || '',
            el.dataset.obs || ''
          ].join(' ');
          el.dataset.searchKey = norm(key);
        });

        function updateMeta(visible){
          if(countEl) countEl.textContent = String(visible);
          if(emptyEl) emptyEl.style.display = (visible === 0) ? 'block' : 'none';
        }

        function filter(q){
          const query = norm(q).trim();
          if(clearBtn) clearBtn.style.display = query ? 'inline-flex' : 'none';

          let visibleCount = 0;
          items.forEach(item=>{
            const match = !query || (item.dataset.searchKey || '').includes(query);
            item.style.display = match ? '' : 'none';
            if(match) visibleCount++;
          });

          cards.forEach(card=>{
            const cardItems = Array.from(card.querySelectorAll('.catalog-item-js'));
            const anyVisible = cardItems.some(ci => ci.style.display !== 'none');
            card.style.display = anyVisible ? '' : 'none';

            const pillCount = card.querySelector('.catalog-pill-count');
            if(pillCount){
              const vis = cardItems.filter(ci => ci.style.display !== 'none').length;
              pillCount.textContent = String(vis);
            }
          });

          updateMeta(visibleCount);
        }

        filter('');

        input.addEventListener('input', (e)=> filter(e.target.value));

        if(clearBtn){
          clearBtn.addEventListener('click', ()=>{
            input.value = '';
            filter('');
            input.focus();
          });
        }
      })();

      /* STORIES (Instagram) */
      const storyModal   = document.getElementById('storyModal');
      const storyImg     = document.getElementById('storyImg');
      const storyVideo   = document.getElementById('storyVideo');
      const storyTitle   = document.getElementById('storyTitle');
      const storySub     = document.getElementById('storySub');
      const storyCaption = document.getElementById('storyCaption');
      const storyInitial = document.getElementById('storyInitial');
      const closeStory   = document.getElementById('closeStory');
      const progressWrap = document.getElementById('storyProgress');
      const storyLikeBtn = document.getElementById('storyLikeBtn');
      const storyLikeStats = document.getElementById('storyLikeStats');

      const STORY_DURATION = 5000;
      let currentEstName = '';
      let storyList = [];
      let currentIndex = 0;
      let timer = null;
      let isPaused = false;
      let progressFills = [];
      let currentStoryId = null;

      function buildProgressBar(count){
        progressWrap.innerHTML = '';
        progressFills = [];
        for(let i=0;i<count;i++){
          const seg = document.createElement('div');
          seg.className = 'seg';
          const fill = document.createElement('div');
          fill.className = 'fill';
          seg.appendChild(fill);
          progressWrap.appendChild(seg);
          progressFills.push(fill);
        }
      }
      function updateProgress(ratio=0){
        progressFills.forEach((fill, idx)=>{
          if(idx < currentIndex) fill.style.width = '100%';
          else if(idx === currentIndex) fill.style.width = (ratio*100)+'%';
          else fill.style.width = '0%';
        });
      }

      function updateLikeUI(liked, views, likes){
        if(typeof liked === 'boolean' && storyLikeBtn){
          storyLikeBtn.dataset.liked = liked ? '1' : '0';
          storyLikeBtn.classList.toggle('liked', liked);
        }
        if(storyLikeStats){
          const v = typeof views === 'number' ? views : 0;
          const l = typeof likes === 'number' ? likes : 0;
          storyLikeStats.textContent = v + ' visualiza√ß√µes ‚Ä¢ ' + l + ' TOP';
        }
      }

      function registrarView(likedValue){
        if(!currentStoryId) return;
        fetch("{{ url_for('registrar_story_view') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({story_id: currentStoryId, liked: likedValue})
        })
        .then(r=>r.json())
        .then(data=>{
          if(data && data.ok){
            updateLikeUI(data.liked, data.views, data.likes);
          }
        })
        .catch(()=>{});
      }

      function showStory(story){
        currentStoryId = story.id;
        storyTitle.textContent = currentEstName;
        storySub.textContent = story.titulo || 'Story';
        storyCaption.textContent = story.legenda || '';
        storyInitial.textContent = (currentEstName || 'E').slice(0,2).toUpperCase();

        storyImg.style.display = 'none';
        storyVideo.style.display = 'none';
        storyVideo.pause();
        storyVideo.removeAttribute('src');

        if(story.tipo === 'video'){
          storyVideo.style.display = 'block';
          storyVideo.src = story.src;
          storyVideo.load();
          storyVideo.play().catch(()=>{});
        }else{
          storyImg.style.display = 'block';
          storyImg.src = story.src;
        }

        updateProgress(0);
        updateLikeUI(null, 0, 0);
        registrarView(null);
      }

      function startTimer(){
        clearInterval(timer);
        let elapsed = 0;
        const step = 50;
        timer = setInterval(()=>{
          if(isPaused) return;
          elapsed += step;
          const ratio = Math.min(1, elapsed / STORY_DURATION);
          updateProgress(ratio);
          if(elapsed >= STORY_DURATION) nextStory();
        }, step);
      }

      function openStoryForEst(estId, estName){
        const all = window.COOP_STORIES || [];
        const list = all.filter(s => s.estId === estId);
        if(!list.length) return;

        currentEstName = estName || '';
        storyList = list;
        currentIndex = 0;

        buildProgressBar(storyList.length);
        showStory(storyList[currentIndex]);
        startTimer();

        storyModal.classList.add('open');
      }

      function closeStoryModal(){
        storyModal.classList.remove('open');
        clearInterval(timer);
        timer = null;
        storyVideo.pause();
        currentStoryId = null;
      }

      function nextStory(){
        if(currentIndex < storyList.length - 1){
          currentIndex++;
          showStory(storyList[currentIndex]);
          startTimer();
        }else{
          closeStoryModal();
        }
      }
      function prevStory(){
        if(currentIndex > 0){
          currentIndex--;
          showStory(storyList[currentIndex]);
          startTimer();
        }else{
          currentIndex = 0;
          showStory(storyList[currentIndex]);
          startTimer();
        }
      }

      document.querySelectorAll('.story').forEach(chip=>{
        chip.addEventListener('click', ()=>{
          const estId = Number(chip.getAttribute('data-est-id'));
          const estName = chip.getAttribute('data-est-nome') || '';
          openStoryForEst(estId, estName);
        });
      });

      if(closeStory){
        closeStory.addEventListener('click', closeStoryModal);
      }
      if(storyModal){
        storyModal.addEventListener('click',(e)=>{
          if(e.target === storyModal) closeStoryModal();
        });
      }
      document.addEventListener('keydown',(e)=>{
        if(e.key === 'Escape') closeStoryModal();
      });

      document.querySelectorAll('.zone').forEach(zone=>{
        let holdTimeout = null;
        let held = false;

        function startHold(){
          held = false;
          isPaused = false;
          holdTimeout = setTimeout(()=>{
            held = true;
            isPaused = true;
          }, 200);
        }
        function endHold(){
          clearTimeout(holdTimeout);
          if(held){
            isPaused = false;
            return;
          }
          const dir = zone.getAttribute('data-dir');
          if(dir === 'next') nextStory();
          else prevStory();
        }

        zone.addEventListener('mousedown', startHold);
        zone.addEventListener('touchstart', startHold, {passive:true});

        zone.addEventListener('mouseup', endHold);
        zone.addEventListener('mouseleave', endHold);
        zone.addEventListener('touchend', endHold);
        zone.addEventListener('touchcancel', endHold);
      });

      if(storyLikeBtn){
        storyLikeBtn.addEventListener('click', ()=>{
          if(!currentStoryId) return;
          const likedNow = storyLikeBtn.dataset.liked === '1' ? false : true;
          registrarView(likedNow);
        });
      }
    </script>

  </div>
</body>
</html>
