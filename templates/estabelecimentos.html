<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Estabelecimentos - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Fonts / Bootstrap / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <style>
    :root{
      /* Mesmo tom “Azul Royal” do Lançamentos */
      --bg:#f6f8ff;
      --panel:#ffffff;
      --line:#e4ebff;
      --ink:#0f172a;
      --muted:#5b6b8a;

      --royal:#1f4fe0;
      --royal2:#3a66ff;
      --royal3:#163ab0;

      --ok:#10b981;
      --danger:#ef4444;

      --shadow: 0 14px 34px rgba(31,79,224,.12);
      --shadow2: 0 18px 46px rgba(15,23,42,.08);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{overflow-x:hidden}

    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 520px at 85% -20%, rgba(31,79,224,.14), transparent 60%),
        radial-gradient(900px 420px at 10% 0%, rgba(16,185,129,.08), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    /* ===== Layout ===== */
    .layout{
      display:flex;
      min-height:100vh;
    }

    /* ===== Sidebar (desktop) ===== */
    .sidebar{
      width: 260px;
      flex: 0 0 260px;
      position: sticky;
      top: 0;
      height: 100vh;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--line);
      box-shadow: 10px 0 34px rgba(15,23,42,.06);
      padding: 16px 12px;
      z-index: 30;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .brand{
      border-radius: var(--radius);
      background: linear-gradient(90deg, rgba(31,79,224,.10), rgba(58,102,255,.06));
      border: 1px solid rgba(31,79,224,.18);
      padding: 14px 12px;
      box-shadow: 0 14px 30px rgba(31,79,224,.08);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .brand img{
      width: 54px; height: 54px;
      object-fit: contain;
      border-radius: 16px;
      background:#fff;
      border: 1px solid rgba(31,79,224,.18);
      box-shadow: 0 10px 18px rgba(31,79,224,.10);
      padding: 6px;
    }
    .brand .title{
      min-width:0;
      line-height:1.15;
    }
    .brand .title .t{
      margin:0;
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing: .6px;
      color: var(--royal3);
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .brand .title .s{
      margin: 4px 0 0;
      font-weight: 800;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .navbox{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow2);
      padding: 10px;
    }

    .nav-link{
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      color: #1b2b5e;
      display:flex;
      align-items:center;
      gap: 10px;
      transition: background .15s, transform .05s, color .15s;
      margin: 4px 0;
    }
    .nav-link i{
      color: var(--royal3);
      font-size: 1.15rem;
    }
    .nav-link:hover{
      background:#f1f5ff;
      color: var(--royal3);
    }
    .nav-link.active{
      background: linear-gradient(90deg, rgba(31,79,224,.14), rgba(58,102,255,.08));
      border: 1px solid rgba(31,79,224,.18);
      color: var(--royal3);
    }

    .sidebar .footer{
      margin-top:auto;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background:#fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .who{
      min-width:0;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .who .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(16,185,129,.12);
    }
    .who .name{
      font-weight: 900;
      color: #0f172a;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 140px;
      font-size: 12px;
    }
    .btn-logout{
      height: 38px;
      padding: 0 12px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(31,79,224,.18);
      background: #fff;
      color: var(--royal3);
    }
    .btn-logout:hover{ background:#f1f5ff; }

    /* ===== Main ===== */
    .main{
      flex: 1 1 auto;
      padding: 16px 18px 28px;
      width: 100%;
    }

    .container-x{
      width: min(1600px, calc(100vw - 320px)); /* ocupa bem no desktop com sidebar */
      margin: 0 auto;
    }

    /* ===== Topbar (main) ===== */
    .topbar{
      position: sticky;
      top: 12px;
      z-index: 20;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px;
      border-radius: var(--radius);
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal2) 55%, var(--royal3) 100%);
      color:#fff;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.22);
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .topbar .left .ico{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      flex: 0 0 auto;
    }
    .topbar .left .txt{
      min-width:0;
      line-height:1.1;
    }
    .topbar .left .txt .t{
      margin:0;
      font-family: Orbitron, Inter, sans-serif;
      font-weight: 900;
      letter-spacing: .6px;
      font-size: 15px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .topbar .left .txt .s{
      margin:4px 0 0;
      font-weight: 800;
      font-size: 12px;
      opacity: .92;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .top-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn-top{
      height: 42px;
      padding: 0 12px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.10);
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      text-decoration:none;
    }
    .btn-top:hover{ background: rgba(255,255,255,.16); color:#fff; }

    /* ===== Cards ===== */
    .cardx{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      margin-top: 12px;
    }

    /* ===== Header + Controles ===== */
    .toolbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .view-switch{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-toggle{
      height: 42px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(31,79,224,.18);
      background:#fff;
      color: var(--royal3);
      padding: 0 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
    }
    .btn-toggle:hover{ background:#f1f5ff; }
    .btn-toggle.active{
      border: none;
      color:#fff;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      box-shadow: 0 12px 22px rgba(31,79,224,.14);
    }

    .search{
      display:flex;
      align-items:center;
      gap: 8px;
      background:#fff;
      border: 1px solid #cfe0ff;
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: inset 0 0 0 1px rgba(31,79,224,.04);
    }
    .search i{ color:#6b7aa6; }
    .search input{
      border:none; outline:none;
      background: transparent;
      width: 260px;
      font-weight: 700;
      color: var(--ink);
    }

    .btn-main{
      height: 42px;
      padding: 0 14px;
      border-radius: 14px;
      font-weight: 900;
      border:none;
      color:#fff;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      box-shadow: 0 12px 22px rgba(31,79,224,.14);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      text-decoration:none;
    }
    .btn-main:hover{ filter: brightness(1.03); color:#fff; }

    /* ===== KPIs ===== */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .kpi{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: linear-gradient(180deg, #fff 0%, #fbfcff 100%);
      box-shadow: 0 10px 22px rgba(15,23,42,.04);
    }
    .kpi .label{
      display:flex;
      align-items:center;
      gap: 8px;
      color:#1f2b4a;
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .kpi .label i{ color: var(--royal3); }
    .kpi .value{
      margin-top: 8px;
      font: 900 22px/1 Orbitron, Inter, sans-serif;
      color: var(--royal3);
      font-variant-numeric: tabular-nums;
    }
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #f3f6ff;
      color:#1b2b5e;
      font-weight: 900;
      font-size: 12px;
      box-shadow: 0 8px 16px rgba(31,79,224,.06);
    }
    .chip .count{
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(31,79,224,.12);
      color: var(--royal3);
      font-weight: 900;
    }

    /* ===== Table ===== */
    .table-wrap{
      border-radius: 16px;
      overflow: hidden;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 8px 18px rgba(31,79,224,.08);
      margin-top: 12px;
    }
    table{
      width: 100%;
      margin:0;
      text-align:center;
      border-collapse: collapse;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #f2f6ff;
      color: var(--royal3)!important;
      font-family: Orbitron, Inter, sans-serif;
      letter-spacing: .7px;
      border-bottom: 1px solid var(--line);
      padding: 12px 8px;
      white-space: nowrap;
    }
    tbody td{
      border-top: 1px solid var(--line);
      padding: 12px 8px;
      vertical-align: middle;
    }
    tbody tr:nth-child(even) td{ background:#fbfdff; }
    tbody tr:hover td{ background:#f3f7ff; }

    .estab-foto{
      width: 86px; height: 86px;
      object-fit: cover;
      border-radius: 999px;
      border: 3px solid rgba(31,79,224,.28);
      box-shadow: 0 10px 18px rgba(31,79,224,.10);
      background:#fff;
      display:block;
      margin: 0 auto;
    }
    .avatar-fallback{
      width: 86px; height: 86px;
      border-radius: 999px;
      border: 3px solid rgba(31,79,224,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 0 auto;
      color: var(--royal3);
      background: #eef3ff;
      box-shadow: 0 10px 18px rgba(31,79,224,.10);
      font-size: 2rem;
    }

    .td-strong{
      font-weight: 900;
      color: var(--royal3);
      font-family: Orbitron, Inter, sans-serif;
      letter-spacing: .4px;
      max-width: 260px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-align:left;
    }
    .td-user{
      font-weight: 900;
      color:#1b2b5e;
      max-width: 200px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-align:left;
    }

    .actions{
      display:flex;
      gap: 8px;
      justify-content:center;
      flex-wrap: wrap;
    }
    .btn-outline-primary{
      border-radius: 12px;
      font-weight: 900;
      color: var(--royal3);
      border-color: rgba(31,79,224,.35);
    }
    .btn-outline-primary:hover{
      color:#fff;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      border-color: transparent;
    }
    .btn-outline-danger{
      border-radius: 12px;
      font-weight: 900;
      color:#b4232a;
      border-color: rgba(239,68,68,.35);
    }
    .btn-outline-danger:hover{
      color:#fff;
      background: linear-gradient(90deg, #ef4444, #dc2626);
      border-color: transparent;
    }

    /* ===== Cards view ===== */
    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .card-estab{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      text-align:center;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .card-estab:hover{
      transform: translateY(-3px);
      box-shadow: 0 14px 30px rgba(31,79,224,.12);
      filter: brightness(1.01);
    }
    .card-estab .name{
      margin-top: 10px;
      font: 900 15px/1.2 Orbitron, Inter, sans-serif;
      color: var(--royal3);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .card-estab .user{
      margin-top: 4px;
      color:#1b2b5e;
      font-weight: 800;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Alerts */
    .alertx{
      margin-top: 12px;
      border-radius: 14px;
      border: 0;
      color:#fff;
      font-weight: 900;
      background: linear-gradient(90deg, var(--royal) 0%, var(--royal3) 100%);
      box-shadow: 0 12px 22px rgba(31,79,224,.14);
    }

    /* ===== Responsivo ===== */
    @media (max-width: 1100px){
      .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .container-x{ width: min(1600px, calc(100vw - 28px)); }
      .sidebar{ width: 240px; flex-basis: 240px; }
    }
    @media (max-width: 900px){
      .sidebar{ display:none; }
      .container-x{ width: calc(100vw - 22px); }
      .main{ padding: 12px; }
      .topbar{ position: static; }
      .kpis{ grid-template-columns: 1fr; }
      .cards{ grid-template-columns: 1fr; }
      .search input{ width: 200px; }
    }
  </style>
</head>

<body>
  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <img src="{{ url_for('static', filename='logo_coopex.png') }}" alt="Logo Coopex" />
        <div class="title">
          <p class="t">Coopex Parcerias</p>
          <p class="s">Painel Administrativo</p>
        </div>
      </div>

      <div class="navbox">
        <nav class="nav flex-column">
          <a class="nav-link" href="{{ url_for('painel_admin') }}">
            <i class="bi bi-speedometer2"></i> Dashboard
          </a>
          <a class="nav-link active" href="{{ url_for('listar_estabelecimentos') }}">
            <i class="bi bi-building"></i> Estabelecimentos
          </a>
          <a class="nav-link" href="{{ url_for('listar_cooperados') }}">
            <i class="bi bi-people-fill"></i> Cooperados
          </a>
          <a class="nav-link" href="{{ url_for('listar_lancamentos') }}">
            <i class="bi bi-currency-dollar"></i> Lançamentos
          </a>
          <a class="nav-link" href="{{ url_for('logout') }}">
            <i class="bi bi-box-arrow-left"></i> Sair
          </a>
        </nav>
      </div>

      <div class="footer">
        <div class="who">
          <span class="dot"></span>
          <div class="name" title="{{ admin.nome }}"> {{ admin.nome }} </div>
        </div>
        <a class="btn btn-logout" href="{{ url_for('logout') }}" title="Sair">
          <i class="bi bi-power"></i>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="container-x">

        <!-- Topbar -->
        <div class="topbar">
          <div class="left">
            <div class="ico"><i class="bi bi-building fs-4"></i></div>
            <div class="txt">
              <p class="t m-0">Estabelecimentos</p>
              <p class="s m-0">Gerencie cadastros e logos</p>
            </div>
          </div>
          <div class="top-actions">
            <a href="{{ url_for('painel_admin') }}" class="btn btn-top">
              <i class="bi bi-arrow-left-circle"></i> Dashboard
            </a>
            <a href="{{ url_for('novo_estabelecimento') }}" class="btn btn-top">
              <i class="bi bi-plus-circle"></i> Novo
            </a>
          </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alertx text-center">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- Conteúdo -->
        <section class="cardx">
          <div class="toolbar">
            <div style="min-width:0">
              <div style="font-family:Orbitron,Inter,sans-serif;font-weight:900;letter-spacing:.6px;color:var(--royal3)">
                <i class="bi bi-buildings"></i> Estabelecimentos Cadastrados
              </div>
              <div style="color:var(--muted);font-weight:700;font-size:12px;margin-top:4px">
                Use a busca para filtrar por nome ou usuário e alterne entre tabela e cartões.
              </div>
            </div>

            <div class="view-switch">
              <button class="btn btn-toggle active" id="btn-view-table"><i class="bi bi-table"></i> Tabela</button>
              <button class="btn btn-toggle" id="btn-view-cards"><i class="bi bi-grid-3x3-gap"></i> Cartões</button>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div class="search">
                <i class="bi bi-search"></i>
                <input type="text" id="busca" placeholder="Buscar por nome ou usuário..." />
              </div>
              <a href="{{ url_for('novo_estabelecimento') }}" class="btn btn-main">
                <i class="bi bi-plus-circle"></i> Novo
              </a>
            </div>
          </div>

          <!-- KPIs -->
          <div class="kpis">
            <div class="kpi">
              <div class="label"><i class="bi bi-buildings"></i> Total</div>
              <div class="value" id="kpi-total">0</div>
            </div>
            <div class="kpi">
              <div class="label"><i class="bi bi-image"></i> Com logo</div>
              <div class="value" id="kpi-comlogo">0</div>
            </div>
            <div class="kpi">
              <div class="label"><i class="bi bi-image-alt"></i> Sem logo</div>
              <div class="value" id="kpi-semlogo">0</div>
            </div>
          </div>

          <!-- Chips -->
          <div class="chips">
            <span class="chip">Visíveis <span class="count" id="count-visiveis">0</span></span>
          </div>

          <!-- VIEW: TABELA -->
          <div class="table-wrap" id="view-table">
            <table class="table align-middle m-0">
              <thead>
                <tr>
                  <th style="width:120px">Logo</th>
                  <th>Nome</th>
                  <th>Usuário</th>
                  <th style="width:220px">Ações</th>
                </tr>
              </thead>
              <tbody id="tbody-estabs">
                {% for est in estabelecimentos %}
                <tr class="tbl-row"
                    data-name="{{ est.nome|lower }}"
                    data-user="{{ est.username|lower }}"
                    data-has-logo="{{ 1 if est.logo else 0 }}">
                  <td>
                    {% if est.logo %}
                      <img src="{{ url_for('static', filename='logos/' ~ est.logo) }}"
                           alt="Logo do Estabelecimento"
                           class="estab-foto"
                           onerror="this.closest('td').innerHTML=fallbackAvatar();" />
                    {% else %}
                      <div class="avatar-fallback"><i class="bi bi-buildings"></i></div>
                    {% endif %}
                  </td>
                  <td class="td-strong" title="{{ est.nome }}">{{ est.nome }}</td>
                  <td class="td-user" title="{{ est.username }}">{{ est.username }}</td>
                  <td>
                    <div class="actions">
                      <a href="{{ url_for('editar_estabelecimento', id=est.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil-square"></i> Editar
                      </a>
                      <a href="{{ url_for('excluir_estabelecimento', id=est.id) }}"
                         class="btn btn-sm btn-outline-danger"
                         onclick="return confirm('Excluir este estabelecimento?')">
                        <i class="bi bi-trash"></i> Excluir
                      </a>
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" style="padding:14px;text-align:center;color:var(--muted);font-weight:800">
                    Nenhum estabelecimento cadastrado.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- VIEW: CARTÕES -->
          <div class="cards" id="view-cards" style="display:none">
            {% for est in estabelecimentos %}
            <div class="card-estab card-item"
                 data-name="{{ est.nome|lower }}"
                 data-user="{{ est.username|lower }}"
                 data-has-logo="{{ 1 if est.logo else 0 }}">
              {% if est.logo %}
                <img src="{{ url_for('static', filename='logos/' ~ est.logo) }}"
                     alt="Logo do Estabelecimento"
                     class="estab-foto"
                     onerror="this.outerHTML=fallbackAvatar();" />
              {% else %}
                <div class="avatar-fallback"><i class="bi bi-buildings"></i></div>
              {% endif %}

              <div class="name" title="{{ est.nome }}">{{ est.nome }}</div>
              <div class="user" title="{{ est.username }}">{{ est.username }}</div>

              <div class="actions" style="margin-top:10px">
                <a href="{{ url_for('editar_estabelecimento', id=est.id) }}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-pencil-square"></i> Editar
                </a>
                <a href="{{ url_for('excluir_estabelecimento', id=est.id) }}"
                   class="btn btn-sm btn-outline-danger"
                   onclick="return confirm('Excluir este estabelecimento?')">
                  <i class="bi bi-trash"></i> Excluir
                </a>
              </div>
            </div>
            {% else %}
            <div class="card-estab" style="text-align:center;color:var(--muted);font-weight:900">
              Nenhum estabelecimento cadastrado.
            </div>
            {% endfor %}
          </div>

        </section>
      </div>
    </main>
  </div>

  <script>
    // Avatar fallback
    function fallbackAvatar(){
      return '<div class="avatar-fallback"><i class="bi bi-buildings"></i></div>';
    }

    // KPIs
    function atualizarKPIs(){
      const rows = [...document.querySelectorAll('.tbl-row')];
      const total = rows.length;
      const comLogo = rows.filter(r => r.dataset.hasLogo === '1').length;
      const semLogo = total - comLogo;

      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-comlogo').textContent = comLogo;
      document.getElementById('kpi-semlogo').textContent = semLogo;

      atualizarContagemVisiveis();
    }

    function atualizarContagemVisiveis(){
      const isCards = document.getElementById('view-cards').style.display !== 'none';
      const sel = isCards ? '.card-item' : '.tbl-row';
      const vis = [...document.querySelectorAll(sel)].filter(el => el.style.display !== 'none').length;
      document.getElementById('count-visiveis').textContent = vis;
    }

    // Busca (tabela + cards)
    function aplicarBusca(){
      const q = (document.getElementById('busca').value || '')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toLowerCase();

      const match = (name,user) => {
        const n = (name||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
        const u = (user||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
        return !q || n.includes(q) || u.includes(q);
      };

      document.querySelectorAll('.tbl-row').forEach(tr=>{
        tr.style.display = match(tr.dataset.name, tr.dataset.user) ? '' : 'none';
      });

      document.querySelectorAll('.card-item').forEach(card=>{
        card.style.display = match(card.dataset.name, card.dataset.user) ? '' : 'none';
      });

      atualizarContagemVisiveis();
    }

    // Alternar visualização
    function setView(mode){
      const vt = document.getElementById('view-table');
      const vc = document.getElementById('view-cards');
      const bt = document.getElementById('btn-view-table');
      const bc = document.getElementById('btn-view-cards');

      const showTable = (mode === 'table');
      vt.style.display = showTable ? '' : 'none';
      vc.style.display = showTable ? 'none' : '';
      bt.classList.toggle('active', showTable);
      bc.classList.toggle('active', !showTable);

      atualizarContagemVisiveis();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      atualizarKPIs();
      aplicarBusca();

      document.getElementById('busca').addEventListener('input', aplicarBusca);
      document.getElementById('btn-view-table').addEventListener('click', ()=>setView('table'));
      document.getElementById('btn-view-cards').addEventListener('click', ()=>setView('cards'));
    });

    // Recalcula depois que as imagens carregarem/falharem
    window.addEventListener('load', atualizarKPIs);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
