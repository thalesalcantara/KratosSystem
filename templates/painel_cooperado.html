<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Painel do Cooperado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Brand */
      --royal:#4169E1;
      --royal-700:#2449C9;
      --royal-50:#F3F6FF;

      /* UI */
      --ink:#0B1220;
      --muted:#6B7280;
      --line:#E6ECFF;
      --ok:#10B981;
      --danger:#EF4444;

      --bg:#FFFFFF;
      --bg-soft:#F5F7FF;

      --radius-xl:22px;
      --radius-lg:18px;
      --radius-md:14px;

      --shadow: 0 14px 38px rgba(15,23,42,.10);
      --shadow-strong: 0 18px 46px rgba(65,105,225,.22);

      --nav-h: 74px; /* base (sem safe-area) */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(65,105,225,.14), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.10), transparent 55%),
        radial-gradient(900px 500px at 20% 110%, rgba(99,102,241,.10), transparent 55%),
        #EEF2FF;
    }

    button, input { font-family: inherit; }

    /* Container ‚Äúphone-like‚Äù (focado em 6") */
    .phone{
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position:relative;
    }

    /* TOP BAR (social style) */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 14px 14px 12px 14px;
      background:
        linear-gradient(135deg, #0B1220 0%, #142A74 45%, #0B1220 100%);
      box-shadow: var(--shadow-strong);
      border-bottom-left-radius: 22px;
      border-bottom-right-radius: 22px;
      overflow: hidden;
    }

    .topbar::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(420px 220px at 10% 0%, rgba(65,105,225,.50), transparent 60%),
        radial-gradient(420px 220px at 90% 0%, rgba(14,165,233,.35), transparent 60%);
      pointer-events:none;
      opacity:.95;
    }

    .topbar-inner{
      position:relative;
      display:flex;
      align-items:center;
      gap: 12px;
      min-width:0;
    }

    .avatar{
      width: 46px; height: 46px;
      border-radius: 999px;
      padding: 2px;
      background: conic-gradient(from 180deg, #60A5FA, #A78BFA, #34D399, #60A5FA);
      flex: 0 0 auto;
      box-shadow: 0 0 0 2px rgba(255,255,255,.20);
    }
    .avatar img{
      width:100%; height:100%;
      border-radius:999px;
      object-fit:cover;
      display:block;
      border: 2px solid rgba(11,18,32,.85);
      background:#0B1220;
    }

    .who{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .who h1{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      color:#fff;
      letter-spacing:.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 270px;
    }
    .who .sub{
      font-size: 11px;
      color: rgba(255,255,255,.78);
      font-weight: 700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 270px;
    }

    .pill-role{
      margin-top:4px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      color:#fff;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      width: fit-content;
    }

    .actions-top{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }

    .iconbtn{
      width: 40px; height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.12);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, filter .12s ease;
      backdrop-filter: blur(8px);
    }
    .iconbtn:active{ transform: scale(.98); }
    .logoutbtn{
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.14);
      color:#fff;
      font-weight: 900;
      font-size: 12px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, filter .12s ease;
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    .logoutbtn:active{ transform: scale(.99); }

    /* CONTENT */
    .content{
      padding: 12px 12px 0 12px;
      padding-bottom: calc(var(--nav-h) + 18px + env(safe-area-inset-bottom));
    }

    /* PAGE SWITCH ANIM */
    .page{ display:block; }
    .page-hidden{ display:none; }
    .fade-in{ animation: fadein .18s ease; }
    @keyframes fadein{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    @media (prefers-reduced-motion: reduce){
      .fade-in{ animation:none; }
      *{ scroll-behavior:auto !important; transition:none !important; }
    }

    /* Cards modern */
    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.70);
      box-shadow: var(--shadow);
      border-radius: var(--radius-xl);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }

    .stack{ display:flex; flex-direction:column; gap: 12px; }

    /* Header ‚ÄúCr√©dito / total‚Äù estilo social stats */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .stat{
      padding: 14px 14px 12px 14px;
      position:relative;
      min-width:0;
    }
    .stat .k{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#334155;
      margin:0 0 8px 0;
      opacity:.85;
    }
    .stat .v{
      font-size: 24px;
      font-weight: 900;
      margin:0;
      color: var(--ink);
      letter-spacing:.01em;
    }
    .stat .v.ok{ color: var(--ok); }
    .stat .h{
      margin:6px 0 0 0;
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
    }
    .stat .chip{
      position:absolute;
      top: 12px; right: 12px;
      width: 30px; height: 30px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: var(--royal-50);
      color: var(--royal-700);
      border: 1px solid var(--line);
      font-size: 14px;
      font-weight: 900;
    }

    /* Section header */
    .section{
      padding: 14px;
    }
    .section-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap:wrap;
    }
    .title{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#0B1220;
    }
    .subtitle{
      margin:4px 0 0 0;
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      font-size: 11px;
      font-weight: 900;
      white-space:nowrap;
    }

    .empty{
      padding: 14px;
      text-align:center;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }

    /* STORIES (social) */
    .stories-row{
      display:flex;
      gap: 10px;
      overflow-x:auto;
      padding-bottom: 4px;
      scrollbar-width: thin;
    }
    .stories-row::-webkit-scrollbar{ height:5px; }
    .stories-row::-webkit-scrollbar-thumb{ background: rgba(11,18,32,.25); border-radius:999px; }

    .story{
      border:0;
      background:transparent;
      padding:0;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      min-width: 76px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    .story:active{ transform: scale(.98); }
    .ring{
      width: 66px;
      height: 66px;
      border-radius: 999px;
      padding: 2px;
      background: conic-gradient(from 140deg, #60A5FA, #A78BFA, #34D399, #60A5FA);
      box-shadow: 0 12px 28px rgba(15,23,42,.18);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .ring .inner{
      width:100%;
      height:100%;
      border-radius:999px;
      background: #0B1220;
      overflow:hidden;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:900;
      font-size: 22px;
    }
    .ring .inner img{ width:100%; height:100%; object-fit:cover; display:block; }
    .story-name{
      font-size: 11px;
      font-weight: 900;
      color: #0B1220;
      max-width: 90px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }
    .story-meta{
      font-size: 10px;
      font-weight: 900;
      color: #64748B;
    }

    /* FEED (Lan√ßamentos) */
    .feed{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .post{
      border: 1px solid var(--line);
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width:0;
    }
    .post-top{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      min-width:0;
    }
    .post-dot{
      width: 38px; height: 38px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      box-shadow: 0 10px 22px rgba(65,105,225,.20);
      flex:0 0 auto;
    }
    .post-head{
      min-width:0;
      flex:1 1 auto;
    }
    .post-estab{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      color: #0B1220;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .post-sub{
      margin:3px 0 0 0;
      font-size: 11px;
      font-weight: 800;
      color: #64748B;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .post-price{
      flex:0 0 auto;
      font-size: 13px;
      font-weight: 900;
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .post-desc{
      font-size: 12px;
      color:#334155;
      font-weight: 700;
      line-height: 1.35;
      word-break: break-word;
    }

    /* FAB filtros (social action) */
    .fab{
      position:fixed;
      right: 16px;
      bottom: calc(var(--nav-h) + 16px + env(safe-area-inset-bottom));
      z-index: 60;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border:0;
      cursor:pointer;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      box-shadow: var(--shadow-strong);
      color:#fff;
      font-weight: 900;
      font-size: 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease;
    }
    .fab:active{ transform: scale(.98); }

    /* Bottom sheet filtros (modern) */
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-110%;
      z-index: 80;
      transition: bottom .22s ease;
      padding: 0 0 env(safe-area-inset-bottom) 0;
    }
    .sheet.open{ bottom:0; }
    .sheet-inner{
      max-width: 480px;
      margin: 0 auto;
      background:#fff;
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border: 1px solid var(--line);
      box-shadow: 0 -18px 46px rgba(15,23,42,.22);
      overflow:hidden;
    }
    .sheet-drag{
      width: 48px;
      height: 5px;
      border-radius:999px;
      background:#E5E7EB;
      margin: 10px auto 6px auto;
    }
    .sheet-head{
      padding: 6px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheet-head h4{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#0B1220;
    }
    .sheet-close{
      border:0;
      background: var(--royal-50);
      color: var(--royal-700);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheet-body{
      padding: 0 14px 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size: 11px; font-weight: 900; color:#334155; }
    input[type="date"]{
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background:#fff;
      padding: 10px 12px;
      font-weight: 800;
      color:#0B1220;
      min-width:0;
    }
    .sheet-actions{
      grid-column: 1 / -1;
      display:flex;
      gap: 10px;
    }
    .btn{
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background:#fff;
      font-weight: 900;
      cursor:pointer;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:#0B1220;
    }
    .btn.primary{
      border:0;
      color:#fff;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      box-shadow: 0 12px 26px rgba(65,105,225,.22);
    }
    .btn.ghost{
      color: var(--royal-700);
      background: var(--royal-50);
    }

    /* BOTTOM NAV (social) */
    .bottom-nav{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index: 70;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(14px);
      box-shadow: 0 -10px 30px rgba(15,23,42,.10);
    }
    .nav-inner{
      max-width: 480px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      align-items:center;
    }
    .tab{
      border:0;
      background:transparent;
      cursor:pointer;
      height: 46px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-weight: 900;
      font-size: 12px;
      color: #6B7280;
      transition: background .12s ease, color .12s ease, transform .12s ease;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .tab:active{ transform: scale(.99); }
    .tab .i{
      width: 30px; height: 30px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: #F3F4F6;
      border: 1px solid #E5E7EB;
      font-size: 15px;
    }
    .tab.active{
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
    }
    .tab.active .i{
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      border: 0;
      color:#fff;
    }

    /* CATALOG (social marketplace) */
    .searchbar{
      position: sticky;
      top: 88px; /* abaixo do topbar (aprox) */
      z-index: 40;
      padding: 10px 0 8px 0;
      background: linear-gradient(to bottom, rgba(245,247,255,.95), rgba(245,247,255,.55));
      backdrop-filter: blur(12px);
    }
    .searchbox{
      display:flex;
      align-items:center;
      gap: 10px;
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
    }
    .searchbox .sicon{ font-size: 16px; }
    .searchbox input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      font-size: 14px;
      font-weight: 900;
      color: var(--ink);
      min-width:0;
    }
    .searchbox input::placeholder{ color:#9CA3AF; font-weight:800; }

    .searchmeta{
      margin-top: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
    }
    .clear{
      border:0;
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--royal-50);
      border: 1px solid var(--line);
      color: var(--royal-700);
      font-weight: 900;
      display:none;
      white-space:nowrap;
    }

    .catalog-list{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 6px;
    }

    .shop{
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255,255,255,.70);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .shop-head{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      min-width:0;
    }
    .shop-logo{
      width: 42px; height: 42px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      position:relative;
      overflow:hidden;
      flex:0 0 auto;
      box-shadow: 0 12px 26px rgba(65,105,225,.18);
    }
    .shop-logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .shop-info{
      min-width:0;
      flex:1 1 auto;
    }
    .shop-name{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      color: var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .shop-count{
      margin-top:4px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
      white-space:nowrap;
      width: fit-content;
    }

    .items{
      padding: 10px 10px 12px 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .item{
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 16px;
      padding: 10px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 4px 10px;
      align-items:start;
      min-width:0;
      box-shadow: 0 8px 20px rgba(15,23,42,.05);
    }
    .iname{
      font-size: 12px;
      font-weight: 900;
      color:#0B1220;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .iprice{
      font-size: 12px;
      font-weight: 900;
      color: var(--royal-700);
      background: var(--royal-50);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
      text-align:right;
      flex:0 0 auto;
    }
    .imeta{
      grid-column: 1 / -1;
      font-size: 11px;
      font-weight: 800;
      color: #64748B;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .inote{
      grid-column: 1 / -1;
      font-size: 11px;
      font-weight: 700;
      color: #334155;
      word-break: break-word;
      line-height: 1.35;
    }

    .catalog-empty{
      padding: 14px;
      text-align:center;
      font-weight: 800;
      color: var(--muted);
      font-size: 12px;
      border-radius: var(--radius-xl);
      border: 1px dashed var(--line);
      background: rgba(255,255,255,.65);
    }

    /* Story modal (mantido, com leve polimento) */
    .story-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.96);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .story-modal.open{display:flex;}
    .story-frame{
      width:100%;
      height:100vh;
      max-width: 480px;
      background:#000;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .story-progress{
      position:absolute;
      left:0; right:0; top:0;
      display:flex;
      gap:4px;
      padding: 10px 10px 0 10px;
      z-index: 3;
    }
    .seg{ flex:1; height:3px; border-radius:999px; background:rgba(255,255,255,.22); overflow:hidden; }
    .fill{ width:0%; height:100%; background:#fff; }

    .story-head{
      z-index:2;
      padding: 18px 12px 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      color:#fff;
      min-width:0;
    }
    .s-dot{
      width: 34px; height: 34px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--royal), var(--royal-700));
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .s-title{
      min-width:0;
      flex:1;
    }
    .s-title h5{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .s-title span{ font-size: 11px; font-weight: 800; color: rgba(255,255,255,.70); }
    .s-close{
      border:0;
      cursor:pointer;
      width: 40px; height: 40px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      color:#fff;
      font-size: 22px;
      font-weight: 900;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }

    .story-body{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .story-body img,
    .story-body video{
      width:100%;
      height:100%;
      object-fit:contain;
      background:#000;
      display:block;
    }
    .touch{
      position:absolute; inset:0;
      display:flex;
      z-index:4;
    }
    .zone{ flex:1; }

    .story-caption{
      padding: 10px 12px 16px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,.45));
      display:flex;
      gap: 10px;
      align-items:flex-start;
      color:#fff;
    }
    .cap{
      flex:1;
      font-size: 12px;
      font-weight: 700;
      white-space: pre-line;
      min-height: 24px;
    }
    .like{
      min-width: 100px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 6px;
    }
    .likebtn{
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.70);
      background:transparent;
      color:#fff;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .likebtn.liked{
      background:#fff;
      color:#0B1220;
    }
    .likestats{
      font-size: 10px;
      font-weight: 800;
      color: rgba(255,255,255,.70);
      text-align:right;
    }
  </style>
</head>

<body>
  <div class="phone">

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="topbar-inner">
        <div class="avatar">
          <img src="{{ url_for('foto_cooperado', id=coop.id) }}" alt="foto do cooperado" onerror="this.style.visibility='hidden'">
        </div>

        <div class="who">
          <h1>Ol√°, {{ coop.nome }}</h1>
          <div class="sub">@{{ coop.username }}</div>
          <div class="pill-role">üõµ Cooperado Coopex</div>
        </div>

        <div class="actions-top">
          <!-- Bot√£o abre filtros (s√≥ aparece na aba In√≠cio via JS) -->
          <button class="iconbtn" id="openFiltersTop" type="button" title="Filtrar lan√ßamentos">‚è±Ô∏è</button>

          <a class="logoutbtn" href="{{ url_for('logout') }}">
            üö™ <span>Sair</span>
          </a>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="content">

      <!-- HOME -->
      <section id="home-section" class="page">
        <div class="stack">

          <!-- Stats -->
          <div class="stats">
            <div class="card stat">
              <div class="chip">üí≥</div>
              <p class="k">Cr√©dito dispon√≠vel</p>
              <p class="v ok">R$ {{ '%.2f'|format(coop.credito or 0) }}</p>
              {% if coop.credito_atualizado_em %}
                <p class="h">√öltimo ajuste: {{ coop.credito_atualizado_em.strftime('%d/%m/%Y %H:%M') }}</p>
              {% else %}
                <p class="h">Sem ajustes manuais.</p>
              {% endif %}
            </div>

            <div class="card stat">
              <div class="chip">üßæ</div>
              <p class="k">Lan√ßamentos</p>
              <p class="v">{{ total_lanc }}</p>
              <p class="h">J√° filtrados por data.</p>
            </div>
          </div>

          <!-- Stories -->
          <section class="card section" id="stories">
            <div class="section-head">
              <div>
                <h3 class="title">Stories</h3>
                <p class="subtitle">Promo√ß√µes e recados r√°pidos dos parceiros.</p>
              </div>
              <span class="badge">‚ö° Atualiza r√°pido</span>
            </div>

            {% if stories_ativos_coop and estab_por_id %}
              <div class="stories-row" aria-label="Stories de estabelecimentos">
                {% for est_id, est in estab_por_id.items() %}
                  {% set est_stories = stories_ativos_coop | selectattr('estabelecimento_id','equalto', est_id) | list %}
                  {% if est_stories %}
                    <button
                      type="button"
                      class="story"
                      data-est-id="{{ est_id }}"
                      data-est-nome="{{ est.nome }}"
                    >
                      <div class="ring">
                        <div class="inner">
                          {% if est.id %}
                            <img src="{{ url_for('logo_estabelecimento', id=est.id) }}" alt="{{ est.nome }}" onerror="this.style.display='none'">
                          {% endif %}
                          <span style="position:absolute;">{{ est.nome[:2].upper() }}</span>
                        </div>
                      </div>
                      <div class="story-name" title="{{ est.nome }}">{{ est.nome }}</div>
                      <div class="story-meta">{{ est_stories|length }} story{{ 'ies' if est_stories|length>1 else '' }}</div>
                    </button>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <div class="empty">Ainda n√£o h√° stories ativos dos estabelecimentos que lan√ßam em seu nome.</div>
            {% endif %}
          </section>

          <!-- Feed Lan√ßamentos -->
          <section class="card section" id="lancamentos">
            <div class="section-head">
              <div>
                <h3 class="title">Meus lan√ßamentos</h3>
                <p class="subtitle">Hor√°rio de Bras√≠lia (GMT-3).</p>
              </div>
              <span class="badge">‚è±Ô∏è Bras√≠lia</span>
            </div>

            {% if lancamentos %}
              <div class="feed" aria-label="Lan√ßamentos">
                {% for l in lancamentos %}
                  <div class="post">
                    <div class="post-top">
                      <div class="post-dot">üßæ</div>

                      <div class="post-head">
                        <p class="post-estab">{{ l.estabelecimento.nome if l.estabelecimento else '‚Äî' }}</p>
                        <p class="post-sub">
                          <span>OS: {{ l.os_numero or '‚Äî' }}</span>
                          <span>‚Ä¢</span>
                          <span>
                            {% if l.data_brasilia %}
                              {{ l.data_brasilia }}
                            {% else %}
                              {{ l.data.strftime('%d/%m/%Y %H:%M') }}
                            {% endif %}
                          </span>
                        </p>
                      </div>

                      <div class="post-price">R$ {{ '%.2f'|format(l.valor or 0) }}</div>
                    </div>

                    {% if l.descricao %}
                      <div class="post-desc">{{ l.descricao }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty">Nenhum lan√ßamento neste per√≠odo.</div>
            {% endif %}
          </section>

        </div>
      </section>

      <!-- CAT√ÅLOGOS -->
      <section id="catalogos-section" class="page page-hidden">
        <div class="stack">

          <section class="card section">
            <div class="section-head">
              <div>
                <h3 class="title">Cat√°logos</h3>
                <p class="subtitle">Pesquise itens pelo nome enquanto digita.</p>
              </div>
              <span class="badge">üìö Parceiros</span>
            </div>

            {% if catalogo_itens_coop and estab_por_id %}
              <div class="searchbar">
                <div class="searchbox">
                  <span class="sicon">üîé</span>
                  <input id="catalogSearch" type="search" inputmode="search" autocomplete="off"
                         placeholder="Digite o nome do item, marca, categoria ou parceiro..." />
                </div>
                <div class="searchmeta">
                  <div><span id="catalogCount">0</span> item(ns) exibido(s)</div>
                  <button type="button" class="clear" id="catalogClear">Limpar</button>
                </div>
              </div>

              <div class="catalog-list" id="catalogGrid">
                {% for est_id, est in estab_por_id.items() %}
                  {% set itens_est = catalogo_itens_coop | selectattr('estabelecimento_id','equalto', est_id) | list %}
                  {% if itens_est %}
                    <article class="shop catalog-card-js" data-estab="{{ est.nome }}">
                      <div class="shop-head">
                        <div class="shop-logo">
                          {% if est.id %}
                            <img src="{{ url_for('logo_estabelecimento', id=est.id) }}" alt="{{ est.nome }}" onerror="this.style.display='none'">
                          {% endif %}
                          <span style="position:absolute;font-size:12px;">{{ est.nome[:2].upper() }}</span>
                        </div>

                        <div class="shop-info">
                          <p class="shop-name" title="{{ est.nome }}">{{ est.nome }}</p>
                          <div class="shop-count">
                            <span class="catalog-pill-count">{{ itens_est|length }}</span> item{{ 's' if itens_est|length>1 else '' }}
                          </div>
                        </div>
                      </div>

                      <div class="items">
                        {% for item in itens_est %}
                          <div class="item catalog-item-js"
                               data-item="{{ item.nome }}"
                               data-estab="{{ est.nome }}"
                               data-marca="{{ item.marca or '' }}"
                               data-categoria="{{ item.categoria or '' }}"
                               data-obs="{{ item.observacao or '' }}">
                            <div class="iname" title="{{ item.nome }}">{{ item.nome }}</div>
                            <div class="iprice">R$ {{ '%.2f'|format(item.valor or 0) }}</div>

                            <div class="imeta">
                              {% if item.marca %}Marca: {{ item.marca }}{% endif %}
                              {% if item.categoria %}{{ ' ‚Ä¢ ' if item.marca }}Categoria: {{ item.categoria }}{% endif %}
                              {% if not item.marca and not item.categoria %}&nbsp;{% endif %}
                            </div>

                            {% if item.observacao %}
                              <div class="inote">{{ item.observacao }}</div>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </article>
                  {% endif %}
                {% endfor %}
              </div>

              <div class="catalog-empty" id="catalogEmptySearch" style="display:none;">
                Nenhum item encontrado com esse termo.
              </div>

            {% else %}
              <div class="catalog-empty">
                Nenhum cat√°logo dispon√≠vel ainda para os estabelecimentos que lan√ßam em seu nome.
              </div>
            {% endif %}
          </section>

        </div>
      </section>

    </main>

    <!-- FAB (filtros) -->
    <button class="fab" id="openFilters" title="Filtrar lan√ßamentos">‚è±Ô∏è</button>

    <!-- SHEET filtros -->
    <div class="sheet" id="sheet" aria-hidden="true">
      <div class="sheet-inner">
        <div class="sheet-drag" id="closeFilters"></div>
        <div class="sheet-head">
          <h4>Filtros dos lan√ßamentos</h4>
          <button type="button" class="sheet-close" id="cancelSheet">Fechar</button>
        </div>

        <form method="get" action="{{ url_for('painel_cooperado') }}">
          <div class="sheet-body">
            <div class="field">
              <label for="di">Data in√≠cio</label>
              <input id="di" type="date" name="data_inicio" value="{{ data_inicio }}">
            </div>
            <div class="field">
              <label for="df">Data fim</label>
              <input id="df" type="date" name="data_fim" value="{{ data_fim }}">
            </div>

            <div class="sheet-actions">
              <button type="submit" class="btn primary">Aplicar</button>

              {% if data_inicio or data_fim %}
                <a class="btn ghost" href="{{ url_for('painel_cooperado') }}">Limpar</a>
              {% else %}
                <button type="button" class="btn ghost" id="cancelSheet2">Fechar</button>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- STORY MODAL -->
    <div class="story-modal" id="storyModal">
      <div class="story-frame">
        <div class="story-progress" id="storyProgress"></div>

        <div class="story-head">
          <div class="s-dot" id="storyInitial">E</div>
          <div class="s-title">
            <h5 id="storyTitle">Estabelecimento</h5>
            <span id="storySub">Story</span>
          </div>
          <button class="s-close" id="closeStory" aria-label="Fechar story">√ó</button>
        </div>

        <div class="story-body">
          <img id="storyImg" src="" alt="story" style="display:none;">
          <video id="storyVideo" playsinline muted style="display:none;"></video>

          <div class="touch">
            <div class="zone" data-dir="prev"></div>
            <div class="zone" data-dir="next"></div>
          </div>
        </div>

        <div class="story-caption">
          <div class="cap" id="storyCaption"></div>
          <div class="like">
            <button id="storyLikeBtn" type="button" class="likebtn">üëç <span>TOP</span></button>
            <div id="storyLikeStats" class="likestats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav" aria-label="Navega√ß√£o">
      <div class="nav-inner">
        <button class="tab active" type="button" data-target="home-section">
          <span class="i">üè†</span> In√≠cio
        </button>
        <button class="tab" type="button" data-target="catalogos-section">
          <span class="i">üìö</span> Cat√°logos
        </button>
        <a class="tab" href="{{ url_for('logout') }}" style="text-decoration:none;">
          <span class="i">üö™</span> Sair
        </a>
      </div>
    </nav>

    <!-- STORIES MAP -->
    <script>
      window.COOP_STORIES = [
        {% for s in stories_ativos_coop %}
          {
            id: {{ s.id }},
            estId: {{ s.estabelecimento_id }},
            tipo: "{{ s.tipo }}",
            titulo: {{ (s.titulo or '')|tojson }},
            legenda: {{ (s.legenda or '')|tojson }},
            src: "{{ url_for('story_midia', story_id=s.id) }}"
          }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
    </script>

    <script>
      /* ==========================
         TAB NAV (In√≠cio/Cat√°logos)
         ========================== */
      const tabs = document.querySelectorAll('.bottom-nav .tab[data-target]');
      const pages = {
        'home-section': document.getElementById('home-section'),
        'catalogos-section': document.getElementById('catalogos-section')
      };
      const LAST_TAB_KEY = 'coopex_coop_tab';

      const fab = document.getElementById('openFilters');
      const topFilterBtn = document.getElementById('openFiltersTop');

      function setFilterButtons(target){
        const show = (target === 'home-section');
        if(fab) fab.style.display = show ? 'flex' : 'none';
        if(topFilterBtn) topFilterBtn.style.display = show ? 'flex' : 'none';
      }

      function activateTab(target){
        tabs.forEach(t => t.classList.remove('active'));
        const btn = document.querySelector('.bottom-nav .tab[data-target="'+target+'"]');
        if(btn) btn.classList.add('active');

        Object.keys(pages).forEach(id=>{
          const el = pages[id];
          if(!el) return;
          if(id === target){
            el.classList.remove('page-hidden');
            el.classList.add('fade-in');
            setTimeout(()=>el.classList.remove('fade-in'), 250);
          }else{
            el.classList.add('page-hidden');
          }
        });

        setFilterButtons(target);
        localStorage.setItem(LAST_TAB_KEY, target);

        if(target === 'catalogos-section'){
          const inp = document.getElementById('catalogSearch');
          if(inp) setTimeout(()=>inp.focus(), 80);
        }
      }

      tabs.forEach(tab=>{
        tab.addEventListener('click', ()=>{
          const target = tab.getAttribute('data-target');
          if(!target) return;
          activateTab(target);
        });
      });

      document.addEventListener('DOMContentLoaded', ()=>{
        const saved = localStorage.getItem(LAST_TAB_KEY);
        if(saved && pages[saved]) activateTab(saved);
        else activateTab('home-section');
      });

      /* ==========================
         SHEET FILTROS
         ========================== */
      const sheet = document.getElementById('sheet');
      const closeFilters = document.getElementById('closeFilters');
      const cancelSheet = document.getElementById('cancelSheet');
      const cancelSheet2 = document.getElementById('cancelSheet2');

      function openSheet(){
        if(!sheet) return;
        sheet.classList.add('open');
        sheet.setAttribute('aria-hidden','false');
      }
      function closeSheet(){
        if(!sheet) return;
        sheet.classList.remove('open');
        sheet.setAttribute('aria-hidden','true');
      }

      if(fab) fab.addEventListener('click', openSheet);
      if(topFilterBtn) topFilterBtn.addEventListener('click', openSheet);
      if(closeFilters) closeFilters.addEventListener('click', closeSheet);
      if(cancelSheet) cancelSheet.addEventListener('click', closeSheet);
      if(cancelSheet2) cancelSheet2.addEventListener('click', closeSheet);

      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeSheet();
      });

      /* ==========================
         PESQUISA DO CAT√ÅLOGO
         (filtra enquanto digita)
         ========================== */
      (function setupCatalogSearch(){
        const input = document.getElementById('catalogSearch');
        const clearBtn = document.getElementById('catalogClear');
        const countEl = document.getElementById('catalogCount');
        const emptyEl = document.getElementById('catalogEmptySearch');
        const grid = document.getElementById('catalogGrid');

        if(!grid || !input) return;

        const cards = Array.from(grid.querySelectorAll('.catalog-card-js'));
        const items = Array.from(grid.querySelectorAll('.catalog-item-js'));

        function norm(str){
          try{
            return (str||'')
              .toString()
              .toLowerCase()
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g,'');
          }catch(e){
            return (str||'').toString().toLowerCase();
          }
        }

        items.forEach(el=>{
          const key = [
            el.dataset.item || '',
            el.dataset.estab || '',
            el.dataset.marca || '',
            el.dataset.categoria || '',
            el.dataset.obs || ''
          ].join(' ');
          el.dataset.searchKey = norm(key);
        });

        function updateMeta(visible){
          if(countEl) countEl.textContent = String(visible);
          if(emptyEl) emptyEl.style.display = (visible === 0) ? 'block' : 'none';
        }

        function filter(q){
          const query = norm(q).trim();

          if(clearBtn) clearBtn.style.display = query ? 'inline-flex' : 'none';

          let visibleCount = 0;

          items.forEach(item=>{
            const match = !query || (item.dataset.searchKey || '').includes(query);
            item.style.display = match ? '' : 'none';
            if(match) visibleCount++;
          });

          cards.forEach(card=>{
            const cardItems = Array.from(card.querySelectorAll('.catalog-item-js'));
            const anyVisible = cardItems.some(ci => ci.style.display !== 'none');
            card.style.display = anyVisible ? '' : 'none';

            const pillCount = card.querySelector('.catalog-pill-count');
            if(pillCount){
              const vis = cardItems.filter(ci => ci.style.display !== 'none').length;
              pillCount.textContent = String(vis);
            }
          });

          updateMeta(visibleCount);
        }

        filter('');

        input.addEventListener('input', (e)=> filter(e.target.value));

        if(clearBtn){
          clearBtn.addEventListener('click', ()=>{
            input.value = '';
            filter('');
            input.focus();
          });
        }
      })();

      /* ==========================
         STORIES PLAYER
         ========================== */
      const storyModal   = document.getElementById('storyModal');
      const storyImg     = document.getElementById('storyImg');
      const storyVideo   = document.getElementById('storyVideo');
      const storyTitle   = document.getElementById('storyTitle');
      const storySub     = document.getElementById('storySub');
      const storyCaption = document.getElementById('storyCaption');
      const storyInitial = document.getElementById('storyInitial');
      const closeStory   = document.getElementById('closeStory');
      const progressWrap = document.getElementById('storyProgress');
      const storyLikeBtn = document.getElementById('storyLikeBtn');
      const storyLikeStats = document.getElementById('storyLikeStats');

      const STORY_DURATION = 5000;
      let currentEstName = '';
      let storyList = [];
      let currentIndex = 0;
      let timer = null;
      let isPaused = false;
      let progressFills = [];
      let currentStoryId = null;

      function buildProgressBar(count){
        progressWrap.innerHTML = '';
        progressFills = [];
        for(let i=0;i<count;i++){
          const seg = document.createElement('div');
          seg.className = 'seg';
          const fill = document.createElement('div');
          fill.className = 'fill';
          seg.appendChild(fill);
          progressWrap.appendChild(seg);
          progressFills.push(fill);
        }
      }
      function updateProgress(ratio=0){
        progressFills.forEach((fill, idx)=>{
          if(idx < currentIndex) fill.style.width = '100%';
          else if(idx === currentIndex) fill.style.width = (ratio*100)+'%';
          else fill.style.width = '0%';
        });
      }

      function updateLikeUI(liked, views, likes){
        if(typeof liked === 'boolean' && storyLikeBtn){
          storyLikeBtn.dataset.liked = liked ? '1' : '0';
          storyLikeBtn.classList.toggle('liked', liked);
        }
        if(storyLikeStats){
          const v = typeof views === 'number' ? views : 0;
          const l = typeof likes === 'number' ? likes : 0;
          storyLikeStats.textContent = v + ' visualiza√ß√µes ‚Ä¢ ' + l + ' TOP';
        }
      }

      function registrarView(likedValue){
        if(!currentStoryId) return;
        fetch("{{ url_for('registrar_story_view') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({story_id: currentStoryId, liked: likedValue})
        })
        .then(r=>r.json())
        .then(data=>{
          if(data && data.ok){
            updateLikeUI(data.liked, data.views, data.likes);
          }
        })
        .catch(()=>{});
      }

      function showStory(story){
        currentStoryId = story.id;
        storyTitle.textContent = currentEstName;
        storySub.textContent = story.titulo || 'Story';
        storyCaption.textContent = story.legenda || '';
        storyInitial.textContent = (currentEstName || 'E').slice(0,2).toUpperCase();

        storyImg.style.display = 'none';
        storyVideo.style.display = 'none';
        storyVideo.pause();
        storyVideo.removeAttribute('src');

        if(story.tipo === 'video'){
          storyVideo.style.display = 'block';
          storyVideo.src = story.src;
          storyVideo.load();
          storyVideo.play().catch(()=>{});
        }else{
          storyImg.style.display = 'block';
          storyImg.src = story.src;
        }

        updateProgress(0);
        updateLikeUI(null, 0, 0);
        registrarView(null);
      }

      function startTimer(){
        clearInterval(timer);
        let elapsed = 0;
        const step = 50;
        timer = setInterval(()=>{
          if(isPaused) return;
          elapsed += step;
          const ratio = Math.min(1, elapsed / STORY_DURATION);
          updateProgress(ratio);
          if(elapsed >= STORY_DURATION) nextStory();
        }, step);
      }

      function openStoryForEst(estId, estName){
        const all = window.COOP_STORIES || [];
        const list = all.filter(s => s.estId === estId);
        if(!list.length) return;

        currentEstName = estName || '';
        storyList = list;
        currentIndex = 0;

        buildProgressBar(storyList.length);
        showStory(storyList[currentIndex]);
        startTimer();

        storyModal.classList.add('open');
      }

      function closeStoryModal(){
        storyModal.classList.remove('open');
        clearInterval(timer);
        timer = null;
        storyVideo.pause();
        currentStoryId = null;
      }

      function nextStory(){
        if(currentIndex < storyList.length - 1){
          currentIndex++;
          showStory(storyList[currentIndex]);
          startTimer();
        }else{
          closeStoryModal();
        }
      }
      function prevStory(){
        if(currentIndex > 0){
          currentIndex--;
          showStory(storyList[currentIndex]);
          startTimer();
        }else{
          currentIndex = 0;
          showStory(storyList[currentIndex]);
          startTimer();
        }
      }

      document.querySelectorAll('.story').forEach(chip=>{
        chip.addEventListener('click', ()=>{
          const estId = Number(chip.getAttribute('data-est-id'));
          const estName = chip.getAttribute('data-est-nome') || '';
          openStoryForEst(estId, estName);
        });
      });

      if(closeStory){
        closeStory.addEventListener('click', closeStoryModal);
      }
      if(storyModal){
        storyModal.addEventListener('click',(e)=>{
          if(e.target === storyModal) closeStoryModal();
        });
      }
      document.addEventListener('keydown',(e)=>{
        if(e.key === 'Escape') closeStoryModal();
      });

      document.querySelectorAll('.zone').forEach(zone=>{
        let holdTimeout = null;
        let held = false;

        function startHold(){
          held = false;
          isPaused = false;
          holdTimeout = setTimeout(()=>{
            held = true;
            isPaused = true;
          }, 200);
        }
        function endHold(){
          clearTimeout(holdTimeout);
          if(held){
            isPaused = false;
            return;
          }
          const dir = zone.getAttribute('data-dir');
          if(dir === 'next') nextStory();
          else prevStory();
        }

        zone.addEventListener('mousedown', startHold);
        zone.addEventListener('touchstart', startHold, {passive:true});

        zone.addEventListener('mouseup', endHold);
        zone.addEventListener('mouseleave', endHold);
        zone.addEventListener('touchend', endHold);
        zone.addEventListener('touchcancel', endHold);
      });

      if(storyLikeBtn){
        storyLikeBtn.addEventListener('click', ()=>{
          if(!currentStoryId) return;
          const likedNow = storyLikeBtn.dataset.liked === '1' ? false : true;
          registrarView(likedNow);
        });
      }
    </script>

  </div>
</body>
</html>
